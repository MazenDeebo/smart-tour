/*! For license information please see core.ea2cfcfcfa26b1cfe4e5.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[9114],{27419:(t,e)=>{"use strict";var i=e.binary_mesh={};i.read=function(t,e){return t.readFields(i._readField,{chunk:[],quantized_chunk:[]},e)},i._readField=function(t,e,i){1===t?e.chunk.push(n.read(i,i.readVarint()+i.pos)):2===t&&e.quantized_chunk.push(l.read(i,i.readVarint()+i.pos))},i.write=function(t,e){if(t.chunk)for(var i=0;i<t.chunk.length;i++)e.writeMessage(1,n.write,t.chunk[i]);if(t.quantized_chunk)for(i=0;i<t.quantized_chunk.length;i++)e.writeMessage(2,l.write,t.quantized_chunk[i])};var s=e.vertices_simple={};s.read=function(t,e){return t.readFields(s._readField,{xyz:[],uv:[]},e)},s._readField=function(t,e,i){1===t?i.readPackedFloat(e.xyz):2===t&&i.readPackedFloat(e.uv)},s.write=function(t,e){t.xyz&&e.writePackedFloat(1,t.xyz),t.uv&&e.writePackedFloat(2,t.uv)};var o=e.faces_simple={};o.read=function(t,e){return t.readFields(o._readField,{faces:[]},e)},o._readField=function(t,e,i){1===t&&i.readPackedVarint(e.faces)},o.write=function(t,e){t.faces&&e.writePackedVarint(1,t.faces)};var n=e.chunk_simple={};n.read=function(t,e){return t.readFields(n._readField,{vertices:null,faces:null,chunk_name:"",material_name:""},e)},n._readField=function(t,e,i){1===t?e.vertices=s.read(i,i.readVarint()+i.pos):2===t?e.faces=o.read(i,i.readVarint()+i.pos):3===t?e.chunk_name=i.readString():4===t&&(e.material_name=i.readString())},n.write=function(t,e){t.vertices&&e.writeMessage(1,s.write,t.vertices),t.faces&&e.writeMessage(2,o.write,t.faces),t.chunk_name&&e.writeStringField(3,t.chunk_name),t.material_name&&e.writeStringField(4,t.material_name)};var r=e.vertices_quantized={};r.read=function(t,e){return t.readFields(r._readField,{quantization:0,translation:[],x:[],y:[],z:[]},e)},r._readField=function(t,e,i){1===t?e.quantization=i.readFloat():2===t?i.readPackedFloat(e.translation):3===t?i.readPackedSVarint(e.x):4===t?i.readPackedSVarint(e.y):5===t&&i.readPackedSVarint(e.z)},r.write=function(t,e){t.quantization&&e.writeFloatField(1,t.quantization),t.translation&&e.writePackedFloat(2,t.translation),t.x&&e.writePackedSVarint(3,t.x),t.y&&e.writePackedSVarint(4,t.y),t.z&&e.writePackedSVarint(5,t.z)};var a=e.uv_quantized={};a.read=function(t,e){return t.readFields(a._readField,{name:"",quantization:0,u:[],v:[]},e)},a._readField=function(t,e,i){1===t?e.name=i.readString():2===t?e.quantization=i.readFloat():3===t?i.readPackedSVarint(e.u):4===t&&i.readPackedSVarint(e.v)},a.write=function(t,e){t.name&&e.writeStringField(1,t.name),t.quantization&&e.writeFloatField(2,t.quantization),t.u&&e.writePackedSVarint(3,t.u),t.v&&e.writePackedSVarint(4,t.v)};var h=e.faces_compressed={};h.read=function(t,e){return t.readFields(h._readField,{faces:[]},e)},h._readField=function(t,e,i){1===t&&i.readPackedSVarint(e.faces)},h.write=function(t,e){t.faces&&e.writePackedSVarint(1,t.faces)};var l=e.chunk_quantized={};l.read=function(t,e){return t.readFields(l._readField,{chunk_name:"",material_name:"",vertices:null,uvs:[],faces:null},e)},l._readField=function(t,e,i){1===t?e.chunk_name=i.readString():2===t?e.material_name=i.readString():3===t?e.vertices=r.read(i,i.readVarint()+i.pos):4===t?e.uvs.push(a.read(i,i.readVarint()+i.pos)):5===t&&(e.faces=o.read(i,i.readVarint()+i.pos))},l.write=function(t,e){if(t.chunk_name&&e.writeStringField(1,t.chunk_name),t.material_name&&e.writeStringField(2,t.material_name),t.vertices&&e.writeMessage(3,r.write,t.vertices),t.uvs)for(var i=0;i<t.uvs.length;i++)e.writeMessage(4,a.write,t.uvs[i]);t.faces&&e.writeMessage(5,o.write,t.faces)}},15335:(t,e,i)=>{"use strict";t.exports=o;var s=i(251);function o(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}o.Varint=0,o.Fixed64=1,o.Bytes=2,o.Fixed32=5;var n=4294967296,r=1/n;function a(t){return t.type===o.Bytes?t.readVarint()+t.pos:t.pos+1}function h(t,e,i){return i?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function l(t,e,i){var s=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.ceil(Math.log(e)/(7*Math.LN2));i.realloc(s);for(var o=i.pos-1;o>=t;o--)i.buf[o+s]=i.buf[o]}function d(t,e){for(var i=0;i<t.length;i++)e.writeVarint(t[i])}function c(t,e){for(var i=0;i<t.length;i++)e.writeSVarint(t[i])}function u(t,e){for(var i=0;i<t.length;i++)e.writeFloat(t[i])}function m(t,e){for(var i=0;i<t.length;i++)e.writeDouble(t[i])}function p(t,e){for(var i=0;i<t.length;i++)e.writeBoolean(t[i])}function g(t,e){for(var i=0;i<t.length;i++)e.writeFixed32(t[i])}function f(t,e){for(var i=0;i<t.length;i++)e.writeSFixed32(t[i])}function w(t,e){for(var i=0;i<t.length;i++)e.writeFixed64(t[i])}function v(t,e){for(var i=0;i<t.length;i++)e.writeSFixed64(t[i])}function y(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function D(t,e,i){t[i]=e,t[i+1]=e>>>8,t[i+2]=e>>>16,t[i+3]=e>>>24}function b(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}o.prototype={destroy:function(){this.buf=null},readFields:function(t,e,i){for(i=i||this.length;this.pos<i;){var s=this.readVarint(),o=s>>3,n=this.pos;this.type=7&s,t(o,e,this),this.pos===n&&this.skip(s)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=y(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=b(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=y(this.buf,this.pos)+y(this.buf,this.pos+4)*n;return this.pos+=8,t},readSFixed64:function(){var t=y(this.buf,this.pos)+b(this.buf,this.pos+4)*n;return this.pos+=8,t},readFloat:function(){var t=s.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=s.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,i,s=this.buf;return e=127&(i=s[this.pos++]),i<128?e:(e|=(127&(i=s[this.pos++]))<<7,i<128?e:(e|=(127&(i=s[this.pos++]))<<14,i<128?e:(e|=(127&(i=s[this.pos++]))<<21,i<128?e:function(t,e,i){var s,o,n=i.buf;if(o=n[i.pos++],s=(112&o)>>4,o<128)return h(t,s,e);if(o=n[i.pos++],s|=(127&o)<<3,o<128)return h(t,s,e);if(o=n[i.pos++],s|=(127&o)<<10,o<128)return h(t,s,e);if(o=n[i.pos++],s|=(127&o)<<17,o<128)return h(t,s,e);if(o=n[i.pos++],s|=(127&o)<<24,o<128)return h(t,s,e);if(o=n[i.pos++],s|=(1&o)<<31,o<128)return h(t,s,e);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(i=s[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=function(t,e,i){var s="",o=e;for(;o<i;){var n,r,a,h=t[o],l=null,d=h>239?4:h>223?3:h>191?2:1;if(o+d>i)break;1===d?h<128&&(l=h):2===d?128==(192&(n=t[o+1]))&&(l=(31&h)<<6|63&n)<=127&&(l=null):3===d?(n=t[o+1],r=t[o+2],128==(192&n)&&128==(192&r)&&((l=(15&h)<<12|(63&n)<<6|63&r)<=2047||l>=55296&&l<=57343)&&(l=null)):4===d&&(n=t[o+1],r=t[o+2],a=t[o+3],128==(192&n)&&128==(192&r)&&128==(192&a)&&((l=(15&h)<<18|(63&n)<<12|(63&r)<<6|63&a)<=65535||l>=1114112)&&(l=null)),null===l?(l=65533,d=1):l>65535&&(l-=65536,s+=String.fromCharCode(l>>>10&1023|55296),l=56320|1023&l),s+=String.fromCharCode(l),o+=d}return s}(this.buf,this.pos,t);return this.pos=t,e},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){var i=a(this);for(t=t||[];this.pos<i;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){var e=a(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){var e=a(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){var e=a(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){var e=a(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){var e=a(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){var e=a(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){var e=a(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){var e=a(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===o.Varint)for(;this.buf[this.pos++]>127;);else if(e===o.Bytes)this.pos=this.readVarint()+this.pos;else if(e===o.Fixed32)this.pos+=4;else{if(e!==o.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),D(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),D(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),D(this.buf,-1&t,this.pos),D(this.buf,Math.floor(t*r),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),D(this.buf,-1&t,this.pos),D(this.buf,Math.floor(t*r),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,e){var i,s;t>=0?(i=t%4294967296|0,s=t/4294967296|0):(s=~(-t/4294967296),4294967295^(i=~(-t%4294967296))?i=i+1|0:(i=0,s=s+1|0));if(t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),function(t,e,i){i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos]=127&t}(i,0,e),function(t,e){var i=(7&t)<<4;if(e.buf[e.pos++]|=i|((t>>>=3)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;e.buf[e.pos++]=127&t}(s,e)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(t,e,i){for(var s,o,n=0;n<e.length;n++){if((s=e.charCodeAt(n))>55295&&s<57344){if(!o){s>56319||n+1===e.length?(t[i++]=239,t[i++]=191,t[i++]=189):o=s;continue}if(s<56320){t[i++]=239,t[i++]=191,t[i++]=189,o=s;continue}s=o-55296<<10|s-56320|65536,o=null}else o&&(t[i++]=239,t[i++]=191,t[i++]=189,o=null);s<128?t[i++]=s:(s<2048?t[i++]=s>>6|192:(s<65536?t[i++]=s>>12|224:(t[i++]=s>>18|240,t[i++]=s>>12&63|128),t[i++]=s>>6&63|128),t[i++]=63&s|128)}return i}(this.buf,t,this.pos);var i=this.pos-e;i>=128&&l(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i},writeFloat:function(t){this.realloc(4),s.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),s.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var i=0;i<e;i++)this.buf[this.pos++]=t[i]},writeRawMessage:function(t,e){this.pos++;var i=this.pos;t(e,this);var s=this.pos-i;s>=128&&l(i,s,this),this.pos=i-1,this.writeVarint(s),this.pos+=s},writeMessage:function(t,e,i){this.writeTag(t,o.Bytes),this.writeRawMessage(e,i)},writePackedVarint:function(t,e){this.writeMessage(t,d,e)},writePackedSVarint:function(t,e){this.writeMessage(t,c,e)},writePackedBoolean:function(t,e){this.writeMessage(t,p,e)},writePackedFloat:function(t,e){this.writeMessage(t,u,e)},writePackedDouble:function(t,e){this.writeMessage(t,m,e)},writePackedFixed32:function(t,e){this.writeMessage(t,g,e)},writePackedSFixed32:function(t,e){this.writeMessage(t,f,e)},writePackedFixed64:function(t,e){this.writeMessage(t,w,e)},writePackedSFixed64:function(t,e){this.writeMessage(t,v,e)},writeBytesField:function(t,e){this.writeTag(t,o.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,o.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,o.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,o.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,o.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,o.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,o.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,o.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,o.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,o.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e))}}},29228:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>T});var s=i(75578),o=i(71687),n=i(27947),r=i(12837),a=i(99583),h=i(28454),l=i(72354),d=i(34184),c=i(47004),u=i(40899),m=i(22937),p=i(98309),g=i(1197),f=i(44351),w=i(596),v=i(90572),y=i(85227),D=i(2993),b=i(90834),M=i(10843);class S extends s.n{constructor(){super(...arguments),this.name="mesh-quality",this.measurementModeData=null,this.updateMaxQuality=(()=>{let t,e,i;return({modeChange:s,criticalChange:o,interactionChange:n})=>{var r,a,h;void 0!==o&&(e=o),void 0!==s&&(t=s),void 0!==n&&(i=n);const l=i===f.o.VrOrientOnly||i===f.o.VrWithController||i===f.o.VrTransientPointer||i===f.o.VrWithTrackedController,d=this.modelMeshModule.stats(),c=d.textureCount<=this.config.textureLODThreshold?Math.max(w.M.ULTRA,this.config.maxQuality):w.M.MEDIUM,u=null!==(h=null===(a=null===(r=this.modelMeshModule.getMeshGroupVisuals())||void 0===r?void 0:r.meshTextureOpacity)||void 0===a?void 0:a.value)&&void 0!==h?h:0,m=Math.max(c,t===D.N3.Panorama&&0===u?c:this.config.maxQuality);this.modelMeshModule.setTextureLimits(c,m);const p=this.viewmodeData.currentMode!==D.N3.Mesh&&this.viewmodeData.currentMode!==D.N3.Dollhouse&&this.viewmodeData.currentMode!==D.N3.Floorplan,g=this.viewmodeData.transition.active&&(0,D.nI)(this.viewmodeData.transition.to);l||g||(d.streaming||e)&&p?this.modelMeshModule.setTextureStreamMode(v.R.NONE):this.modelMeshModule.setTextureStreamMode(this.config.textureLOD)}})()}async init(t,e){this.config=t,this.engine=e,[this.modelMeshModule,this.viewmodeData,this.sweepData,this.appData,this.interactionModeData]=await Promise.all([e.getModuleBySymbol(o.GR),e.market.waitForData(a.X),e.market.waitForData(r.A),e.market.waitForData(n.zH),e.market.waitForData(b.O)]),await this.modelMeshModule.firstMeshLoadPromise,this.bindAppEventsToTextureQuality(),this.bindAppEventsToTextureVisibility(),this.updateMaxQuality({}),this.showcaseMeshDetailRules()}bindAppEventsToTextureQuality(){var t;let e=0;const i=null===(t=this.modelMeshModule.getMeshGroupVisuals())||void 0===t?void 0:t.meshTextureOpacity;i&&this.bindings.push(i.onChanged((()=>{i.value!==e&&this.updateMaxQuality({}),e=i.value}))),this.bindings.push(this.appData.onPhase((()=>{this.updateMaxQuality({})})),this.engine.subscribe(p.A,(t=>{this.updateMaxQuality({criticalChange:!0,modeChange:t.toMode})})),this.engine.subscribe(g.A,(t=>{this.updateMaxQuality({criticalChange:!1,modeChange:t.toMode})})),this.engine.subscribe(m.zM,(()=>{this.updateMaxQuality({criticalChange:!0})})),this.engine.subscribe(m.pT,(()=>{this.updateMaxQuality({criticalChange:!1})})),this.engine.subscribe(d.A,(()=>{this.updateMaxQuality({criticalChange:!0})})),this.engine.subscribe(c.A,(()=>{this.updateMaxQuality({criticalChange:!1})})),this.engine.subscribe(l.b,(t=>{this.updateMaxQuality({interactionChange:t.mode})})))}showcaseMeshDetailRules(){var t,e;const{modelMeshModule:i}=this,s=M.Ay.for(this),o=()=>this.appData.phase<=this.appData.phases.LOADING,n=()=>this.appData.phase===this.appData.phases.STARTING,r=()=>this.appData.phase>=this.appData.phases.PLAYING&&this.appData.phase!==this.appData.phases.ERROR,a=()=>this.appData.phase===this.appData.phases.ERROR,l=t=>this.viewmodeData.closestMode===t,d=()=>l(D.N3.Dollhouse)||l(D.N3.Floorplan)||l(D.N3.Mesh),c=()=>l(D.N3.Panorama),u=()=>this.viewmodeData.transition.active,m=t=>u()&&this.viewmodeData.transition.to===t,p=()=>{var t,e;return null!==(e=null===(t=this.measurementModeData)||void 0===t?void 0:t.isEditingOrCreating())&&void 0!==e&&e},g=()=>this.interactionModeData.isVR()&&!d(),f=()=>void 0!==this.sweepData.currentAlignedSweepObject;function w(){const t=i.getMeshDetail();let e=t;r()?u()?(m(D.N3.Dollhouse)||m(D.N3.Floorplan)||m(D.N3.Mesh))&&(e="max"):(e="default",c()&&g()&&(e="minimal"),c()&&!f()&&(e="minimal"),c()&&p()&&(e="max"),d()&&(e="max")):(o()&&(e="minimal"),a()&&(e="minimal"),n()&&(e="default")),t!==e&&(s.debug(`overrideMaxDetail from ${t} to ${e}`),i.setMeshOptions({overrideMaxDetail:e}))}const v=null===(e=null===(t=this.modelMeshModule.getMeshGroupVisuals())||void 0===t?void 0:t.meshTextureOpacity)||void 0===e?void 0:e.onComplete(w);v&&this.bindings.push(v),this.bindings.push(this.appData.onPhase(w),this.viewmodeData.onChanged(w),this.interactionModeData.onChanged(w)),this.engine.market.waitForData(h.s).then((t=>{this.bindings.push(t.onPhaseChanged(w)),this.measurementModeData=t})),w()}bindAppEventsToTextureVisibility(){this.bindings.push(this.engine.subscribe(u.A,(t=>{const e=this.sweepData.isSweepUnaligned(t.toSweep);e!==this.sweepData.isSweepUnaligned(t.fromSweep)&&this.modelMeshModule.setRenderMode(e?y.p.PanoramaCube:y.p.PanoramaMesh)})))}}const T=S},13070:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>g});var s=i(71687),o=i(60043),n=i(71397),r=i(46793),a=i(75578),h=i(28337),l=i(99583),d=i(2993),c=i(59758),u=i(47299),m=i(20599),p=i(10843);class g extends a.n{constructor(){super(...arguments),this.name="showcase-hotkeys",this.inputCommandMap={[h.$.PRESSED]:{[n.D.ONE]:()=>(this.viewmodeData.currentMode===d.N3.Panorama&&(this.settings.setSetting(u._Z,!1),this.currentView=0),this.switchToMode(r.w5.INSIDE)),[n.D.TWO]:()=>this.switchToMode(r.w5.DOLLHOUSE),[n.D.THREE]:()=>this.switchToMode(r.w5.FLOORPLAN),[n.D.ZERO]:()=>{const t=this.currentView++%this.meshViews.length;return this.meshViews[t]()},[n.D.FOUR]:()=>this.layersModule.toggleDefurnishView()}},this.currentView=0,this.meshViews=[()=>(this.settings.setSetting(u._Z,!1),this.switchToMode(r.w5.MESH)),()=>(this.settings.setSetting(u._Z,!0),this.switchToMode(r.w5.MESH)),()=>(this.settings.setSetting(u._Z,!0),this.switchToMode(r.w5.INSIDE)),()=>(this.settings.setSetting(u._Z,!1),this.switchToMode(r.w5.INSIDE))]}async init(t,e){this.layersModule=await e.getModuleBySymbol(s.az);const i=await e.getModuleBySymbol(s.mL);[this.viewmodeData,this.settings,this.cameraData]=await Promise.all([e.market.waitForData(l.X),e.market.waitForData(c.o),e.market.waitForData(m.M)]),this.issueCommand=e.commandBinder.issueCommand.bind(e.commandBinder);let n=null;i.registerHandler(o.k,(async t=>{!n&&this.inputCommandMap[t.state]&&this.inputCommandMap[t.state][t.key]&&(n=this.inputCommandMap[t.state][t.key](),await n,n=null)}))}async switchToMode(t){const{currentMode:e}=this.viewmodeData;if(e!==d.N3.Transition){const i=(0,d.nI)(e)&&(t===r.w5.MESH||t===r.w5.INSIDE)?this.cameraData.pose.rotation:void 0;try{await this.issueCommand(new r.S2(t,void 0,{rotation:i}))}catch(t){p.Ay.for(this).debug("Unable to switchToMode",t)}}}}},9120:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>I});var s=i(75578),o=i(90082),n=i(2391),r=i(45395),a=i(15404),h=i(71687),l=i(56208),d=i(88664),c=i(13893),u=i(81530),m=i(41122),p=i(47737),g=i(20968),f=i(10843),w=i(71271),v=i(23339),y=i(1333),D=i(5601),b=i(74381),M=i(15506);const S=new f.Ay("mds-player-options-deserializer"),T={[b.zf.BLACK]:D.v.black,[b.zf.GREY]:D.v.grey,[b.zf.WHITE]:D.v.white};class x{deserialize(t){var e,i;if(!t||!this.validate(t))return S.debug("Deserialized invalid options data from MDS",t),null;const s=(null===(e=t.publication)||void 0===e?void 0:e.options)||{},o=t.options||{},n=(null==o?void 0:o.tourPanDirection)?M.nl[o.tourPanDirection]:y.ND.Auto,r={defurnish_view:o.defurnishViewEnabled,address:s.address,contact_email:s.contactEmail,contact_name:s.contactName,contact_phone:s.contactPhone,dollhouse:o.dollhouseEnabled,external_url:s.externalUrl,floor_plan:o.floorplanEnabled,floor_select:o.floorSelectEnabled,highlight_reel:o.highlightReelEnabled,labels:o.labelsEnabled,labels_dh:o.dollhouseLabelsEnabled,model_name:s.modelName,model_summary:s.modelSummary,presented_by:s.presentedBy,measurements:o.measurements!==b.jG.DISABLED,measurements_saved:o.measurements===b.jG.MEASUREANDVIEW,room_bounds:o.roomBoundsEnabled,unit_type:o.unitType===b.WU.IMPERIAL?v.t.IMPERIAL:v.t.METRIC,background_color:(null==o?void 0:o.backgroundColor)?T[o.backgroundColor]:D.v.black,tour_buttons:o.tourButtonsEnabled,fast_transitions:o.tourFastTransitionsEnabled,transition_speed:o.tourTransitionSpeed,transition_time:o.tourTransitionTime,pan_speed:o.tourPanSpeed,dollhouse_pan_speed:o.tourDollhousePanSpeed,zoom_duration:o.tourZoomDuration,pan_alignment:M.j7[null!==(i=o.tourPanAlignment)&&void 0!==i?i:d.K6],pan_angle:o.tourPanAngle,pan_direction:n,space_search:o.spaceSearchEnabled};return new l.EY(r)}validate(t){if(!t)return!1;return["id","options","publication"].every((e=>e in t))}}const P=(0,i(70516).h)(T);class C{serialize(t){const e={},i=t.options||{};if(void 0!==i.defurnish_view&&(e.defurnishViewOverride=i.defurnish_view?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.dollhouse&&(e.dollhouseOverride=i.dollhouse?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.floor_plan&&(e.floorplanOverride=i.floor_plan?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.floor_select&&(e.floorSelectOverride=i.floor_select?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.room_bounds&&(e.roomBoundsOverride=i.room_bounds?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.space_search&&(e.spaceSearchOverride=i.space_search?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.labels&&(e.labelsOverride=i.labels?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.labels_dh&&(e.dollhouseLabelsOverride=i.labels_dh?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.highlight_reel&&(e.highlightReelOverride=i.highlight_reel?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.background_color&&(e.backgroundColor={set:P[i.background_color]||b.zf.BLACK}),void 0!==i.unit_type){const t=i.unit_type===v.t.METRIC?b.WU.METRIC:b.WU.IMPERIAL;e.unitType={set:t}}if(void 0!==i.measurements||void 0!==i.measurements_saved){const t=i.measurements&&i.measurements_saved?b.jG.MEASUREANDVIEW:i.measurements?b.jG.MEASURE:b.jG.DISABLED;e.measurements={set:t}}void 0!==i.tour_buttons&&(e.tourButtonsOverride=i.tour_buttons?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.fast_transitions&&(e.tourFastTransitionsOverride=i.fast_transitions?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.pan_alignment&&(e.tourPanAlignment={set:M.np[i.pan_alignment]}),void 0!==i.pan_angle&&(e.tourPanAngle={set:i.pan_angle}),void 0!==i.pan_direction&&(e.tourPanDirection={set:M.vr[i.pan_direction]}),void 0!==i.pan_speed&&(e.tourPanSpeed={set:i.pan_speed}),void 0!==i.transition_speed&&(e.tourTransitionSpeed={set:i.transition_speed}),void 0!==i.transition_time&&(e.tourTransitionTime={set:i.transition_time}),void 0!==i.zoom_duration&&(e.tourZoomDuration={set:i.zoom_duration}),void 0!==i.dollhouse_pan_speed&&(e.tourDollhousePanSpeed={set:i.dollhouse_pan_speed});const s={};void 0!==i.presented_by&&(s.presentedByOverride=i.presented_by?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.contact_email&&(s.contactEmailOverride=i.contact_email?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.contact_name&&(s.contactNameOverride=i.contact_name?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.contact_phone&&(s.contactPhoneOverride=i.contact_phone?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.external_url&&(s.externalUrlOverride=i.external_url?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.model_name&&(s.modelNameOverride=i.model_name?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.model_summary&&(s.modelSummaryOverride=i.model_summary?b.D6.ENABLED:b.D6.DISABLED),void 0!==i.address&&(s.addressOverride=i.address?b.D6.ENABLED:b.D6.DISABLED);return{options:e,publication:Object.keys(s).length>0?{options:s}:void 0}}}const B=new f.Ay("mds-player-options-store");class F extends g.g{constructor(){super(...arguments),this.serializer=new C,this.deserializer=new x,this.prefetchKey="data.model.publication.options"}async read(t={}){var e,i;const s={modelId:this.getBaseViewId()},o=await this.query(w.GetModelDetails,s,t);let n=this.deserializer.deserialize(null===(e=null==o?void 0:o.data)||void 0===e?void 0:e.model);if(!n){const e={modelId:this.getViewId(),viewLookup:"self"},o=Object.assign(Object.assign({},t),{fetchPolicy:"no-cache"});B.warn("Failed to read model options for model from view:root, some options/details may be stale",s,"retry with",e);const r=await this.query(w.GetModelDetails,e,o);n=this.deserializer.deserialize(null===(i=null==r?void 0:r.data)||void 0===i?void 0:i.model)}return n||B.error("Failed to read model options, using default options"),n}async update(t){const e=this.getBaseViewId(),i=this.serializer.serialize(t);if(0===Object.keys(i).length)throw new Error("No data to update?");return this.mutate(w.PatchModel,{modelId:e,patch:i}).then((t=>{B.debug(t)}))}}var O,A=i(3066);function k(t,e){const i=window!==window.parent,s=i=>{var s;(null===(s=i.data)||void 0===s?void 0:s.action)===t&&e(i)};return(0,A.Sh)((()=>{i&&window.addEventListener("message",s)}),(()=>{i&&window.removeEventListener("message",s)}),!0)}!function(t){t.ShowcaseOptionsChanged="showcase-options-changed",t.PluginConfigChanged="plugin-config-changed"}(O||(O={}));class I extends s.n{constructor(){super(...arguments),this.name="showcase-settings",this.data=new l.EY,this.updateTransitionType=(t,e)=>{const i=t.options.fast_transitions?c.fl.FadeToBlack:c.fl.Interpolate;e.settingsData.hasSetting(d.zk)?e.settingsData.setSetting(d.zk,i):e.registerSetting("player_options",d.zk,i)}}async init(t,e){const{readonly:i,baseUrl:s}=t,d=f.Ay.for(this);this.engine=e;const c=await e.market.waitForData(p.P);this.store=new F({baseUrl:s,context:c.mdsContext,readonly:i}),this.data.copy(await this.store.read()),e.market.register(l.EY,this.data),this.bindings.push(k(O.ShowcaseOptionsChanged,(()=>this.refresh())),k(O.PluginConfigChanged,(()=>this.resetPlugins())));const m=await e.getModuleBySymbol(o.ZF);for(const t in l.Q$){const e=l.Q$[t],i=this.data.options[e];if(m.hasSetting(e)){const t=m.getSetting(e);m.updateSetting(e,i&&t),d.debug(`Updated player_options setting ${e} = ${i&&t}`)}else m.registerSetting("player_options",e,i),d.debug(`Registered player_options setting ${e} = ${i}`);this.bindings.push(this.data.options.onPropertyChanged(e,(t=>{d.debugInfo("PlayerOption changed",{key:e,previousValue:m.getSetting(e),newValue:this.data.options[e]}),m.updateSetting(e,t)})))}if(this.updateTransitionType(this.data,m),this.bindings.push(m.settingsData.onSettingChanged(l.Q$.InstantTransitions,(()=>this.updateTransitionType(this.data,m)))),!i){const[t]=await Promise.all([e.getModuleBySymbol(h.T9)]);this.bindings.push(t.onSave((()=>this.save()),{dataType:a.p.SETTINGS})),this.monitor=new n.V(this.data,{aggregationType:r.D.NextFrame},this.engine),this.monitor.onChanged((()=>this.engine.commandBinder.issueCommand(new u.F({dataTypes:[a.p.SETTINGS]}))))}}async refresh(){const t=await this.store.read({fetchPolicy:"no-cache"});t&&this.data.copy(t)}async resetPlugins(){const t=new m.ho([],!0);await this.engine.commandBinder.issueCommand(t)}async save(){if(!this.store||!this.monitor)return void f.Ay.for(this).warn("Settings changes will NOT be saved");const t=this.monitor.getDiffRecord(),e=t.options;return e&&(e&&void 0===e.measurements&&void 0!==e.measurements_saved&&(e.measurements=this.data.options.measurements),e&&void 0!==e.measurements&&void 0===e.measurements_saved&&(e.measurements_saved=this.data.options.measurements_saved),void 0!==(null==e?void 0:e.floor_select)&&(e.floor_select=this.data.options.floor_select),void 0!==(null==e?void 0:e.labels_dh)&&(e.labels_dh=this.data.options.labels_dh),void 0===e.presented_by&&void 0===e.contact_email&&void 0===e.contact_name&&void 0===e.contact_phone&&void 0===e.external_url&&void 0===e.model_name&&void 0===e.model_summary&&void 0===e.address||(e.presented_by=this.data.options.presented_by,e.contact_email=this.data.options.contact_email,e.contact_name=this.data.options.contact_name,e.contact_phone=this.data.options.contact_phone,e.external_url=this.data.options.external_url,e.model_name=this.data.options.model_name,e.model_summary=this.data.options.model_summary,e.address=this.data.options.address)),this.monitor.clearDiffRecord(),this.store.update(t)}}},6025:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>P});var s=i(68909),o=i(75578),n=i(71687),r=i(12837),a=i(2993),h=i(15930),l=i(15580),d=i(26482),c=i(13893),u=i(50018),m=i(42120),p=i(59758),g=i(38939),f=i(86866),w=i(31093),v=i(23272),y=i(50178),D=i(44455),b=i(78115),M=i(27947),S=i(88090),T=i(56208),x=i(10843);class P extends o.n{constructor(){super(...arguments),this.name="showcase-start",this.firstRenderPromise=new w.i,this.flyInPromise=new w.i,this.handleFlyIn=async(t,e,i)=>{this.renderer.startRender(!1);try{await this.doStandardStart(t,e,i,!0)}catch(t){x.Ay.for(this).error(t),this.renderer.startRender(!0)}}}async init(t,e){const[i,s,o,a]=await Promise.all([e.market.waitForData(p.o),e.market.waitForData(d.G),e.market.waitForData(T.EY),e.getModuleBySymbol(n.Qm),e.getModuleBySymbol(n.yT)]);if([this.sweepData,this.sweepModule,this.cameraModule,this.renderer,this.appData]=await Promise.all([e.market.waitForData(r.A),e.getModuleBySymbol(n.Wh),e.getModuleBySymbol(n.jh),e.getModuleBySymbol(n.M7),e.market.waitForData(M.zH)]),this.bindings.push(e.commandBinder.addBinding(g.c,(async t=>{this.handleFlyIn(t.pose||s.getStartingPose(),e,i)})),e.commandBinder.addBinding(g.W,(async t=>{this.fadeToStartLocation(s,e)})),e.subscribe(b.tj,(async()=>{this.appData.application!==M.lg.WORKSHOP&&s.moveCameraOnViewChange&&this.fadeToStartLocation(s,e)}))),a.viewportManager.viewports.length>1)return this.firstRenderPromise.resolve(),this.flyInPromise.resolve(),this.waitForFirstRender;const h=i.tryGetSetting("quickstart",!1),l=this.getStartingPose(s,o);return(h?this.doQuickStart(l,e,c.fl.Instant):this.doStandardStart(l,e,i,!1)).catch((t=>{x.Ay.for(this).error("Handling error during initial fly-in, attempting recover",{startingPose:l,error:t}),this.doQuickStart(l,e,c.fl.FadeToBlack),this.renderBeforeStarting(e)})).finally((()=>this.flyInPromise.resolve())),this.waitForFirstRender}getStartingPose(t,e){const i=t.getStartingPose(),s=!e.options.dollhouse,o=!e.options.floor_plan;return s&&i.mode===a.N3.Dollhouse||o&&i.mode===a.N3.Floorplan?new d.n:i}fadeToStartLocation(t,e){const i=t.getStartingPose();this.doQuickStart(i,e,c.fl.FadeToBlack)}get waitForFirstRender(){return this.firstRenderPromise.nativePromise()}get waitForFlyin(){return this.flyInPromise.nativePromise()}async doQuickStart(t,e,i){const s=this.sweepData.getStartSweep(t),o=s&&s.id,r=await e.getModuleBySymbol(n.SD);return await r.switchToMode(t.mode,i,{sweepID:o,position:t.camera.position||s&&s.position,rotation:t.camera.rotation,zoom:-1!==t.camera.zoom?t.camera.zoom:void 0}),e.broadcast(new y.c7(!1)),t.mode!==a.N3.Dollhouse&&t.mode!==a.N3.Floorplan||t.floorVisibility&&await e.commandBinder.issueCommandWhenBound(new v.q8(t.floorVisibility.lastIndexOf(1),!0,0)),this.renderBeforeStarting(e)}async doStandardStart(t,e,i,o){var r;const[d]=await Promise.all([e.getModuleBySymbol(n.SD)]);await e.getModuleBySymbol(S.K4);const u=!i.tryGetSetting(l.n9,!1),p=!i.tryGetSetting(l._z,!1);t&&(t.mode===a.N3.Dollhouse&&u||t.mode===a.N3.Floorplan&&p||t.mode===a.N3.Panorama&&!t.pano)&&(t=null);const g=!t||t&&(t.mode===a.N3.Dollhouse||t.mode===a.N3.Floorplan),w=!t||t&&!this.is360Pano(t)&&(0,a.nI)(t.mode)&&!u,b=t?t.mode:a.N3.Panorama,M=this.sweepData.getStartSweep(t),T=M&&M.id,x=this.sweepData.getFirstSweep();let P=x&&x.rotation;if((null===(r=null==t?void 0:t.camera)||void 0===r?void 0:r.rotation)&&!(0,D.PH)(t.camera.rotation)&&(P=t.camera.rotation),P&&b!==a.N3.Floorplan&&(P=(0,f.V5)(P)),await(await e.getModuleBySymbol(n.GR)).firstMeshLoadPromise,w){const i=await d.getFlyinEndPose({sweepID:T,position:t?t.camera.position:void 0,rotation:P}),n=d.getFlyinStartPose(i,o?new s.Vector3(0,0,0):void 0);e.broadcast(new y.c7(!0));const r=T?this.sweepModule.activateSweepUnsafe({sweepId:T}):Promise.resolve();await d.switchToMode(a.N3.Dollhouse,c.fl.Instant,n),await this.renderBeforeStarting(e),await(0,m.c)(750),await this.cameraModule.moveTo({transitionType:c.fl.Interpolate,pose:i}).nativePromise(),await r,e.broadcast(new y.c7(!1)),await d.switchToMode(b,c.fl.Interpolate,{sweepID:T,rotation:P},h.Ou)}else await d.switchToMode(b,c.fl.Instant,{sweepID:T,position:t?t.camera.position:void 0,rotation:P,zoom:t&&-1!==t.camera.zoom?t.camera.zoom:void 0}),g&&t&&(t.floorVisibility?await e.commandBinder.issueCommandWhenBound(new v.q8(t.floorVisibility.lastIndexOf(1),!0,0)):await e.commandBinder.issueCommandWhenBound(new v.i1(null))),await this.renderBeforeStarting(e)}is360Pano(t){if(t.pano.uuid){const e=this.sweepData.getSweep(t.pano.uuid);if(e)return e.alignmentType!==u.c$.ALIGNED}else{const t=this.sweepData.getFirstSweep();if(void 0!==t)return t.alignmentType!==u.c$.ALIGNED}return!1}async renderBeforeStarting(t){await this.renderer.renderOnce(),await t.getModuleBySymbol(S.XT),this.renderer.startRender(!0),this.firstRenderPromise.resolve()}}},97573:(t,e,i)=>{"use strict";i.d(e,{EH:()=>o,v6:()=>n});var s=i(76924);const o=(t=200)=>[{property:s.ResizeProperty.width,setDimension:t=>t.width,duration:t},{property:s.ResizeProperty.height,setDimension:t=>t.height,duration:t},{property:s.ResizeProperty.top,setDimension:()=>0,duration:t},{property:s.ResizeProperty.left,setDimension:()=>0,duration:t}],n=(t,e,i,o=200)=>{const n=[];return void 0!==t&&n.push({property:s.ResizeProperty.width,setDimension:e=>e.width+t,duration:o}),void 0!==e&&n.push({property:s.ResizeProperty.height,setDimension:t=>t.height+e,duration:o}),void 0!==i&&n.push({property:s.ResizeProperty.left,setDimension:()=>i,duration:o}),n}},79109:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>r});var s=i(75578),o=i(99583),n=i(71687);class r extends s.n{constructor(){super(...arguments),this.name="common-controls",this.modeControls=new Map,this.poseController=null}async init(t,e){this.modeControls=new Map,e.market.waitForData(o.X).then((t=>{this.viewmodeData=t,this.bindings.push(this.viewmodeData.onChanged((()=>this.setControllerForCurrViewmode()))),this.setControllerForCurrViewmode()})),this.cameraPoseProxy=(await e.getModuleBySymbol(n.jh)).cameraPoseProxy,this.cameraPoseProxy.newSession(this)}onAccessGranted(t){this.poseController=t,this.setControllerForCurrViewmode(),this.bindings.forEach((t=>t.renew()))}onAccessRevoked(t){this.stop(),this.bindings.forEach((t=>t.cancel())),this.poseController=null;for(const t of this.modeControls.values())t.controls.setController(null)}startRotateTransition(t,e,i=!0){return this.checkControlsForAction((s=>s.startRotateTransition(t,e,i)))}startZoomTransition(t,e,i=!0){return this.checkControlsForAction((s=>s.startZoomTransition(t,e,i)))}startTranslateTransition(t,e,i=!0){return this.checkControlsForAction((s=>s.startTranslateTransition(t,e,i)))}stop(){return this.checkControlsForAction((t=>(t.stop(),Promise.resolve())))}rotateBetweenOrientations(t,e,i,s,o=!1){return this.checkControlsForAction((n=>n.rotateBetweenOrientations(t,e,i,s,o)))}setControllerForCurrViewmode(){var t;if(this.viewmodeData&&this.viewmodeData.currentMode){const e=null===(t=this.modeControls.get(this.viewmodeData.currentMode))||void 0===t?void 0:t.controls;if(e){e.setController(this.poseController);for(const t of this.modeControls.values()){const i=t.controls;i!==e&&i.setController(null)}}}}checkControlsForAction(t){if(this.viewmodeData&&null!==this.viewmodeData.currentMode){const e=this.modeControls.get(this.viewmodeData.currentMode);if(e){return t(e.controls)}}return Promise.reject("checkControlsForAction() -> Current view mode is null")}addControls(t,e,i){this.modeControls.get(t)&&!i||(this.modeControls.set(t,{mode:t,controls:e}),this.setControllerForCurrViewmode())}}},79661:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>j});var s,o=i(71687),n=i(81662),r=i(44667),a=i(94790),h=i(60043),l=i(71397),d=i(28337),c=i(2993),u=i(53172),m=i(68909),p=i(92598),g=i(72268),f=i(33007),w=i(4994),v=i(3249),y=i(31093),D=i(13893),b=i(51887),M=i(28995),S=i(19968);!function(t){t[t.NONE=0]="NONE",t[t.ROTATE=1]="ROTATE",t[t.PAN=2]="PAN",t[t.ZOOM=3]="ZOOM"}(s||(s={}));g.O.NONE,s.NONE,g.O.PRIMARY,s.ROTATE,g.O.SECONDARY,s.PAN,g.O.MIDDLE,s.ZOOM,g.O.BACK,s.NONE,g.O.FORWARD,s.NONE,g.O.ALL,s.NONE;const T={[g.O.NONE]:s.NONE,[g.O.PRIMARY]:s.PAN,[g.O.SECONDARY]:s.ROTATE,[g.O.MIDDLE]:s.ZOOM,[g.O.BACK]:s.NONE,[g.O.FORWARD]:s.NONE,[g.O.ALL]:s.NONE};var x;!function(t){t[t.NONE=0]="NONE",t[t.MOUSE=1]="MOUSE",t[t.KEYBOARD=2]="KEYBOARD",t[t.TOUCH=3]="TOUCH"}(x||(x={}));class P{constructor(t,e,i,s,o,r){this.poseProxy=t,this.poseConstrainer=e,this.getRayPoint=i,this.getFocusPoint=s,this.invalidateParentOrbitCache=o,this.movingCamera=!1,this.smoothedTouch0=new m.Vector2,this.smoothedTouch1=new m.Vector2,this.origTouchAxis=new m.Vector2,this.origCenterPt=new m.Vector2,this.plane=new m.Plane(n.B1.UP.clone(),0),this.focusPlane=new m.Plane(n.B1.UP.clone(),0),this.maxScale=1,this.minScale=1,this.originalPinchLength=0,this.pointersMoved=(()=>{const t=new m.Vector2,e=new m.Vector3,i=new m.Vector3,s=new m.Vector2,o=new M.J(1),r=new m.Ray,a=new m.Vector3;return h=>{if(!this.poseController||!this.movingCamera)return;o.copy(this.poseProxy.pose);this.smoothedTouch0.lerp(h[0].position,.2),this.smoothedTouch1.lerp(h[1].position,.2),s.copy(this.smoothedTouch1).sub(this.smoothedTouch0).normalize();const l=this.origTouchAxis.angle()-s.angle();e.copy(this.initialPose.fovCorrectedPosition());const d=new m.Vector3(-this.intersectionPt.x,0,-this.intersectionPt.z);e.add(d),e.applyAxisAngle(n.B1.UP,l),d.negate(),e.add(d);const c=(new m.Quaternion).copy(this.initialPose.rotation),u=(new m.Quaternion).setFromAxisAngle(n.B1.UP,l);c.premultiply(u);const p=this.smoothedTouch0.clone().lerp(this.smoothedTouch1,.5),g=new m.Vector3;if(i.copy(n.B1.FORWARD).applyQuaternion(c),this.castFrom(p.x,p.y,g),isNaN(g.x))return void(this.movingCamera=!1);g.sub(this.intersectionPt),g.negate(),g.applyAxisAngle(n.B1.UP,l);const f=t.subVectors(this.smoothedTouch0,this.smoothedTouch1).length()/this.originalPinchLength,w=1-1/(0,v.qE)(f,this.minScale,this.maxScale),y=e.add(g).lerp(this.intersectionPt,w).clone();if(r.set(y,i),r.intersectPlane(this.focusPlane,a)){const t=a.distanceTo(y);o.position.copy(y),o.rotation.copy(c),o.focalDistance=t,o.resetProjMatrix(),o.applyPhiBasedFovSquish(),this.poseConstrainer.constrain(o),this.poseController.updateCameraPose(o),this.invalidateParentOrbitCache()}}})(),this.initMove=(()=>{const t=new m.Vector2,e=new m.Ray;return i=>{const s=i[0].position,o=i[1].position;this.smoothedTouch0.copy(s),this.smoothedTouch1.copy(o),this.originalPinchLength=t.subVectors(s,o).length(),this.origTouchAxis.copy(o).sub(s).normalize(),this.origCenterPt.copy(s).lerp(o,.5);const{pose:r}=this.poseProxy;this.initialPose=r.clone();const a=new m.Vector3,h=new m.Vector3;(0,S.Ft)(this.initialPose,a.set(this.origCenterPt.x,this.origCenterPt.y,-1),a),(0,S.Ft)(this.initialPose,h.set(this.origCenterPt.x,this.origCenterPt.y,1),h),h.sub(a).normalize(),e.set(a,h),this.intersectionPt=this.getRayPoint(e);const l=this.getFocusPoint();r.focalDistance=r.position.distanceTo(l),this.initialPose.focalDistance=r.position.distanceTo(l),this.maxScale=this.initialPose.fovCorrectedFocalDistance()/this.poseConstrainer.minZoomDistance,this.minScale=this.initialPose.fovCorrectedFocalDistance()/this.poseConstrainer.maxZoomDistance,this.poseConstrainer.setStartPose(this.initialPose);const d=r.phi()<b.Yp?r.forward().clone().multiplyScalar(-1):n.B1.UP;this.plane.setFromNormalAndCoplanarPoint(d,this.intersectionPt),this.focusPlane.setFromNormalAndCoplanarPoint(d,l)}})(),this.castFrom=(()=>{const t=new m.Ray,e=new m.Vector3,i=new m.Vector3;return(s,o,n)=>{(0,S.Ft)(this.initialPose,e.set(s,o,-1),e),(0,S.Ft)(this.initialPose,i.set(s,o,1),i),i.sub(e).normalize(),t.set(e,i),t.intersectPlane(this.plane,n)&&!n.equals(e)||(n.x=NaN)}})(),r.onGrabStart((t=>{this.movingCamera=!0,this.initMove(t.pointers)})),r.onGrabEnd((()=>{this.movingCamera=!1}))}isMovingCamera(){return this.movingCamera}rawPointerUpdate(t){this.pointersMoved(t.pointers)}setController(t){t?this.poseController=t:(this.poseController=void 0,this.movingCamera=!1)}}var C=i(52885),B=i(3066);var F;!function(t){t.NONE="none",t.GRAB="grab",t.SPIN="spin"}(F||(F={}));class O{constructor(){this.t1=new m.Vector2,this.t2=new m.Vector2,this.initT1=new m.Vector2,this.initT2=new m.Vector2,this.deltaT1=new m.Vector2,this.deltaT2=new m.Vector2,this.twoFingerEventCt=0,this.currGesture=F.NONE,this.contiguousGrabEventCt=0,this.grabStartObservers=new Set,this.grabEndObservers=new Set,this.spinStartObservers=new Set,this.spinEndObservers=new Set,this.gesturePointerIds=[null,null],this.currPos=new m.Vector2}rawPointerUpdate(t){if(t.pointers.length>=2){0===this.twoFingerEventCt?(this.t1.copy(t.pointers[0].clientPosition),this.t2.copy(t.pointers[1].clientPosition),this.initT1.copy(t.pointers[0].clientPosition),this.initT2.copy(t.pointers[1].clientPosition),this.gestureStartPointers=t,this.gesturePointerIds[0]=t.pointers[0].id,this.gesturePointerIds[1]=t.pointers[1].id,this.setCurrGesureAndNotifyObservers(F.NONE)):(this.t1.lerp(t.pointers[0].clientPosition,.2),this.t2.lerp(t.pointers[1].clientPosition,.2),(this.currGesture===F.NONE||this.currGesture===F.GRAB&&this.contiguousGrabEventCt<30)&&this.setCurrGesureAndNotifyObservers(this.nextGesture()));const e=(t.pointers[0].position.x+t.pointers[1].position.x)/2,i=(t.pointers[0].position.y+t.pointers[1].position.y)/2;this.currPos.set(e,i),this.twoFingerEventCt++}else this.twoFingerEventCt=0,this.setCurrGesureAndNotifyObservers(F.NONE),this.gesturePointerIds[0]=null,this.gesturePointerIds[1]=null;this.currGesture===F.GRAB&&this.contiguousGrabEventCt++}onGrabStart(t){return(0,B.Sh)((()=>this.grabStartObservers.add(t)),(()=>this.grabStartObservers.delete(t)),!0)}onGrabEnd(t){return(0,B.Sh)((()=>this.grabEndObservers.add(t)),(()=>this.grabEndObservers.delete(t)),!0)}onSpinStart(t){return(0,B.Sh)((()=>this.spinStartObservers.add(t)),(()=>this.spinStartObservers.delete(t)),!0)}onSpinEnd(t){return(0,B.Sh)((()=>this.spinEndObservers.add(t)),(()=>this.spinEndObservers.delete(t)),!0)}setCurrGesureAndNotifyObservers(t){const e=this.currGesture;if(this.currGesture=t,e===F.NONE)t===F.GRAB?this.notifyGrabStartObservers():t===F.SPIN&&this.notifySpinStartObservers();else if(e===F.GRAB)t===F.SPIN?(this.notifyGrabEndObservers(),this.notifySpinStartObservers()):t===F.NONE&&this.notifyGrabEndObservers();else if(e===F.SPIN)if(t===F.NONE)this.notifySpinEndObservers();else if(t===F.GRAB)throw new Error("Gesture recognizer should never switch from SPIN -> GRAB")}notifyGrabStartObservers(){for(const t of this.grabStartObservers)t(this.gestureStartPointers)}notifySpinStartObservers(){for(const t of this.spinStartObservers)t(this.gestureStartPointers)}notifyGrabEndObservers(){this.contiguousGrabEventCt=0;for(const t of this.grabEndObservers)t()}notifySpinEndObservers(){for(const t of this.spinEndObservers)t()}nextGesture(){if(this.twoFingerEventCt>5){const t=this.t1.y-this.initT1.y,e=this.t2.y-this.initT2.y,i=this.t1.x-this.initT1.x,s=this.t2.x-this.initT2.x;this.deltaT1.set(i,t),this.deltaT2.set(s,e);const o=this.deltaT1.length(),n=this.deltaT2.length(),r=Math.min(o,n)/Math.max(o,n)>.7,a=this.deltaT1.normalize().dot(this.deltaT2.normalize())>.7;return r&&a&&o>2&&n>2?F.SPIN:F.GRAB}return F.NONE}}var A=i(64491),k=i(78649);const I=f.A.epsilon,V=b.DQ,E=.15*Math.PI;class R extends w.A{constructor(t,e,i,o,r,a,h){super(),this.cameraPoseProxy=t,this.poseConstrainer=e,this.getOrbitPoint=i,this.getGrabPoint=o,this.constrolsData=a,this.messageBus=h,this.tempOrientation=new m.Quaternion,this.tempAxis=new m.Vector3,this.nextPosition=new m.Vector3,this.nextOrientation=new m.Quaternion,this.currentPose=new M.J(1),this.positionDelta=new m.Vector3,this.angularAccel=new m.Vector2,this.angularVelocity=new m.Vector2,this.linearAccel=new m.Vector2,this.linearVelocity=new m.Vector2,this.grabPlane=(new m.Plane).setFromNormalAndCoplanarPoint(n.B1.UP,n.B1.ZERO),this.grabPt=new m.Vector3,this.ndcPos=new m.Vector2,this.zoomAccel=0,this.zoomVelocity=0,this.orbitPoint=new m.Vector3,this.orbitDistance=0,this.orbitPlane=new m.Plane,this.needsOrbitDataInit=!0,this.autoOrbitStartPhi=0,this.aimTarget=new m.Vector3,this.currentPhiLowerLimit=b.ol,this.currentPhiUpperLimit=b.vc,this.activeAction=s.NONE,this.activeDevice=x.NONE,this.touchGestureRecognizer=new O,this.isTouchSpinning=!1,this.prevTouchY=0,this.prevTouchX=0,this.zoomDirection=new m.Vector3,this.castFromNdc=(()=>{const t=new m.Vector3,e=new m.Vector3(0,0,-1),i=new m.Ray(t,e),s=new m.Vector3;return()=>{(0,S.Ft)(this.grabCameraPose,t.set(this.ndcPos.x,this.ndcPos.y,-1),t),(0,S.Ft)(this.grabCameraPose,e.set(this.ndcPos.x,this.ndcPos.y,1),e),e.sub(t).normalize(),i.set(t,e);return i.intersectPlane(this.grabPlane,s)}})(),this.dampedZoomDir=(()=>{const t=new m.Vector3,e=new m.Quaternion,i=new m.Vector3,s=new m.Vector3,o=new m.Quaternion;return(n=b.qD)=>{const r=this.cameraPoseProxy.pose,a=r.forward().clone(),h=this.getGrabPoint(),l=h.clone().sub(this.cameraPoseProxy.pose.fovCorrectedPosition()).normalize(),d=this.poseConstrainer.modelBoundingBox.containsPoint(h)&&r.phi()>b.eW?l:a,c=o.angleTo(r.rotation)>1e-8;if(o.copy(r.rotation),t.length()<.1||c)t.copy(d),this.zoomDirection.copy(d);else{const o=t.angleTo(d);s.crossVectors(t,d);const r=(0,u.pu)(1*n),a=Math.min(o,r);e.setFromAxisAngle(s,a);const h=i.copy(t).applyQuaternion(e);t.copy(h),this.zoomDirection.copy(h)}}})(),this.touchControls=new P(t,e,r,i,(()=>this.invalidateOrbitMetadata()),this.touchGestureRecognizer),t.pose.autoOrtho&&(this.currentPhiUpperLimit=b.DQ),this.transition={active:!1,startTime:0,elapsed:0,duration:0,angularVelocity:new m.Vector2,linearVelocity:new m.Vector2,zoomVelocity:0,easeOut:!1},this.touchGestureRecognizer.onGrabStart((()=>{this.messageBus.broadcast(new k.i),this.stopAndClearState()})),this.touchGestureRecognizer.onGrabEnd((()=>this.stopAndClearState())),this.touchGestureRecognizer.onSpinStart((t=>{this.isTouchSpinning=!0,this.prevTouchX=(t.pointers[0].position.x+t.pointers[1].position.x)/2,this.prevTouchY=(t.pointers[0].position.y+t.pointers[1].position.y)/2,this.initMove(s.ROTATE,x.MOUSE)})),this.touchGestureRecognizer.onSpinEnd((()=>{this.endMove(),this.isTouchSpinning=!1}))}touchGestureIds(){return this.touchGestureRecognizer.gesturePointerIds}rawPointerUpdate(t){this.touchGestureRecognizer.rawPointerUpdate(t),this.touchControls.rawPointerUpdate(t)}setController(t){return super.setController(t),this.touchControls.setController(t),null===t&&this.activeAction!==s.NONE&&this.endMove(),this}setOrbitalAcceleration(t,e=!1){this.transition.active||(e&&this.haltVelocity(t,this.angularVelocity),this.angularAccel.x=void 0!==t.x?t.x:this.angularAccel.x,this.angularAccel.y=void 0!==t.y?t.y:this.angularAccel.y)}setPanAcceleration(t,e=!1){this.transition.active||(e&&this.haltVelocity(t,this.linearVelocity),this.linearAccel.x=void 0!==t.x?t.x:this.linearAccel.x,this.linearAccel.y=void 0!==t.y?t.y:this.linearAccel.y)}setNdcPos(t){this.ndcPos.copy(t)}initMove(t,e,i){if(e!==x.KEYBOARD&&(this.setPanAcceleration({x:0,y:0}),this.stop()),i&&this.setNdcPos(i),t!==this.activeAction||e!==this.activeDevice){this.updateOrbitState(),this.activeDevice=e,this.activeAction=t;const i=this.cameraPoseProxy.pose;this.poseConstrainer.setStartPose(i);const o=this.getGrabPoint(),r=i.phi()<b.Yp?i.forward().clone().multiplyScalar(-1):n.B1.UP;this.grabPlane.setFromNormalAndCoplanarPoint(r,o),this.grabCameraPose=this.cameraPoseProxy.pose.clone(),this.grabPt.copy(o),t===s.ROTATE&&this.messageBus.broadcast(new k.i)}}stopAndClearState(t=!1){((0,A.Fr)()||t)&&this.stop(),this.updateOrbitState(),this.activeDevice=x.NONE,this.activeAction=s.NONE}softStopAndClearState(){this.stopAcceleration(),this.updateOrbitState(),this.activeDevice=x.NONE,this.activeAction=s.NONE}endMove(t){t&&this.setNdcPos(t),this.isTouchSpinning?this.softStopAndClearState():this.stopAndClearState();const e=this.cameraPoseProxy.pose.pitchFactor();!this.isAutoOrbitting&&e<1&&e>1e-10&&this.cameraPoseProxy.pose.autoOrtho&&this.startAutoOrbitTo()}startAutoOrbitTo(t="top"){const e="top"===t?V:b.$V;if(Math.abs(this.cameraPoseProxy.pose.phi()-e)<1e-10)return Promise.resolve();const i=this.constrolsData.startAutoOrbit(t);return this.autoOrbitStartPhi=this.cameraPoseProxy.pose.phi(),i}stopAutoOrbit(){this.stopAndClearState(!0),this.constrolsData.stopAutoOrbit(),this.invalidateOrbitMetadata()}invalidateOrbitMetadata(){this.needsOrbitDataInit=!0}get isAutoOrbitting(){return this.constrolsData.isAutoOrbitting}get mouseDown(){return this.activeDevice===x.MOUSE||this.activeDevice===x.TOUCH}updateOrbitState(){if(this.activeAction!==s.ROTATE||this.needsOrbitDataInit){const t=this.cameraPoseProxy.pose,e=this.getOrbitPoint();this.orbitPoint.copy(e);const i=t.position.distanceTo(this.orbitPoint);this.orbitDistance=i/t.fovDistanceScale(),this.orbitPlane.setFromNormalAndCoplanarPoint(n.B1.UP,this.orbitPoint),this.cameraPoseProxy.pose.focalDistance=i,this.needsOrbitDataInit=!1}}setZoomAcceleration(t){this.transition.active||(this.zoomAccel=t)}async setPhiLimits(t,e,i){this.currentPhiLowerLimit=t,this.currentPhiUpperLimit=e;const s=this.cameraPoseProxy.pose.phi(),o=(0,v.qE)(0,this.currentPhiLowerLimit-s,this.currentPhiUpperLimit-s);Math.abs(o)>I&&i&&await this.orbit(new m.Vector2,!0)}haltVelocity(t,e){t.x&&e.x&&Math.sign(t.x)!==Math.sign(e.x)&&(e.x=0),t.y&&e.y&&Math.sign(t.y)!==Math.sign(e.y)&&(e.y=0)}startTransition(t,e,i,s,o){if(null===this.poseController)return y.i.reject("Unable to start transition, since controller is unavailable.");const n=new y.i;return this.transition.active=!0,this.transition.duration=t,this.transition.elapsed=0,this.transition.startTime=Date.now(),this.transition.deferred=n,this.transition.angularVelocity.copy(e),this.transition.linearVelocity.copy(i),this.transition.zoomVelocity=s,this.transition.easeOut=o,this.angularAccel.set(0,0),this.linearAccel.set(0,0),this.zoomAccel=0,this.angularVelocity.copy(e),this.linearVelocity.copy(i),this.zoomVelocity=s,this.poseController.beginExternalTransition(),n.promise()}stopTransition(){this.transition.active&&(this.poseController&&this.poseController.endExternalTransition(),this.transition.active=!1,this.endMove()),this.transition.deferred&&(this.transition.deferred.resolve(),this.transition.deferred=void 0)}updateTransition(t,e,i,s){let o=1,n=t/b.qD;if(this.transition.elapsed+=t,this.transition.elapsed>=this.transition.duration){o=(this.transition.duration-(this.transition.elapsed-t))/t,n=1}e&&(this.angularVelocity.copy(this.transition.angularVelocity).multiplyScalar(o*n),this.orbit(this.angularVelocity)),i&&(this.linearVelocity.copy(this.transition.linearVelocity).multiplyScalar(o*n),this.pan(this.linearVelocity)),s&&(this.zoomVelocity=this.transition.zoomVelocity*o*n,this.zoom(this.zoomVelocity)),this.transition.elapsed>=this.transition.duration&&(this.stop(this.transition.easeOut),this.transition.active=!1)}updateDefault(t,e,i,s){if(this.touchControls.isMovingCamera())return;const o=t/b.qD;if(e&&!s){this.angularVelocity.addScaledVector(this.angularAccel,o);const t=this.isTouchSpinning?1.1:1;this.orbit(this.angularVelocity.clone().multiplyScalar(o/t)),this.angularVelocity.multiplyScalar(Math.pow(1-b.g1,o)/t)}i&&(this.linearVelocity.addScaledVector(this.linearAccel,o),this.pan(this.linearVelocity),this.linearVelocity.multiplyScalar(Math.pow(1-b.g1,o))),s&&(this.zoomVelocity+=this.zoomAccel*o,this.zoom(this.zoomVelocity),this.zoomVelocity*=Math.pow(1-b.pz,o),this.angularVelocity.set(0,0),this.angularAccel.set(0,0))}startRotateTransition(t,e,i){return e.x*=-1,this.orbitDistance=this.cameraPoseProxy.pose.focalDistance,this.initMove(s.ROTATE,x.KEYBOARD),this.startTransition(t,e.clone().multiplyScalar(b.qD),new m.Vector2,0,i).nativePromise()}startTranslateTransition(t,e,i=!0){return this.initMove(s.PAN,x.KEYBOARD),this.startTransition(t,new m.Vector2,e.clone().multiplyScalar(b.qD),0,i).nativePromise()}startZoomTransition(t,e,i){return this.startTransition(t,new m.Vector2(0,0),new m.Vector2(0,0),e,i).nativePromise()}update(t){const e=this.linearAccel.length()>I||this.linearVelocity.length()>I,i=this.angularAccel.length()>I||this.angularVelocity.length()>I,o=Math.abs(this.zoomAccel)>I||Math.abs(this.zoomVelocity)>I,n=i||this.isAutoOrbitting,r=e||this.mouseDown&&this.activeAction===s.PAN,a=o;this.dampedZoomDir(t),this.updateMultiTouchGesture(t),this.activeDevice!==x.KEYBOARD||e||i||o?this.transition.active?this.updateTransition(t,n,r,a):this.updateDefault(t,n,r,a):this.endMove()}stopMomentum(){this.transition.active||(this.angularVelocity.set(0,0),this.linearVelocity.set(0,0),this.zoomVelocity=0)}stopAcceleration(){this.transition.active||(this.setOrbitalAcceleration({x:0,y:0}),this.setPanAcceleration({x:0,y:0}),this.setZoomAcceleration(0))}stop(t=!1){this.stopTransition(),this.stopAcceleration(),t||this.stopMomentum()}pan(t){if(!this.poseController)return;this.setupCurrentPose();const e=this.cameraPoseProxy.pose;if(this.mouseDown){const t=this.castFromNdc();if(t){const e=t.sub(this.grabPt);e.lengthSq()>0&&(this.nextPosition.copy(this.grabCameraPose.fovCorrectedPosition()).addScaledVector(e,-1),this.currentPose.position.copy(this.nextPosition),this.currentPose.applyPhiBasedFovSquish(),this.poseConstrainer.constrain(this.currentPose),this.poseController.updateCameraPose(this.currentPose))}}else this.positionDelta.x=t.x,this.positionDelta.z=t.y,this.positionDelta.y=0,this.nextPosition.copy(e.fovCorrectedPosition()).add(this.positionDelta),this.currentPose.position.copy(this.nextPosition),this.currentPose.applyPhiBasedFovSquish(),this.poseConstrainer.constrain(this.currentPose),this.poseController.updateCameraPose(this.currentPose)}orbit(t,e=!1){if(!this.poseController)return;this.setupCurrentPose();const i=this.cameraPoseProxy.pose,s=i.phi(),o=this.isAutoOrbitting?this.calcAutoOrbitVelocity(s):t,r=this.isAutoOrbitting?V:this.currentPhiUpperLimit,a=this.isAutoOrbitting?b.$V:this.currentPhiLowerLimit,h=(0,v.qE)(o.y,a-s,r-s),l=r-s<1e-10,d=s-a<1e-10,c="top"===this.constrolsData.autoOrbitTarget?l:d;if(this.isAutoOrbitting&&c)return void this.stopAutoOrbit();if(l&&h>0&&!(Math.abs(t.x)>0))return this.angularVelocity.y=0,void(this.angularAccel.y=0);const u=this.orbitDistance;if(this.aimTarget.copy(n.B1.FORWARD).applyQuaternion(i.rotation),this.aimTarget.setLength(u),this.aimTarget.addVectors(i.fovCorrectedPosition(),this.aimTarget),this.tempAxis.copy(n.B1.RIGHT),this.tempOrientation.setFromAxisAngle(this.tempAxis.applyQuaternion(i.rotation),-h),this.nextPosition.copy(i.fovCorrectedPosition()).sub(this.aimTarget).applyQuaternion(this.tempOrientation),this.nextOrientation.copy(i.rotation).premultiply(this.tempOrientation),this.tempOrientation.setFromAxisAngle(n.B1.UP,o.x),this.nextPosition.applyQuaternion(this.tempOrientation),this.nextOrientation.premultiply(this.tempOrientation),this.nextPosition=this.nextPosition.add(this.aimTarget),this.nextOrientation.normalize(),this.currentPose.position.copy(this.nextPosition),this.currentPose.rotation.copy(this.nextOrientation),this.currentPose.focalDistance=u,this.currentPose.applyPhiBasedFovSquish(),e)return this.poseController.moveTo({transitionType:D.fl.Interpolate,pose:{position:this.currentPose.position.clone(),rotation:this.currentPose.rotation.clone()},transitionTime:500}).nativePromise();this.poseController.updateCameraPose(this.currentPose)}zoom(t){if(!this.poseController)return;this.setupCurrentPose(),this.updateOrbitState();const e=this.cameraPoseProxy.pose;this.poseConstrainer.setStartPose(e);const i=e.forward().clone(),s=1/(this.getGrabPoint().distanceTo(e.position)/e.fovDistanceScale())*2,o=this.poseConstrainer.modelSize,n=t*b.aY/(s*o*b.mK),r=this.zoomDirection,a=this.orbitPoint,h=this.poseConstrainer.maxZoomDistance-this.poseConstrainer.minZoomDistance,l=a.distanceTo(e.position)/e.fovDistanceScale(),d=(0,v.qE)(n*h+l,this.poseConstrainer.minZoomDistance,this.poseConstrainer.maxZoomDistance)-l,c=r.setLength(-d);this.nextPosition.copy(e.fovCorrectedPosition()).add(c);const u=new m.Ray(this.nextPosition,i),p=new m.Vector3;let g=u.intersectPlane(this.orbitPlane,p);g&&!g.equals(this.nextPosition)||(g=a),this.currentPose.position.copy(this.nextPosition),this.currentPose.focalDistance=g.distanceTo(this.nextPosition),this.currentPose.resetProjMatrix(),this.currentPose.applyPhiBasedFovSquish(),this.poseConstrainer.constrain(this.currentPose),this.poseController.updateCameraPose(this.currentPose)}setupCurrentPose(){const t=this.cameraPoseProxy.pose;this.currentPose.copy(t),this.currentPose.unapplyPhiBasedFovSquish()}calcAutoOrbitVelocity(t){const e="top"===this.constrolsData.autoOrbitTarget?1:-1,i="top"===this.constrolsData.autoOrbitTarget?V:b.$V,s=Math.abs((i-t)/(i-this.autoOrbitStartPhi)),o=(0,C.C)(.002,.08,s);return new m.Vector2(0,e*o)}getDebugState(){return{plane:this.orbitPlane.clone(),orbitPt:this.orbitPoint.clone(),zoomDir:this.zoomDirection.clone().normalize()}}updateMultiTouchGesture(t){if(this.isTouchSpinning){const e=this.touchGestureRecognizer.currPos.x,i=this.touchGestureRecognizer.currPos.y,s=this.prevTouchX-e,o=this.prevTouchY-i,n=Math.abs(s)>.001?s:0,r=Math.abs(o)>.001?o:0,a=t/b.qD;this.setOrbitalAcceleration({x:E*n*a,y:E*r*a}),this.prevTouchX=e,this.prevTouchY=i}}}var N=i(12767);class _{constructor(t){this.idealOrbitCenter=new m.Vector3,this.gestureStartPose=new M.J(1),this.constrain=(()=>{const t=new m.Vector3,e=new m.Vector3,i=new m.Vector3,s=new m.Vector3,o=new m.Ray,r=new m.Plane;return a=>{const h=this.gestureStartPose.focalPoint(),l=a.focalPoint();if(l.distanceTo(h)<1e-10)return;const d=i.subVectors(a.position,this.gestureStartPose.position);o.set(this.gestureStartPose.position,d);const c=this.maxDeviationOfOrbitPoint.clampPoint(l,t),u=a.fovDistanceScale(),m=this.minOrbitDistance*u,p=this.maxOrbitDistance*u,g=(0,v.qE)(a.focalDistance,m,p),f=e.copy(c).addScaledVector(a.forward(),-1*g);Math.abs(d.y)>1e-8&&(r.setFromNormalAndCoplanarPoint(n.B1.UP,f),o.intersectPlane(r,s)&&f.copy(s)),a.focalDistance=g,a.position.copy(f),a.commit()}})(),this.updateConstraints(t)}updateConstraints(t){const e=t.getSize(new m.Vector3);this.modelSize=Math.max(e.length(),1),this.modelBoundingBox=t,this.idealOrbitCenter=t.getCenter(this.idealOrbitCenter);const i=t.max.distanceTo(this.idealOrbitCenter);this.minOrbitDistance=2;const s=2*i;this.maxOrbitDistance=s/Math.tan(N.Bv.fov/2*u.fy);const o=2*i;this.maxDeviationOfOrbitPoint=new m.Box3(this.idealOrbitCenter.clone().add(new m.Vector3(-o,0,-o)),this.idealOrbitCenter.clone().add(new m.Vector3(o,0,o))),this.maxDeviationOfOrbitPoint.min.y=this.modelBoundingBox.min.y,this.maxDeviationOfOrbitPoint.max.y=this.modelBoundingBox.max.y}get minZoomDistance(){return this.minOrbitDistance}get maxZoomDistance(){return this.maxOrbitDistance}setStartPose(t){this.gestureStartPose.copy(t)}containsPoint(t){return this.maxDeviationOfOrbitPoint.containsPoint(t)}}var L=i(2998),z=i(17986),U=i(62568),G=i(27394),H=i(90082),Q=i(99583);class j extends z.A{constructor(){super(...arguments),this.name="dollhouse-controls",this.controlState=s.NONE,this.movementKeys=new m.Vector2,this.didDrag=!1,this.displayDollhouseMetadata=!1,this.resetControlState=()=>{this.controlState=s.NONE},this.convertDeltaToLocal=(()=>{const t=new m.Vector3,e=new m.Vector3;return i=>{const s=i.x||0,o=i.y||0,r=this.cameraPoseProxy.pose.phi()>(0,u.pu)(85)?n.B1.UP:n.B1.FORWARD,a=2*s*this.cameraPoseProxy.pose.fovCorrectedFocalDistance(),h=2*o*this.cameraPoseProxy.pose.fovCorrectedFocalDistance()/this.cameraPoseProxy.pose.aspect();return t.copy(n.B1.RIGHT).applyQuaternion(this.cameraPoseProxy.pose.rotation).setY(0).setLength(a),e.copy(r).applyQuaternion(this.cameraPoseProxy.pose.rotation),t.add(e.setY(0).setLength(h)),t}})()}async init(t,e){[this.visibleMeshBounds,this.commonControlsModule,this.inputIni,this.raycaster,this.renderer,this.settings,this.viewmodeData]=await Promise.all([e.getModuleBySymbol(o.UN),e.getModuleBySymbol(o.X7),e.getModuleBySymbol(o.mL),e.getModuleBySymbol(o.sA),e.getModuleBySymbol(o.M7),e.getModuleBySymbol(H.ZF),e.market.waitForData(Q.X)]),this.settings.registerMenuButton({header:"Dollhouse",buttonName:"Toggle Orbit point display",callback:()=>{this.displayDollhouseMetadata=!this.displayDollhouseMetadata,this.displayDollhouseMetadata?this.createDebugObjects():this.removeDebugObjects()}}),this.cameraPoseProxy=this.commonControlsModule.cameraPoseProxy,this.poseConstrainer=new _(this.visibleMeshBounds.getVisibleBounds()),this.controlsData=new G.m,e.market.register(G.m,this.controlsData),this.controls=new R(this.cameraPoseProxy,this.poseConstrainer,(()=>this.computeOrbitPoint()),(()=>this.computeGrabPoint()),(t=>this.focusPointHelper(t)),this.controlsData,e.msgBus),this.bindings.push(this.visibleMeshBounds.onVisibleBoundsChanged((t=>{this.poseConstrainer.updateConstraints(t),this.controls.invalidateOrbitMetadata()}))),this.registerActiveStateChangeBinding();const i=this.inputIni;this.commonControlsModule.addControls(c.N3.Dollhouse,this.controls);const s=t=>{this.didDrag=!1,this.onDragBegin(t.buttons,t.position,t.device,t.ctrlKey)},n=t=>{t.timeSinceLastMove<100&&this.didDrag&&(this.onDrag(t.delta,t.position),this.controls.update(b.qD),this.controls.stopAcceleration()),this.onDragEnd(t.delta,t.buttons,t.position)},l=t=>{this.didDrag=!0,this.onDrag(t.delta,t.position),this.controls.update(b.qD),this.controls.stop()};this.inputBindings.push(i.registerHandler(r.s,(t=>{this.onScrollWheel(t)}))),this.inputBindings.push(i.registerHandler(a.SK,(t=>{this.isTouchDrag(t.pointerId)||s(t)}))),this.inputBindings.push(i.registerHandler(a._w,(t=>{this.isTouchDrag(t.pointerId)||n(t)}))),this.inputBindings.push(i.registerHandler(a.jF,(t=>{this.isTouchDrag(t.pointerId)||l(t)}))),this.inputBindings.push(i.registerHandler(p.H,(t=>{this.controls.rawPointerUpdate(t)}))),this.inputBindings.push(i.registerHandler(h.k,(t=>{t.state!==d.$.PRESSED&&this.onKey(t.key,t.state)}))),this.updateInputBindings(),this.controls.setPhiLimits(this.getDefaultPhiLowerLimit(),this.getDefaultPhiUpperLimit(),!1)}onUpdate(t){this.controls.isActive&&(this.controls.update(t),this.updateDebugObjects())}isTouchDrag(t){const e=this.controls.touchGestureIds();return e[0]===t||e[1]===t}setDollhouseVerticalLimits(t){return this.controls.setPhiLimits(void 0!==t.phiLowerLimitDegrees?t.phiLowerLimitDegrees*u.fy:this.getDefaultPhiLowerLimit(),void 0!==t.phiUpperLimitDegrees?t.phiUpperLimitDegrees*u.fy:this.getDefaultPhiUpperLimit(),void 0!==t.noTransition?!t.noTransition:this.controls.isActive)}getDefaultPhiUpperLimit(){return this.viewmodeData.isFloorplanDisabled()?U.oO-.01*u.fy:this.cameraPoseProxy.pose.autoOrtho?b.DQ:b.vc}getDefaultPhiLowerLimit(){return this.viewmodeData.isDollhouseDisabled()?b.DQ:b.ol}onActiveStateChanged(){super.onActiveStateChanged(),this.resetControlState()}onScrollWheel(t){this.zoom(t.delta.y)}zoom(t){0!==t&&(this.controls.setZoomAcceleration(t),this.controls.update(b.qD),this.controls.setZoomAcceleration(0))}onDragBegin(t,e,i,o=!1){if(this.controlState===s.NONE){const e=T;if(i===L.o.MOUSE){const i=this.applyKeyboardModifier(t,o);this.controlState=e[i]}else this.controlState=s.PAN}const n=i===L.o.TOUCH?x.TOUCH:x.MOUSE;this.controls.initMove(this.controlState,n,e)}onDrag(t,e){switch(this.controls.setNdcPos(e),this.controlState){case s.ROTATE:this.controls.setOrbitalAcceleration({x:-Math.PI*t.x,y:-Math.PI*t.y});break;case s.ZOOM:0!==t.y&&this.controls.setZoomAcceleration(-t.y)}}onDragEnd(t,e,i){e&this.controlState||(this.controlState=s.NONE,this.controls.endMove(i))}onKey(t,e){const i=e===d.$.DOWN;let o=!1;switch(t){case l.D.LEFTARROW:case l.D.J:this.controls.setOrbitalAcceleration({x:i?b.Yf:0},!0),this.controls.initMove(s.ROTATE,x.KEYBOARD);break;case l.D.RIGHTARROW:case l.D.L:this.controls.setOrbitalAcceleration({x:i?-b.Yf:0},!0),this.controls.initMove(s.ROTATE,x.KEYBOARD);break;case l.D.UPARROW:case l.D.I:this.controls.setOrbitalAcceleration({y:i?-b.Yf:0},!0),this.controls.initMove(s.ROTATE,x.KEYBOARD);break;case l.D.DOWNARROW:case l.D.K:this.controls.setOrbitalAcceleration({y:i?b.Yf:0},!0),this.controls.initMove(s.ROTATE,x.KEYBOARD);break;case l.D.W:this.movementKeys.y=i?1:0,o=!0;break;case l.D.S:this.movementKeys.y=i?-1:0,o=!0;break;case l.D.D:this.movementKeys.x=i?1:0,o=!0;break;case l.D.A:this.movementKeys.x=i?-1:0,o=!0;break;case l.D.PLUSEQUALS:this.zoom(-b.Dw);break;case l.D.DASHUNDERSCORE:this.zoom(b.Dw)}if(o){const t=this.convertDeltaToLocal(this.movementKeys).setLength(b.bI);this.controls.setPanAcceleration({x:t.x,y:t.z}),this.controls.initMove(s.PAN,x.KEYBOARD)}}computeGrabPoint(){const t=this.inputIni.getCurrentPointerRay();return this.focusPointHelper(t,!0)}computeOrbitPoint(){const t=this.cameraPoseProxy.pose,e=new m.Ray(t.position.clone(),t.forward().clone());return this.focusPointHelper(e)}focusPointHelper(t,e=!1){const i=()=>this.visibleMeshBounds.computeFocusPoint(t,(t=>this.poseConstrainer.containsPoint(t)));if(this.cameraPoseProxy.pose.autoOrtho&&!e)return i();{const e=this.raycaster.picking.pick(t.origin,t.direction);return e?e.point.clone():i()}}applyKeyboardModifier(t,e){let i=t;return e&&t===g.O.PRIMARY&&(i=g.O.SECONDARY),i}createDebugObjects(){if(null==this.debugPlane){const t=new m.PlaneHelper(new m.Plane,100,16711680);t.material.depthTest=!1,this.debugPlane=t}if(null==this.debugOrbit){const t=new m.SphereGeometry(.1,2,2),e=new m.MeshBasicMaterial({color:16711680,side:m.DoubleSide,depthTest:!1}),i=new m.Mesh(t,e);this.debugOrbit=i}if(null==this.debugZoom){const t=new m.SphereGeometry(.2,2,2),e=new m.MeshBasicMaterial({color:65280,side:m.DoubleSide,depthTest:!1}),i=new m.Mesh(t,e);this.debugZoom=i}if(null==this.debugVisibleBounds){const t=new m.Box3Helper(this.visibleMeshBounds.getVisibleBounds(),new m.Color(0,0,0));this.debugVisibleBounds=t}if(null==this.debugSceneBounds){const t=new m.Box3Helper(this.visibleMeshBounds.getFullBounds(),new m.Color(0,0,1));this.debugSceneBounds=t}this.renderer.getScene().add(this.debugPlane,this.debugOrbit,this.debugZoom,this.debugVisibleBounds,this.debugSceneBounds)}removeDebugObjects(){null!=this.debugPlane&&(this.renderer.getScene().remove(this.debugPlane),this.debugPlane=null),null!=this.debugOrbit&&(this.renderer.getScene().remove(this.debugOrbit),this.debugOrbit=null),null!=this.debugZoom&&(this.renderer.getScene().remove(this.debugZoom),this.debugZoom=null),null!=this.debugVisibleBounds&&(this.renderer.getScene().remove(this.debugVisibleBounds),this.debugVisibleBounds=null),null!=this.debugSceneBounds&&(this.renderer.getScene().remove(this.debugSceneBounds),this.debugSceneBounds=null)}updateDebugObjects(){if(this.displayDollhouseMetadata){const{plane:t,orbitPt:e,zoomDir:i}=this.controls.getDebugState();if(null!=this.debugPlane&&(this.debugPlane.plane=t,this.debugPlane.updateMatrixWorld(!0)),null!=this.debugOrbit&&this.debugOrbit.position.copy(e),null!=this.debugZoom){const t=this.cameraPoseProxy.pose.fovCorrectedPosition().clone().addScaledVector(i,this.cameraPoseProxy.pose.fovCorrectedFocalDistance());this.debugZoom.position.copy(t)}null!=this.debugVisibleBounds&&this.debugVisibleBounds.box.copy(this.visibleMeshBounds.getVisibleBounds()),null!=this.debugSceneBounds&&this.debugSceneBounds.box.copy(this.visibleMeshBounds.getFullBounds())}}}},98842:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>d});var s=i(74072),o=i(17183),n=i(81662);class r extends o.a{constructor(t,e,i,s,o=!1){super(t,e,i,s,o,!1,!0),this.cameraPoseProxy=t}calculateAimTarget(t,e){e.copy(n.B1.FORWARD).applyQuaternion(t.rotation),e.setLength(t.focalDistance),e.add(t.position)}}var a=i(10589),h=i(71687),l=i(71828);class d extends s.default{constructor(){super(...arguments),this.name="floorplan-controls"}async init(t,e){await super.init(t,e),e.getModuleBySymbol(h.mL).then((t=>{this.inputBindings.push(t.registerHandler(a.K,(t=>{this.controls.isActive&&(this.controls.setOrbitalAcceleration({x:t.rotateDelta,y:0}),this.controls.update(l.qD),this.controls.stop())})),t.registerHandler(a.t,this.resetControlState)),this.updateInputBindings()}))}createCameraControls(t,e,i,s){const o=this.commonControlsModule.cameraPoseProxy;this.controls=new r(o,s,t.extendedBounds,t.meshCenter,!0)}}},43440:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>C});var s=i(75578),o=i(71687),n=i(45395),r=i(76234),a=i(35473),h=i(58229),l=i(15404),d=i(81530),c=i(98585),u=i(20968),m=i(10843),p=i(68909);class g{constructor(){this.list=[]}insort(t){const e=this.binarySearch(t);let i=e.index;if(!e.success)for(;this.compare(t,this.list[i])>=0&&i<this.list.length;)i++;for(let t=this.list.length;t>i;t--)this.list[t]=this.list[t-1];this.list[i]=t}removeIndex(t){if(t>this.list.length)throw Error("OrderList.removeIndex() -> Invalid index: "+t);this.list.splice(t,1)}getElement(t){if(t>=0&&t<this.list.length)return this.list[t];throw new Error("OrderList.getElement() -> Invalid index: "+t)}get length(){return this.list.length}find(t){const e=this.binarySearch(t);return e.success?e.index:-1}compare(t,e){return void 0===e?1:"number"==typeof t&&"number"==typeof e?t===e?0:t<e?-1:1:t.compare(e)}binarySearch(t){let e,i=0,s=this.list.length-1,o=-1,n=0;for(;i<=s;){if(o=Math.floor((i+s)/2),e=this.list[o],n=this.compare(t,e),0===n)return{success:!0,index:o};n<0?s=o-1:i=o+1}return{success:!1,index:o}}}var f=i(28913),w=i(85616),v=i(81662),y=i(95330);class D extends w.v{constructor(t={}){super(),this.name="",this.center=new p.Vector3,this.centerOfMass=new p.Vector3,this._boundingBox=new y.L(new p.Box3),this.size=new p.Vector3,this.sweepHeights=new g,this.sweepFloorHeights=new g,this._groundPlane=new p.Plane,this._groundPt=new p.Vector3,this.medianSweepHeight=()=>this.sweepHeights.length>0?this.sweepHeights.getElement(Math.floor(this.sweepHeights.length/2)):this.center.y,this.minSweepFloorHeight=()=>this.sweepFloorHeights.length>0?this.sweepFloorHeights.getElement(0):this.boundingBox.min.y,Object.assign(this,t)}get boundingBox(){return this._boundingBox.value}set boundingBox(t){this.setBounds(t)}setBounds(t){this._boundingBox.value.copy(t),this._boundingBox.value.getSize(this.size),this._boundingBox.value.getCenter(this.center),this._boundingBox.setDirty(!0)}setCenterOfMass(t){this.centerOfMass.copy(t)}onBoundsChanged(t){return this._boundingBox.onChanged(t)}addSweep(t,e){this.sweepHeights.insort(t.y),this.sweepFloorHeights.insort(e.y)}medianSweepFloorHeight(){return this.sweepFloorHeights.length>0?this.sweepFloorHeights.getElement(Math.floor(this.sweepFloorHeights.length/2)):this.bottom}get bottom(){return this.minSweepFloorHeight()}get groundPlane(){return this._groundPt.set(0,this.bottom,0),this._groundPlane.setFromNormalAndCoplanarPoint(v.B1.UP,this._groundPt),this._groundPlane}get top(){return this.sweepFloorHeights.length>0?this.sweepFloorHeights.getElement(this.sweepFloorHeights.length-1):this.boundingBox.max.y}deepCopy(){return(0,f.A4)({id:this.id,meshGroup:this.meshGroup,index:this.index,name:this.name,center:this.center,boundingBox:this.boundingBox,size:this.size,medianSweepHeight:this.medianSweepHeight(),bottom:this.bottom})}}const b=new m.Ay("mds-floor-deserializer");class M{deserialize(t){if(!t||!this.validate(t))return b.debug("Deserialized invalid floor data from MDS",t),null;const e=t.label||"",i=t.dimensions||{areaFloor:-1},{areaFloor:s}=i;return new D({id:t.id,index:t.sequence,meshGroup:t.meshId,name:e,areaFloor:s||-1})}validate(t){return["id","sequence","meshId"].every((e=>e in t))}}class S{serialize(t){return{label:t.name}}}class T extends u.g{constructor(){super(...arguments),this.deserializer=new M,this.prefetchKey="data.model.floors"}async read(t={}){var e;const i={modelId:null!==(e=null==t?void 0:t.modelId)&&void 0!==e?e:this.getBaseViewId()};return this.query(c.GetFloors,i,t).then((t=>{var e,i;const s=null===(i=null===(e=null==t?void 0:t.data)||void 0===e?void 0:e.model)||void 0===i?void 0:i.floors;if(!s||!Array.isArray(s))return null;return s.reduce(((t,e)=>{const i=this.deserializer.deserialize(e);return i&&(t[e.id]=i),t}),{})}))}async update(t,e){const i=this.getBaseViewId(),s=(new S).serialize(e);if(!s)throw new Error("Could not update Floor");return this.mutate(c.PatchFloor,{modelId:i,floorId:t,data:s})}}var x=i(79875),P=i(47737);class C extends s.n{constructor(){super(...arguments),this.name="floors"}async init(t,e){const{readonly:i,baseUrl:s}=t;this.engine=e;const{mdsContext:r}=await e.market.waitForData(P.P);this.store=new T({context:r,readonly:i,baseUrl:s});const[c]=await Promise.all([this.store.read()]);if(this.data=new h.q(c||{}),e.market.register(h.q,this.data),!1===i){const t=this.data.getCollection();this.monitor=new a.F(t,{aggregationType:n.D.NextFrame,shallow:!0},e),this.monitor.onChanged((()=>this.engine.commandBinder.issueCommand(new d.F({dataTypes:[l.p.FLOORS]}))));const[i]=await Promise.all([e.getModuleBySymbol(o.T9)]);this.bindings.push(i.onSave((()=>this.save()),{dataType:l.p.FLOORS}))}}onUpdate(){}async save(){const t=this.monitor.getDiffRecord();this.monitor.clearDiffRecord();const e=[];for(const i of t){const t=i.index;if(!t)throw new x.v(`Invalid floor '${i.index}'`);i.action===r.Xw.updated&&e.push(this.store.update(t,i.diff))}return Promise.all(e)}}},59805:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>rt});var s=i(75578),o=i(71687),n=i(60043),r=i(81544),a=i(71397),h=i(28337),l=i(12837),d=i(99583),c=i(20599),u=i(22278),m=i(83075),p=i(51313),g=i(47004),f=i(98309),w=i(5243),v=i(2993),y=i(21875),D=i(27947),b=i(22585),M=i(58229),S=i(3249),T=i(52885),x=i(47299),P=i(10843);class C{constructor(t,e,i,s,o,n,r,a,h){this.getAngleModifier=t,this.floorsViewData=e,this.meshQuery=i,this.viewmodeData=s,this.raycasterData=o,this.cameraData=n,this.applicationData=r,this.touchDevice=a,this.meshModule=h}activate(){}init(){}dispose(){}deactivate(){}beforeRender(){const t=this.floorsViewData.nearestFloor,e=this.floorsViewData.transition.progress.active,i=!(!t||this.viewmodeData.isInside()),s=this.meshModule.getMeshGroupVisuals();if(!s)return void P.Ay.for(this).debug("No current mesh group visuals found");const o=x.u7.FADE_OPAQUE;let n=o,r=o;const a=this.getAngleModifier(),h=this.floorsViewData.onlyShowActiveFloor.value?0:1;s.globalOpacityModifier.value=s.allFloorsVisibleInOrtho.value||this.floorsViewData.isInAllFloorsMode||this.applicationData.application!==D.lg.SHOWCASE?1:this.cameraData.pose.pitchFactor(),i&&(this.viewmodeData.isDollhouse()||this.viewmodeData.isOrthographic()?(n=o*a*h*x.u7.FADE_IN_VALUE,r=n*x.u7.FADE_BELOW_MULT+x.u7.FADE_BELOW_START):(n=x.u7.FADE_ABOVE,r=x.u7.FADE_BELOW));const{floorOpacity:l}=s;for(const t of l.keys){const i=this.floorsViewData.floors.getFloorByMeshGroup(Number(t));let s=o;const a=this.isBelowSelectedFloor(i)?r:n;let h=(0,S.qE)(a+x.u7.FADE_IN_HOVER_BOOST_VALUE,0,1);this.floorsViewData.roomSelectModeActive&&(h=a),s=this.isHoveredFloor(null==i?void 0:i.id)&&!e&&a>0?h:a,s=this.isFloorTransitioningOut(i)?a:s;const d=this.isSelectedFloor(null==i?void 0:i.id)||this.isFloorTransitioningIn(i);if(s=d?o:s,s=this.clampForViewmodeTransitions(s),d)l.set(t,s);else{const e=l.get(t);if(null==e)l.set(t,s);else if(e!==s){let i=(0,T.C)(e,s,.2);Math.abs(s-i)<1e-4&&(i=s),l.set(t,i)}}}}render(){}clampForViewmodeTransitions(t){var e,i,s;if(this.viewmodeData.currentMode===v.N3.Transition){const{to:o}=this.viewmodeData.transition;if(o===v.N3.Panorama){const o=null!==(s=null===(i=null===(e=this.meshModule.getMeshGroupVisuals())||void 0===e?void 0:e.meshTextureOpacity)||void 0===i?void 0:i.value)&&void 0!==s?s:0;return Math.max(1-o,t)}}return t}isHoveredFloor(t){if(void 0!==t&&this.raycasterData.hit&&(this.viewmodeData.isDollhouse()||this.viewmodeData.isOrthographic())&&!this.touchDevice&&this.floorsViewData.isNavigable(t)){const e=this.raycasterData.hit.object;return t===this.meshQuery.floorIdFromObject(e)}return!1}isSelectedFloor(t){const e=this.floorsViewData.nearestFloor;return!e||!(!t||e.id!==t)}isBelowSelectedFloor(t){const e=this.floorsViewData.nearestFloor;return!!(t&&e&&e.index>t.index)}isFloorTransitioningIn(t){return!(!t||!this.floorsViewData.transition.progress.active||this.floorsViewData.transition.to&&this.floorsViewData.transition.to!==t.id)}isFloorTransitioningOut(t){return!(!t||!this.floorsViewData.transition.progress.active||this.floorsViewData.transition.from&&this.floorsViewData.transition.from!==t.id&&this.floorsViewData.transition.to===t.id)}}var B=i(31093),F=i(89928),O=i(48734),A=i(13893),k=i(9997),I=i(68909),V=i(81662),E=i(40397),R=i(78229),N=i(96659),_=i(79875),L=i(63362),z=i(72773),U=i(19968);const G=(t,e)=>{const i=e.singleFloor;return i&&!t?i.id:t};class H{constructor(t,e,i,s,o,n,r,a,h){this.engine=t,this.floorsData=e,this.floorsViewData=i,this.sweepData=s,this.cameraData=o,this.cameraController=n,this.viewmodeData=r,this.updateCurrentFloor=a,this.meshData=h,this.MOVE_TO_BLACK_TRANSITION_TIME=2e3,this.moveFloorUp=(t=!1,e)=>{const i=this.floorsViewData.currentFloorId,s=this.floorsViewData.getNavigableFloorIds(),o=i?s.indexOf(i):-1;let n=s[o+1];return void 0===n&&(n=this.viewmodeData.isInside()?s[s.length-1]:s[0]),this.moveToFloor(n,t,e)},this.moveFloorDown=(t=!1,e)=>{const i=this.floorsViewData.currentFloorId,s=this.floorsViewData.getNavigableFloorIds(),o=i?s.indexOf(i):s.length;let n=s[o-1];return void 0===n&&(n=this.viewmodeData.isInside()?s[0]:s[s.length-1]),this.moveToFloor(n,t,e)},this.moveToFloor=(t,e=!1,i,s)=>{const o=this.floorsViewData.currentFloorId,n=G(t,this.floorsViewData),r=o===n,a=n?this.floorsViewData.floors.getFloor(n):null;if(r||!this.floorsViewData.floorsEnabled)return this.updateCurrentFloor(n),B.i.resolve();if(a&&!this.canMoveToFloor(a,e))return B.i.reject(new _.v("Invalid floor ID"));this.engine.broadcast(new F.G(o,n)),void 0===i&&(i=z.t$);const h=new B.i;let l;this.floorsViewData.transitionToFloor(o,n,i,h.nativePromise()),this.floorsViewData.commit();let d,c=s;if(this.viewmodeData.isInside()){const t=t=>t=>this.floorsViewData.isCurrentOrAllFloors(t.floorId),e=!!n?R.Eo:t,i=[(0,R.Zx)(),(0,R.Ol)(),e(n)],o=[(0,N.cv)(s||this.cameraData.pose.position)],r=this.sweepData.sortByScore(i,o).shift();r&&(c=r.sweep.position,l=r.sweep.id)}else null!==n&&this.engine.commandBinder.issueCommand(new L.HP);d=e?Promise.resolve():this.getCameraTransition(n,i,l,c);const u=this,m=B.i.all([h,d]);return this.engine.startGenerator((function*(){let t=Date.now();for(;u.floorsViewData.transition.progress.active;){yield new O.oN;const e=Date.now(),i=e-t;u.floorsViewData.transition.progress.tick(i),u.floorsViewData.commit(),t=e}u.updateCurrentFloor(u.floorsViewData.transition.to),h.resolve()})),m}}moveToFloorIndex(t,e=!1,i,s){let o=null;if(t!==z.Zu){const e=this.floorsViewData.floors.getFloorAtIndex(t);if(!e)return B.i.reject(new _.v(`Invalid floor index ${t}`));o=e.id}return this.moveToFloor(o,e,i,s)}canMoveToFloor(t,e=!1){if(!t)return!1;const i=this.floorsViewData.transition.progress.active,s=this.cameraData.canTransition()||e,o=t.index<=this.floorsViewData.totalFloors-1,n=t.index>=-1;return!i&&s&&o&&n}getCameraTransition(t,e,i,s){if(this.viewmodeData.currentMode===v.N3.Dollhouse&&!(0,U.aY)(this.cameraData.pose.pitchFactor())){const i=this.getPoseForFloor(t,s);return this.cameraController.moveTo({transitionType:A.fl.Interpolate,pose:i.pose,focalDistance:i.focalDistance,transitionTime:e,autoOrtho:this.cameraData.pose.autoOrtho}).nativePromise()}return this.viewmodeData.isInside()&&i?this.engine.commandBinder.issueCommand(new k.aj({transition:A.fl.MoveToBlack,sweep:i,transitionTime:this.MOVE_TO_BLACK_TRANSITION_TIME})):Promise.resolve()}getPoseForFloor(t,e){const i=this.cameraData.pose.fovCorrectedPosition(),s=this.cameraData.pose.rotation,o=t?this.floorsData.getFloor(t):null,n=o?o.medianSweepHeight():this.meshData.meshCenter.y,r=o?o.center:this.meshData.meshCenter;r.setY(n);const a=V.B1.FORWARD.clone().applyQuaternion(s),h=i.clone();let l,d;if(e){const t=i.clone().addScaledVector(a,this.cameraData.pose.fovCorrectedFocalDistance()),s=(new I.Vector3).set(0,i.y,0),o=(new I.Vector3).set(0,t.y,0),r=s.distanceTo(o);h.setY(n+r);const c=t.clone().setY(e.y);d=c.distanceTo(h),this.viewmodeData.isDollhouse()&&(l=(0,E.kf)(h,c))}else{const t=(o?o.size.y:Q)/2+Q*-a.y;h.setY(n+t),d=h.distanceTo(r)}return{focalDistance:d,pose:{position:h,rotation:l}}}}const Q=8;var j=i(39209),W=i(23272),$=i(94814),q=i(86866),K=i(53172);class Z{constructor(t,e,i){this.floorsViewData=t,this.viewmodeData=e,this.pose=i,this.vectors={lookDir:new I.Vector3,flattenedLookDir:new I.Vector3},this.getAngleModifier=this.getAngleModifier.bind(this)}update(){const t=this.getAngleModifier(),e=1===this.floorsViewData.totalFloors,i=!!this.floorsViewData.nearestFloor,s=!this.viewmodeData.isInside()&&!this.viewmodeData.transitionActive();this.floorsViewData.roomSelectModeActive=s&&(e||i&&t<1||this.viewmodeData.isFloorplan()),this.floorsViewData.floorSelectModeActive=s&&1===t&&!e,this.floorsViewData.showFloorSelection=!this.viewmodeData.transitionActive()&&(this.viewmodeData.isDollhouse()||this.viewmodeData.isFloorplan())&&i&&!e,this.floorsViewData.floorSelectable=this.viewmodeData.isDollhouse()||this.viewmodeData.isOrthographic()}getAngleModifier(){const t=this.vectors.lookDir.copy(V.B1.FORWARD).applyQuaternion(this.pose.rotation),e=this.vectors.flattenedLookDir.copy(t).setY(0),i=t.angleTo(e)*K.tm,s=x.u7.FADE_IN_START_ANGLE,o=x.u7.FADE_IN_END_ANGLE,n=1-(0,q.m9)(i,s,o,0,1);return(0,$.Do)(n,0,1,1)}}var X=i(64491),Y=i(68986),J=i(23184),tt=i(35699),et=i(77510),it=i(59758),st=i(80303),ot=i(1197),nt=i(56208);class rt extends s.n{constructor(){super(),this.name="floors-viewdata",this.floorHoverBindings=[],this.onEndMoveToSweepMessage=t=>{const e=this.sweepData.getSweep(t.toSweep);(0,v.nI)(this.viewmodeData.closestMode)&&e&&this.updateCurrentFloor(e.floorId)},this.onMoveToFloorIndexCommand=async t=>this.floorNavigation.moveToFloorIndex(t.floorIndex,t.suppressCameraMovement,t.transitionTime,t.focusPoint),this.onShowAllFloorsCommand=async t=>{const e="boolean"==typeof t.moveCamera&&!t.moveCamera;await this.engine.commandBinder.issueCommand(new W.i1(null,e))},this.onEnableAllFloorsOptionCommand=async()=>{this.floorsViewData.showAllFloorsOption=!0,this.floorsViewData.commit()},this.onDisableAllFloorsOptionCommand=async()=>{this.floorsViewData.currentFloorIndex===z.Zu&&await this.floorNavigation.moveToFloorIndex(0,!0),this.floorsViewData.showAllFloorsOption=!1,this.floorsViewData.commit()},this.applicationChanged=()=>{this.floorsViewData.updateViewData()},this.updateCurrentFloor=t=>{if(!this.floorChangesAllowed())return;const e=G(t,this.floorsViewData);this.floorsViewData.currentFloorId!==e&&(this.floorsViewData.transitionToFloorInstant(e),this.engine.broadcast(new p.P(e,this.floorsViewData.getFloorName(e))))},this.updateFloorSelectMode=()=>{var t;null===(t=this.floorsSelectModeHelper)||void 0===t||t.update()},this.floorSelectFeatureEnabledCheck=()=>{const t=this.settingsData.tryGetSetting(st.p,!0),e=this.settingsData.tryGetSetting(nt.Q$.FloorSelect,!0),i=this.applicationData.application===D.lg.WORKSHOP;this.toggleFloors(i||t&&e)},this.onMoveToFloorCommand=this.onMoveToFloorCommand.bind(this)}async init(t,e){var i,s,n;this.engine=e,this.config=t,[this.floorsData,this.settingsData,this.applicationData,this.sweepData,this.viewmodeData]=await Promise.all([e.market.waitForData(M.q),e.market.waitForData(it.o),e.market.waitForData(D.zH),e.market.waitForData(l.A),e.market.waitForData(d.X)]);const r=await e.getModuleBySymbol(o.gS),a={floorChangesEnabled:()=>this.floorChangesAllowed()};if(this.floorsViewData=new j.X(this.floorsData,this.viewmodeData,this.sweepData,this.applicationData,r.t.bind(r),a),e.market.register(j.X,this.floorsViewData),[this.cameraData,this.input,this.raycasterData]=await Promise.all([e.market.waitForData(c.M),e.getModuleBySymbol(o.mL),e.market.waitForData(w.$)]),this.floorSelectFeatureEnabledCheck(),this.floorChangesAllowed()){const t=null===(i=this.config.startingFloorsVisibility)||void 0===i?void 0:i.lastIndexOf(1),e=null===(s=this.floorsData.getFloorAtIndex(t))||void 0===s?void 0:s.id,o=null===(n=this.sweepData.currentSweepObject)||void 0===n?void 0:n.floorId,r=o||e||null;(o||e)&&(P.Ay.for(this).debug(`Set initial floor to ${r} from current pose`),this.updateCurrentFloor(r))}const[h,m,p]=await Promise.all([e.getModuleBySymbol(o.jh),e.market.waitForData(u.U),e.getModuleBySymbol(o.GR)]);this.floorNavigation=new H(e,this.floorsData,this.floorsViewData,this.sweepData,this.cameraData,h,this.viewmodeData,this.updateCurrentFloor,m),this.floorsSelectModeHelper=new Z(this.floorsViewData,this.viewmodeData,this.cameraData.pose);const S=await e.getModuleBySymbol(o.PM),T=new C(this.floorsSelectModeHelper.getAngleModifier,this.floorsViewData,S,this.viewmodeData,this.raycasterData,this.cameraData,this.applicationData,(0,X.C8)(),p);e.addComponent(this,T),this.floorChangesAllowed()&&this.registerFloorHoverCursorEffect(),this.bindings.push(this.registerKeys(),e.subscribe(b.E5,this.applicationChanged),this.floorsData.onChanged(this.floorsViewData.updateViewData),e.subscribe(g.A,this.onEndMoveToSweepMessage),e.subscribe(f.A,function(t,e,i,s,o){let n=!0;return s=>{const r=t.tryGetData(y.R);if(!r||r&&r.isTourActive())return;(0,v.nI)(s.toMode)&&o.phase===D.Jj.PLAYING&&(n=null!==i.currentFloorId);const a=(0,v.nI)(s.fromMode),h=s.toMode===v.N3.Floorplan,l=s.toMode===v.N3.Dollhouse;if(!a||!l&&!h)return;const d=n||h?i.currentFloorId:null;e(new W.i1(d,!0,0))}}(e.market,e.commandBinder.issueCommand,this.floorsViewData,this.settingsData,this.applicationData)),e.commandBinder.addBinding(W.i1,this.onMoveToFloorCommand),e.commandBinder.addBinding(W.q8,this.onMoveToFloorIndexCommand),e.commandBinder.addBinding(W.$9,this.onShowAllFloorsCommand),e.commandBinder.addBinding(W.Qd,this.onEnableAllFloorsOptionCommand),e.commandBinder.addBinding(W.vr,this.onDisableAllFloorsOptionCommand),e.subscribe(ot.A,this.updateFloorSelectMode),this.cameraData.pose.onChanged(this.updateFloorSelectMode),this.floorsViewData.onChanged(this.updateFloorSelectMode),this.settingsData.onSettingChanged(st.p,this.floorSelectFeatureEnabledCheck),this.settingsData.onSettingChanged(nt.Q$.FloorSelect,this.floorSelectFeatureEnabledCheck),this.applicationData.onPropertyChanged("application",this.floorSelectFeatureEnabledCheck)),this.updateFloorSelectMode(),this.sweepData.currentSweepObject&&this.updateCurrentFloor(this.sweepData.currentSweepObject.floorId)}onUpdate(){}async onMoveToFloorCommand(t){return this.floorNavigation.moveToFloor(t.floorId,t.suppressCameraMovement,t.transitionTime,t.focusPoint).nativePromise()}toggleFloors(t){t||null===this.floorsViewData.currentFloorId||this.updateCurrentFloor(null),this.config.allowFloorChanges=t,this.updateFloorSelectMode(),this.floorChangesAllowed()?this.registerFloorHoverCursorEffect():this.clearFloorHoverBindings()}registerKeys(){return this.input.registerHandler(n.k,(async t=>{if(!this.cameraData.canTransition())return;const e=t.modifiers.shiftKey;if(t.state===h.$.PRESSED)switch(t.key){case a.D.UPARROW:e&&this.floorNavigation.moveFloorUp();break;case a.D.DOWNARROW:e&&this.floorNavigation.moveFloorDown();break;case a.D.R:this.floorNavigation.moveFloorUp();break;case a.D.F:this.floorNavigation.moveFloorDown();break;case a.D.Y:this.floorNavigation.moveToFloor(null)}}))}registerFloorHoverCursorEffect(){if(0===this.floorHoverBindings.length){const t=J.f.is((t=>m.m.isVisibleRoomMesh(t)&&this.floorsViewData.floorSelectable)),e=new Y.P(this.input.registerMeshHandler(r.L,t,(t=>{this.engine.commandBinder.issueCommand(new tt.X(et.b.FINGER))})),this.input.registerMeshHandler(r.q,t,(t=>{this.engine.commandBinder.issueCommand(new tt.X(et.b.DEFAULT))})));e.cancel();const i=(()=>{let t=!1;return()=>{const i=this.floorsViewData.floorSelectHoverEnabled;i!==t&&(t=i,t?e.renew():(e.cancel(),this.engine.commandBinder.issueCommand(new tt.X(et.b.DEFAULT))))}})();i();const s=()=>{this.floorsViewData.floorSelectHoverEnabled=!1,i()},o=()=>{this.floorsViewData.floorSelectHoverEnabled=!0,i()};this.floorHoverBindings.push(this.viewmodeData.onChanged(i),this.floorsViewData.onFloorSelectModeChange(i),this.floorsViewData.makeFloorChangeSubscription(i),this.engine.commandBinder.addBinding(W.uh,(async()=>s())),this.engine.commandBinder.addBinding(W.V6,(async()=>o())),e)}}clearFloorHoverBindings(){for(const t of this.floorHoverBindings)t.cancel();this.floorHoverBindings=[]}floorChangesAllowed(){return!this.floorsData.isMultifloor()||this.config.allowFloorChanges}dispose(t){super.dispose(t),this.clearFloorHoverBindings()}}},38208:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>m});var s=i(75578),o=i(71687),n=i(78079),r=i(2998),a=i(60043),h=i(90834),l=i(44351),d=i(72354),c=i(64491),u=i(10843);class m extends s.n{constructor(){super(...arguments),this.name="interactionmode",this.onPointerButtonEvent=t=>{let e=this.data.source;switch(t.device){case r.o.TOUCH:e=l.m.Touch;break;case r.o.MOUSE:e=l.m.Mouse;break;case r.o.PEN:e=l.m.Pen;break;case r.o.GAMEPAD:this.renderer.xr.enabled&&this.renderer.xr.isPresenting&&(e=l.m.XRController);break;default:u.Ay.for(this).debug("source:",t.device,t)}this.updateSource(e)},this.onKeyEvent=()=>{this.updateSource(l.m.Key)}}async init(t,e){this.engine=e,this.data=new h.O,this.mobileBrowser=(0,c.Fr)();const i=await e.getModuleBySymbol(o.M7);this.renderer=i.threeRenderer,this.updateMode(this.getInteractionMode(),this.data.mode),this.engine.market.register(h.O,this.data),e.getModuleBySymbol(o.mL).then((t=>{this.bindings.push(t.registerHandler(n.CD,this.onPointerButtonEvent),t.registerHandler(a.k,this.onKeyEvent))}))}onUpdate(t){const e=this.getInteractionMode();this.updateMode(e,this.data.mode)}getInteractionMode(){if(this.renderer.xr.enabled&&this.renderer.xr.isPresenting){let t=l.o.VrUnknown+"unknown",e=!1;const i=this.renderer.xr.getSession();if(null!==i&&i.inputSources.length>0)for(const s of i.inputSources)switch(s.targetRayMode){case"gaze":case"screen":t=l.o.VrOrientOnly,e=!0;break;case"tracked-pointer":t=l.o.VrWithTrackedController,e=!0;break;case"transient-pointer":t=l.o.VrTransientPointer,e=!0;break;default:e||"string"!=typeof s.targetRayMode||(t=l.o.VrUnknown+s.targetRayMode)}return t}return this.mobileBrowser?l.o.Mobile:l.o.Desktop}updateMode(t,e){t!==this.data.mode&&(this.data.updateMode(t),this.data.commit(),this.engine.broadcast(new d.b(this.data.mode,e)))}updateSource(t){t!==this.data.source&&(this.data.updateSource(t),this.data.commit(),this.engine.broadcast(new d.J(this.data.source)))}}},65051:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>c});var s=i(75578),o=i(71687),n=i(58229),r=i(12837),a=i(39118),h=i(24790),l=i(10843),d=i(47737);class c extends s.n{constructor(){super(...arguments),this.name="mesh-api-data-fixups"}async init(t,e){const{market:i}=e;[this.floorData,this.sweepData,this.modelMeshModule,this.meshQuery,this.analytics,this.layersData]=await Promise.all([i.waitForData(n.q),i.waitForData(r.A),e.getModuleBySymbol(o.GR),e.getModuleBySymbol(o.PM),e.getModuleBySymbol(o.aF),i.waitForData(d.P)]),await this.modelMeshModule.firstMeshLoadPromise,this.assignSweepToFloors(),this.assignBoundingBoxesToFloors(),this.assignMissingSweepFloors(),this.registerRoomAssociationSource(e),this.sweepData.getCollectionUnfiltered().onElementsChanged((async t=>{(t.added||t.updated)&&(await this.modelMeshModule.getMeshLoadPromise(this.layersData.currentViewId),this.assignMissingSweepFloors(t.added||t.updated,!1))}))}async assignBoundingBoxesToFloors(){const t=await this.modelMeshModule.getMeshLoadPromise(this.layersData.currentViewId);if(t&&t.length){const e=t[0].meshData.meshGroups.floors;this.floorData.iterate(((t,i)=>{const s=e.get(t.meshGroup);s&&(t.setBounds(s.boundingBox),t.setCenterOfMass(s.centerOfMass))})),this.floorData.commit()}}assignMissingSweepFloors(t,e=!0){let i=0;try{this.sweepData.getCollectionUnfiltered().atomic((()=>{var e;const s=null!=t?t:this.sweepData.getCollectionUnfiltered().entries();for(const[,t]of s)if(!t.isUnplaced()){let s;if(null===t.floorId||!this.floorData.hasFloor(t.floorId)){const o=this.meshQuery.floorIdFromObject(null===(e=this.meshQuery.nearestMeshInfo(t.position))||void 0===e?void 0:e.object);o&&this.floorData.hasFloor(o)&&(s=this.floorData.getFloor(o)),(null==s?void 0:s.id)&&s.id!==t.floorId&&(l.Ay.for(this).debug(`Setting ${t.alignmentType} sweep ${t.id} from floor ${t.floorId} to ${s.id}`),t.floorId=s.id,t.commit(),i++)}}}))}finally{0!==i&&e&&this.analytics.track("mesh_api_data_fixup_sweeps_assigned",{missing_floor_count:i})}}assignSweepToFloors(){this.sweepData.getSweepList().forEach((t=>{var e;if(!t.isUnplaced()&&t.isAligned()){let i;if(t.floorId&&this.floorData.hasFloor(t.floorId))i=this.floorData.getFloor(t.floorId);else{const s=this.meshQuery.floorIdFromObject(null===(e=this.meshQuery.nearestMeshInfo(t.position))||void 0===e?void 0:e.object);s&&this.floorData.hasFloor(s)&&(i=this.floorData.getFloor(s))}i&&i.addSweep(t.position,t.floorPosition)}})),this.floorData.commit()}registerRoomAssociationSource(t){const e=this.sweepData;t.commandBinder.issueCommandWhenBound(new a.l({type:"locations",getPositionId:function*(){for(const t of e.sweeps())yield{id:t.id,roomId:t.roomId||void 0,floorId:t.floorId||void 0,position:t.position,layerId:h.qw}},updateRoomForId:(t,i)=>{const s=e.getSweep(t);if(!s)throw new Error("Invalid sweep id!");s.roomId=i||null,s.commit()}}))}}},35396:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>p});var s=i(75578),o=i(71687),n=i(50485),r=i(58229);const a=(...t)=>function(e){return t.every((t=>t(e)))};var h=i(83075),l=i(68909),d=i(98718),c=i(47737),u=i(46192),m=i(10843);class p extends s.n{constructor(){super(...arguments),this.name="mesh-query",this.roomBoundData=null,this.isSegmentTrimmed=(t,e)=>{var i;const s=null===(i=this.engine.getModuleBySymbolSync(o.GR))||void 0===i?void 0:i.meshTrimData;return!!(s&&s.numberOfTrims>0)&&s.isSegmentTrimmed(t,e)},this.isSegmentOccluded=(()=>{const t=new l.Ray,e=new l.Vector3,i=new l.Vector3;return(s,o,n=0)=>{if(0===n){t.origin.set(s.x,s.y,s.z),t.lookAt(e.set(o.x,o.y,o.z));const i=this.raycaster.picking.pick(t.origin,t.direction,h.m.isRoomMesh);return!!i&&i.distance*i.distance<=e.distanceToSquared(t.origin)}return t.direction.subVectors(o,s).normalize(),this.raycaster.picking.intersectsCapsule(e.copy(s).addScaledVector(t.direction,n),i.copy(o).addScaledVector(t.direction,-n),n,h.m.isRoomMesh)}})()}async init(t,e){const{market:i}=e;this.engine=e,[this.raycaster,this.floorData,this.roomData,this.layersData]=await Promise.all([e.getModuleBySymbol(o.sA),i.waitForData(r.q),i.waitForData(n.q),i.waitForData(c.P)]),i.waitForData(d.A).then((t=>this.roomBoundData=t))}nearestMeshInfoOnFloor(t,e){const i=a(h.m.isRoomMesh,this.matchesFloorId(e));return this.raycaster.picking.nearest((new l.Vector3).set(t.x,t.y,t.z),i)}nearestMeshInfo(t){return this.raycaster.picking.nearest((new l.Vector3).set(t.x,t.y,t.z),h.m.isRoomMesh)}inferMeshIdsFromPoint(t,e,i=!0){const s=i&&(0,u.C)(this.roomBoundData,this.layersData,t.layerId),o=!!this.roomBoundData&&this.roomBoundData.hasRooms()&&s;let n=!s||!t.roomId||!this.roomData.get(t.roomId);const r=!t.floorId||!this.floorData.hasFloor(t.floorId);if(!r&&n&&o&&this.roomBoundData){const i=this.roomBoundData.findRoomIdForPosition(e,t.floorId);i&&(t.roomId=i,n=!1)}if(n||r){const i=r?h.m.isRoomMesh:a(h.m.isRoomMesh,this.matchesFloorId(t.floorId)),s=this.raycaster.picking.nearest((new l.Vector3).set(e.x,e.y,e.z),i);let d;if(this.roomBoundData&&this.roomBoundData.hasRooms()){if(s){const t=s.object.meshGroup;if(void 0!==t){const i=this.floorData.getFloorByMeshGroup(t);i&&(d={floorId:i.id,roomId:o&&this.roomBoundData.findRoomIdForPosition(e,i.id)||void 0})}}}else d=s&&this.roomIdFloorIdFromObject(s.object);if(d){const{roomId:e,floorId:i}=d;m.Ay.for(this).debug("data-fixup:",n?{roomId:e,prev:t.roomId}:"",r?{floorId:i,prev:t.floorId}:"",{data:t}),n&&(t.roomId=e),r&&(t.floorId=i)}else m.Ay.for(this).warn("Nearest Room/Floor not found for:",{point:e,data:t,invalidRoomId:n,invalidFloorId:r})}return t}roomIdFloorIdFromObject(t){if(!h.m.hasMeshGroup(t))return;const e=this.floorData.getFloorByMeshGroup(t.meshGroup);if(void 0===e)return;const i=(0,u.C)(this.roomBoundData,this.layersData,null)&&h.m.hasMeshSubgroup(t)?this.roomData.getByMeshSubgroup(t.meshSubgroup):void 0;return{floorId:e.id,roomId:null==i?void 0:i.id}}floorIdFromObject(t){if(h.m.hasMeshGroup(t)){const e=this.floorData.getFloorByMeshGroup(t.meshGroup);return null==e?void 0:e.id}}mdsRoomIdFromObject(t){if(!(0,u.C)(this.roomBoundData,this.layersData,null)||!h.m.hasMeshSubgroup(t)||!h.m.hasMeshGroup(t))return;const e=this.roomData.getByMeshSubgroup(t.meshSubgroup);if(!e)return;const i=this.floorData.getFloorByMeshGroup(t.meshGroup);return e.floorId===(null==i?void 0:i.id)?e.id:void 0}mdsFloorIdFromObject(t){if(!h.m.hasMeshGroup(t))return;const e=this.floorData.getFloorByMeshGroup(t.meshGroup);return e?e.id:void 0}matchesFloorId(t){return e=>{const i=this.roomIdFloorIdFromObject(e);return(null==i?void 0:i.floorId)===t}}}},34457:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>Qt});var s=i(68909),o=i(75578),n=i(56413),r=i(31093),a=i(90082),h=i(71687),l=i(81662),d=i(10843),c=i(94814),u=i(64491),m=i(70046),p=i(97171),g=i(20599),f=i(12837),w=i(72773),v=i(11018),y=i(79388),D=i(99583),b=i(2993),M=i(7662),S=i(79545);const T=new s.Ray,x=new s.Matrix4,P=s.Mesh.prototype.raycast;function C(t,e){if(this.geometry.boundsTree){if(void 0===this.material)return;x.copy(this.matrixWorld).invert(),T.copy(t.ray).applyMatrix4(x);const i=this.geometry.boundsTree;if(!0===t.firstHitOnly){const s=(0,M.sP)(i.raycastFirst(T,this.material),this,t);s&&e.push(s)}else{const s=i.raycast(T,this.material);for(let i=0,o=s.length;i<o;i++){const o=(0,M.sP)(s[i],this,t);o&&e.push(o)}}}else P.call(this,t,e)}function B(t){return this.boundsTree=new S.G(this,t),this.boundsTree}function F(){this.boundsTree=null}let O=!1;var A=i(35457),k=i(55141);class I extends k.u{constructor(t,e,i){super(),this.payload={sweepId:t,texture:e,quaternion:i}}}I.id="SET_PANO_OVERLAY";var V=i(85227),E=i(90572),R=i(22278);class N{constructor(t){this.floorData={},this.floorUniforms={},this.isPanoMode=t}getSharedFloorUniforms(t){var e,i,s;return null!==(e=(i=this.floorUniforms)[s=`${t}`])&&void 0!==e?e:i[s]=this.buildFloorUniforms(t)}setFloorTrims(t,e){var i,s;const o=this.floorData[t]={};for(const t of e){if(t.enabled&&(!this.isPanoMode||this.isPanoMode&&t.activeInPanoMode)){(t.discardContents?null!==(i=o.discardTrims)&&void 0!==i?i:o.discardTrims=[]:null!==(s=o.keepTrims)&&void 0!==s?s:o.keepTrims=[]).push(t)}}(`${t}`==`${w.Zu}`?Object.keys(this.floorUniforms):[t]).forEach((t=>{var e,i,s,o;const n=this.floorUniforms[t];n&&(null===(e=n.meshTrimDiscardIndexTex)||void 0===e||e.dispose(),null===(i=n.meshTrimDiscardMatricesTex)||void 0===i||i.dispose(),null===(s=n.meshTrimKeepIndexTex)||void 0===s||s.dispose(),null===(o=n.meshTrimKeepMatricesTex)||void 0===o||o.dispose()),delete this.floorUniforms[t]}))}buildFloorUniforms(t){const e=this.floorData[t],i=this.floorData[w.Zu],s=[...(null==e?void 0:e.discardTrims)||[],...(null==i?void 0:i.discardTrims)||[]],o=[...(null==e?void 0:e.keepTrims)||[],...(null==i?void 0:i.keepTrims)||[]],{indexBounds:n,indexTex:r,matricesTex:a}=this.buildUniformsForTrims(s),{indexBounds:h,indexTex:l,matricesTex:d}=this.buildUniformsForTrims(o);return{meshTrimDiscardIndexBounds:n,meshTrimDiscardIndexTex:r,meshTrimDiscardMatricesTex:a,meshTrimKeepIndexBounds:h,meshTrimKeepIndexTex:l,meshTrimKeepMatricesTex:d}}buildUniformsForTrims(t){var e;const i=new s.Box3,o=new Map;t.forEach((t=>{i.union(t.getContainingAABB()),o.set(t,t.getOBB())}));const{min:{x:n,z:r},max:{x:a,z:h}}=i;if(!t.length||i.isEmpty())return{indexBounds:null,indexTex:null,matricesTex:null};const l=Math.min(128,Math.ceil(a-n)),d=Math.min(128,Math.ceil(h-r)),c=(a-n)/l,u=(h-r)/d,m=new Int32Array(l*d*2).fill(-1),p=new Map,g=[],f=new s.Box3;f.min.y=i.min.y,f.max.y=i.max.y;for(let i=0;i<l;i++){f.min.x=n+c*i,f.max.x=n+c*(i+1);for(let s=0;s<d;s++){f.min.z=r+u*s,f.max.z=r+u*(s+1);let n=null;for(const i of t)(null===(e=o.get(i))||void 0===e?void 0:e.intersectsBox3(f))&&(null!=n?n:n=[]).push(i);if(n){const t=n.map((t=>t.id)).sort().join("|");let e=p.get(t);if(!e){const i=g.length;for(const t of n)g.push(t.getInverseTransformationMatrix());e={offset:i,count:n.length},p.set(t,e)}m[2*(s*l+i)]=e.offset,m[2*(s*l+i)+1]=e.count}}}const w=new s.Vector4(n,r,a,h),v=new s.DataTexture(m,l,d,s.RGIntegerFormat,s.IntType),y=Math.min(1024,4*g.length),D=Math.ceil(4*g.length/y),b=new Float32Array(y*D*4);g.forEach(((t,e)=>{b.set(t.elements,16*e)}));const M=new s.DataTexture(b,y,D,s.RGBAFormat,s.FloatType);return v.needsUpdate=M.needsUpdate=!0,{indexBounds:w,indexTex:v,matricesTex:M}}}var _=i(27947),L=i(59758),z=i(84440),U=i(32502),G=i(37458),H=i(3066),Q=i(48539);function j(t,e){if(null==e)return e;if(e.isVector3||e.isVector4||e.isMatrix3||e.isMatrix4||e.isColor)return null!=t?(t.copy(e),t):e.clone();if(Array.isArray(e)&&(Array.isArray(t)||null==t)){null==t&&(t=[]);const i=0===t.length;let s=t.length===e.length;for(let o=0;o<e.length;o++){s=s||void 0===t[o]||t[o]!==e[o];const n=j(i?void 0:t[o],e[o]);i?t.push(n):s&&(t[o]=n)}return t}return e}var W=i(70497),$=i(2593);class q extends s.ShaderMaterial{constructor(t,e,i,s){const o={};for(const t of e)o[t]=!0;super({fragmentShader:$.f.fragmentShader,vertexShader:$.f.vertexShader,uniforms:i,name:t,defines:o}),this.getSide=s,this.capabilities=e}get side(){return this.getSide()}set side(t){}}var K=i(50839),Z=i(39994),X=i(47299);let Y,J=1;try{Y=(0,Z.QN)(0,0)}catch(t){}const tt=[{key:K.d.PanoTextureTransition,enabled:function(t){return t.progress.value>0&&t.progress.value<1&&t.pano0Map.value!==t.pano1Map.value},dependsOn:[K.d.PanoTexture],uniformsUsed:["progress","pano0Map","pano1Map"]},{key:K.d.PanoTexture,enabled:function(t){return t.panoOpacity.value>0},dependsOn:[],uniformsUsed:["panoOpacity"]},{key:K.d.ColorOverlay,enabled:function(t){return null!==t.colorOverlay.value},dependsOn:[],uniformsUsed:["colorOverlay"]},{key:K.d.MeshPreviewSphere,enabled:function(t){return null!==t.meshPreviewCenter.value},dependsOn:[K.d.MeshTexture],uniformsUsed:[]},{key:K.d.MeshTexture,enabled:function(t){return t.meshOpacity.value>0&&t.map.value},dependsOn:[],uniformsUsed:["meshOpacity","map"]},{key:K.d.Wireframe,enabled:function(t){return!1},dependsOn:[],uniformsUsed:[]},{key:K.d.FlatShading,enabled:function(t){return!1},dependsOn:[],uniformsUsed:[]},{key:K.d.PanoOverlay,enabled:function(t){return!!t.overlay0Map.value},dependsOn:[K.d.PanoTexture],uniformsUsed:["overlay0Map"]},{key:K.d.PanoOverlayTransition,enabled:function(t){return!!(t.progress.value>0&&t.progress.value<1&&t.overlay0Map.value&&t.overlay1Map.value&&t.overlay0Map.value!==t.overlay1Map.value)},dependsOn:[K.d.PanoOverlay,K.d.PanoTexture,K.d.PanoTextureTransition],uniformsUsed:["progress","overlay0Map","overlay1Map"]},{key:K.d.MeshTrimDiscard,enabled:function(t){return!!t.meshTrimDiscardIndexBounds.value},dependsOn:[K.d.MeshTexture],uniformsUsed:["meshTrimDiscardIndexBounds","meshTrimDiscardIndexTex","meshTrimDiscardMatricesSize","meshTrimDiscardMatricesTex"]},{key:K.d.MeshTrimKeep,enabled:function(t){return!!t.meshTrimKeepIndexBounds.value},dependsOn:[K.d.MeshTexture],uniformsUsed:["meshTrimKeepIndexBounds","meshTrimKeepIndexTex","meshTrimKeepMatricesSize","meshTrimKeepMatricesTex"]},{key:K.d.FloorTrimVertex,enabled:function(t){return!!(t.floorTrimHeight.value<1)},dependsOn:[K.d.MeshTexture],uniformsUsed:["floorTrimHeight"]},{key:K.d.FloorTrimPixel,enabled:function(t){return!!(t.floorTrimHeight.value<1)},dependsOn:[K.d.MeshTexture],uniformsUsed:["floorTrimHeight"]}],et=new Set(tt.map((t=>t.uniformsUsed)).reduce(((t,e)=>t.concat(e)),[])),it=new Set(["progress","panoOpacity","meshOpacity","pano0Map","pano0Position","pano0Matrix1","pano0Matrix2","pano1Map","pano1Position","pano1Matrix1","pano1Matrix2","overlay0Map","overlay0Matrix","overlay1Map","overlay1Matrix","floorTrimHeight","floorHeightMin","floorHeightMax"]);class st{constructor(t,e,i,o,n="",r="",a=!1){this.meshGroup=t,this.meshSubgroup=e,this.geometry=i,this.sharedState=o,this.textureName=n,this.sourceKey=r,this.id=J++,this.name="",this.lod=W.X.Standard,this.capabilityOverrides={},this.onMaterialUpdate=new Set,this.uniformCache=st.getUniformDefaults(),this.opacity=1,this.needsVertexNormalRecompute=!0,this.temp={m1:new s.Matrix4,m2:new s.Matrix4,quat:new s.Quaternion,m3:null},this.textureCacheKey=`${r}${n}`,this.standardMaterial=this.getChunkMaterial(this.getCapabilities(),!1),this.updateRenderingMode(),a&&this.setMaterialsUniform(o.globalUniforms)}dispose(){this.geometry.dispose()}static getUniformDefaults(){const t={};for(const e in $.f.uniforms){const i=s.UniformsUtils.clone($.f.uniforms[e]);for(const e in i)t[e]=i[e]}const e=s.UniformsUtils.clone($.A.ceilingProcess.uniforms);for(const i in e)t[i]=e[i];return t}set material(t){if(this._material!==t&&this.onMaterialUpdate)for(const e of this.onMaterialUpdate.values())e(t);this._material=t}get material(){return this._material}notifyOnMaterialUpdated(t){return(0,H.Sh)((()=>this.onMaterialUpdate.add(t)),(()=>this.onMaterialUpdate.delete(t)),!0)}setMeshTexture(t){this.setMaterialsUniform({map:t})}getColorOverlay(){return this._colorOverlay}setColorOverlay(t){this._colorOverlay!==t&&(this.setMaterialsUniform({colorOverlay:t}),this._colorOverlay=t)}setMeshTextureOpacity(t){t!==this._meshTextureOpacity&&(this.setMaterialsUniform({meshOpacity:t,panoOpacity:1-t}),this._meshTextureOpacity=t)}setProgress(t){this._progress!==t&&(this.setMaterialsUniform({progress:t}),this._progress=t)}needsTransparent(){return this.opacity<X.u7.FADE_OPAQUE}setOpacity(t){this.opacity=t;const e=this.needsTransparent();return this.onOpacityUpdate&&this.onOpacityUpdate(t),e!==this._material.transparent}getOpacity(){return this.opacity}setTime(t){this.sharedState.renderingMode===U.f.Wireframe&&this.setMaterialsUniform({time:t})}setMeshPreviewSphere(t,e=.3){this.setMaterialsUniform({meshPreviewCenter:t,meshPreviewSize:e})}setWireframe(t){if(t){if(this.geometry.getIndex()){const t=this.geometry;t.boundsTree&&(t.boundsTree.geometry=this.geometry.clone()),this.geometry.copy(this.geometry.toNonIndexed())}(0,Z.tn)(this.geometry)}this.overrideCapability(K.d.Wireframe,t)}setFlatShading(t){t&&this.computeVertexNormals(),this.overrideCapability(K.d.FlatShading,t)}computeVertexNormals(){this.needsVertexNormalRecompute&&(this.geometry.computeVertexNormals(),this.needsVertexNormalRecompute=!1)}getCapabilities(){const t=new Set;for(const e in this.capabilityOverrides)this.capabilityOverrides[e]&&t.add(e);for(const e of tt)if(!t.has(e.key)&&e.enabled(this.uniformCache,this.sharedState)){t.add(e.key);for(const i of e.dependsOn)t.add(i)}return t}overrideCapability(t,e){this.capabilityOverrides[t]=e,this.updateMaterialCapabilities()}updateMaterialCapabilities(){const t=this.getCapabilities(),e=this.standardMaterial,i=this.needsTransparent();if((0,Q.Mq)(e.capabilities,t)&&i===e.transparent)return this._material;const s=this.getChunkMaterial(t,i);return this.standardMaterial=s,this.sharedState.renderingMode===U.f.Standard&&(this.material=s),this._material}getChunkMaterial(t,e){let i=`chunkMaterial_${this.sourceKey}`;for(const e of tt)i+=t.has(e.key)?"1":"0";const o=-1===this.meshGroup&&-1===this.meshSubgroup;i+=o?"f":e?"1":"0";const{chunkMaterials:n}=this.sharedState;if(!n[i]){const r=new q(i,t,this.getUniformsForCapabilities(t),(()=>o?s.BackSide:this.sharedState.side));o?(r.transparent=!0,r.depthWrite=!1):(r.transparent=e,r.depthWrite=!e),n[i]=r}return n[i]}getUniformsForCapabilities(t){const e={};for(const i of t){const t=$.f.uniforms[i];for(const i in t)e[i]=this.uniformCache[i]}return s.UniformsUtils.clone(e)}setMaterialsUniform(t,e=!1){let i,s=!1;for(const o in t){let n=!1;const r=t[o];if(!(o in this.uniformCache))throw new Error(`Uniform ${o} does not exist in Chunk`);const a=this.uniformCache[o],h=a.value;n="meshPreviewCenter"===o?n||null===h!=(null===r):"meshTrimMatrices"===o||(n||et.has(o)&&h!==r),a.value=j(a.value,r),"opacity"===o&&(i=r),e&&it.has(o)&&(this.sharedState.globalUniforms[o]=j(this.sharedState.globalUniforms[o],r)),s=s||n}return void 0!==i&&(s=this.setOpacity(i)||s),s&&this.updateMaterialCapabilities(),this._material}updateRenderingMode(){const{renderingMode:t,modeMaterials:e}=this.sharedState;t===U.f.Standard?this.material=this.standardMaterial:(t!==U.f.CeilingSample&&t!==U.f.FloorSample||this.computeVertexNormals(),this.material=e.get(t))}setProjectedPano(t,e,i,s,o=!1){let n=1===t?"pano1Map":"pano0Map";const r={};r[n]=s||Y,e&&(n=1===t?"pano1Position":"pano0Position",r[n]=e),i&&e&&(n=1===t?"pano1Matrix":"pano0Matrix",this.temp.m1.makeRotationFromQuaternion(this.temp.quat.copy(i).invert()),this.temp.m2.makeScale(-1,1,1),r[`${n}1`]=this.temp.m1,r[`${n}2`]=this.temp.m2),this.setMaterialsUniform(r,o)}setOverlayPano(t,e,i,o=!1){const n=`overlay${t}`,r={};if(e){this.temp.m3||(this.temp.m3=new s.Matrix4);const t=this.temp.m3.makeRotationFromQuaternion(e);r[n+"Matrix"]=t}r[n+"Map"]=i||Y,this.setMaterialsUniform(r,o)}onBeforeDraw(t){if(this.sharedState.renderingMode===U.f.Standard||this.sharedState.renderingMode===U.f.CeilingSample||this.sharedState.renderingMode===U.f.FloorSample){for(const e of Object.keys(t.uniforms))this.uniformCache[e]&&null!==this.uniformCache[e].value&&(t.uniforms[e].value=this.uniformCache[e].value);t.uniformsNeedUpdate=!0}}getSortKey(){var t,e,i;return null!==(i=null===(e=null===(t=this.uniformCache.map)||void 0===t?void 0:t.value)||void 0===e?void 0:e.id)&&void 0!==i?i:0}}const ot=new s.Vector3(0,0,0),nt=new s.Vector3(100,100,100),rt=new s.Vector3,at=new s.Vector3,ht=new s.Box3;class lt extends s.Mesh{constructor(t){super(),this.bounds=new s.Box3,this.geometry=new s.BoxGeometry(1,1,1),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.chunk=new st(-1,-1,this.geometry,t);const e=t=>{this.material=t};this.chunk.notifyOnMaterialUpdated(e),e(this.chunk.material),this.name="FallbackMesh",this.renderOrder=G.X.boundingSkybox,this.setFromCenterAndSize(ot,nt),this.onBeforeRender=(t,e,i,o,n,r)=>{n instanceof s.ShaderMaterial&&this.chunk.onBeforeDraw(n)}}setBounds(t){if(this.bounds.equals(t))return;this.bounds.copy(t);const e=t.getSize(rt);this.position.copy(t.getCenter(at)),this.scale.set(e.x,e.y,e.z),this.updateMatrixWorld(!0)}setFromCenterAndSize(t,e=nt){this.setBounds(ht.setFromCenterAndSize(t,e))}}var dt=i(44345),ct=i(95330),ut=i(92237);class mt{constructor(){this.allFloorsVisibleInOrtho=new ct.L(!0),this.floorOpacity=new n.E,this.globalOpacityModifier=new ct.L(1),this.meshTextureOpacity=new ut.z(1)}}class pt{constructor(t,e,i,o,n,r,a,h){this.container=t,this.mesh=e,this.meshData=i,this.sweepData=o,this.chunkSharedState=n,this.renderOptions=r,this.viewportManager=a,this.viewportState=new Map,this.chunkRenderingModeOverride=null,this.lastChunkRenderingModeOverride=null,this.fallbackMesh=null,this.overlayColors=[],this.meshGroupVisuals=new mt,this.overlayTextures=[{sweepId:void 0,texture:void 0,renderTarget:new s.WebGLCubeRenderTarget(2048,{format:s.RGBAFormat}),quaternion:new s.Quaternion},{sweepId:void 0,texture:void 0,renderTarget:new s.WebGLCubeRenderTarget(2048,{format:s.RGBAFormat}),quaternion:new s.Quaternion}],this.overlayEnabled=!1,this.bindings=[],this.updateFallbackMesh=(()=>{const t=new s.Box3;return e=>{if(this.fallbackMesh){if(this.sweepData.currentAlignedSweepObject&&this.viewmodeData.isInside()){const e=t.copy(this.meshData.extendedBounds).expandByScalar(.2);this.fallbackMesh.setBounds(e)}else this.cameraData&&this.fallbackMesh.setFromCenterAndSize(this.cameraData.pose.position);this.fallbackMesh.material&&(this.fallbackMesh.material.transparent=!(e<1e-5))}}})(),this.opacity=null,this.updateRenderState=()=>{if(this.viewmodeData.currentMode!==this.lastViewmode||this.lastChunkRenderingModeOverride!==this.chunkRenderingModeOverride){this.lastChunkRenderingModeOverride=this.chunkRenderingModeOverride;const t=this.viewmodeData.isInside();this.updateChunkMaterialMode(t,this.chunkRenderingModeOverride),this.lastViewmode=this.viewmodeData.currentMode}if(this.viewmodeData.transition.active&&(0,b.nI)(this.viewmodeData.transition.to)||this.viewmodeData.isInside())for(const t of this.viewportManager.viewports){const e=this.getViewportState(t.id),i=this.sweepData.getStateForViewport(t.id),s=i.currentSweep,o=i.transition,n=o.active&&(this.applicationData.phase===_.Jj.PLAYING||this.applicationData.phase===_.Jj.STARTING),r=n?o.from:s,a=n?o.to:s,h=e.currentSweepId,l=e.targetSweepId;if(e.currentSweepId=r||null,e.targetSweepId=a||null,this.handleSweepChange(0,h,e.currentSweepId,e),this.handleSweepChange(1,l,e.targetSweepId,e),this.overlayEnabled){const t=this.overlayTextures.find((t=>t.sweepId===e.currentSweepId)),i=this.overlayTextures.find((t=>t.sweepId===e.targetSweepId));let s=!0;for(const e of this.allChunks())e.setOverlayPano(0,t?t.quaternion:void 0,t?t.texture:void 0,s),e.setOverlayPano(1,i?i.quaternion:void 0,i?i.texture:void 0,s),s=!1}}},this.debugColorizeChunks=(()=>{let t=!1;return(e,i)=>{const o=new s.Vector4(1,1,1,0);t=!t,(t=>{for(const e of this.mesh.chunks){const s=i?100*e.id:100*e.meshSubgroup,n=t?(0,z.Zd)(.5,s):o;e.setColorOverlay(n)}})(e||t)}})(),this.container.add(this.mesh),h&&(this.fallbackMesh=new lt(this.chunkSharedState),this.fallbackMesh.layers.mask=this.container.layers.mask,this.container.add(this.fallbackMesh))}init(){}dispose(){this.container.remove(this.mesh),this.fallbackMesh&&this.container.remove(this.fallbackMesh)}async activate(t){[this.applicationData,this.viewmodeData,this.settings,this.cameraData,this.renderer]=await Promise.all([t.market.waitForData(_.zH),t.market.waitForData(D.X),t.market.waitForData(L.o),t.market.waitForData(g.M),t.getModuleBySymbol(h.M7)]),this.panoRenderer=(await t.getModuleBySymbol(h.qD)).getRenderer(),this.updateRenderState(),this.bindings.push(this.viewmodeData.onChanged(this.updateRenderState),this.sweepData.onChanged(this.updateRenderState),this.settings.onSettingChanged(X._Z,(t=>this.toggleWireframe(t))),this.settings.onChanged(this.updateRenderState)),this.bindings.push(this.mesh.notifyOnChunksLoaded((e=>{for(const t of this.overlayColors)t(e);t.msgBus.broadcast(new dt.qZ)}))),this.renderOptions.colorizeRooms&&this.debugColorizeChunks(!0),this.renderOptions.colorizeChunks&&this.debugColorizeChunks(!0,!0),this.renderOptions.wireframe&&this.toggleWireframe(!0);const e=[...this.meshData.meshGroups.floors.keys()].sort();for(const t of e)this.meshGroupVisuals.floorOpacity.set(`${t}`,1)}deactivate(){for(const t of this.bindings)t.cancel();this.bindings=[];for(const t of this.viewportState.values())t.currentSweepId&&this.panoRenderer.freeTexture(t.currentSweepId);this.viewportState.clear()}updateSweepRenderTarget(t,e,i,s,o){const n=this.panoRenderer.useTexture(e);if(n){const e=o.slotInfo[t];e.texture=n,e.position.copy(i),e.rotation.copy(s);let r=!0;for(const e of this.allChunks())e.setProjectedPano(t,i,s,n,r),r=!1}}*allChunks(){yield*this.mesh.chunks,this.fallbackMesh&&(yield this.fallbackMesh.chunk)}updateExistingTexture(t,e,i,s){for(const i of this.viewportState.values())i.currentSweepId===t?i.slotInfo[0].texture=e:i.targetSweepId===t&&(i.slotInfo[1].texture=e)}beforeRenderViewport(t){var e,i,s;const{floorOpacity:o,globalOpacityModifier:n,meshTextureOpacity:r}=this.meshGroupVisuals;for(const t of this.mesh.visibleChunks){const i=(null!==(e=o.get(`${t.meshGroup}`))&&void 0!==e?e:1)*n.value;t.setMaterialsUniform({meshOpacity:r.value,panoOpacity:1-r.value,opacity:null!==this.opacity?this.opacity:i,progress:this.sweepData.state.transition.progress.value})}const a=(0,c.p_)(r.value,0,1,1);null===(i=this.fallbackMesh)||void 0===i||i.chunk.setMeshTextureOpacity(a),null===(s=this.fallbackMesh)||void 0===s||s.chunk.setProgress(this.sweepData.state.transition.progress.value),this.updateFallbackMesh(a);const h=this.getViewportState();let l=!0;for(const t of this.allChunks())t.setProjectedPano(0,h.slotInfo[0].position,h.slotInfo[0].rotation,h.slotInfo[0].texture,l),t.setProjectedPano(1,h.slotInfo[1].position,h.slotInfo[1].rotation,h.slotInfo[1].texture,l),l=!1}render(){}beforeRender(){}updateChunkMaterialMode(t,e){const i=t?s.DoubleSide:s.FrontSide;this.chunkSharedState.side=i,this.chunkSharedState.renderingMode=e||U.f.Standard;for(const t of this.mesh.chunks)t.updateRenderingMode()}handleSweepChange(t,e,i,s){if(e!==i&&(e&&this.panoRenderer.freeTexture(e),i)){const e=this.sweepData.getSweep(i);this.updateSweepRenderTarget(t,i,e.position,e.rotation,s)}}async onPanoOverlayCommand(t){this.overlayEnabled=!0;const e=e=>{const i=e.renderTarget;e.renderTarget.width=t.texture.image.width,e.renderTarget.height=t.texture.image.height,e.sweepId=t.sweepId,e.texture=i.texture,e.quaternion=t.quaternion,this.renderer.cwfRenderer.copyCubemap(t.texture,e.renderTarget)};let i=!1;for(const s of this.overlayTextures)i||s.sweepId!==t.sweepId||(e(s),i=!0);const o=Array.from(this.viewportState.values()).map((t=>[t.currentSweepId,t.targetSweepId])).flat();for(const t of this.overlayTextures)i||t.sweepId&&o.includes(t.sweepId)||(e(t),i=!0);if(!i){const t={sweepId:void 0,texture:void 0,renderTarget:new s.WebGLCubeRenderTarget(2048,{format:s.RGBAFormat}),quaternion:new s.Quaternion};e(t),this.overlayTextures.push(t)}this.updateRenderState()}setMeshOverlay(t="all",e="explicit",i,o,n=-1){let r=()=>!0;switch(t){case"all":r=()=>!0,this.overlayColors.length=0;break;case"byMeshGroup":r=t=>t.meshGroup===n;break;case"byMeshSubGroup":r=t=>t.meshSubgroup===n}if(!r)return;let a="rand";"explicit"===e&&(a=i?new s.Vector4(i.x,i.y,i.z,i.w):null);const h=t=>{for(const e of t)-1!==e.meshGroup&&r(e)&&e.setColorOverlay("rand"===a?(0,z.Zd)(o):a)};h([...this.allChunks()]),"all"===t&&null===a||this.overlayColors.push(h)}setChunkRenderingMode(t){this.chunkRenderingModeOverride=t,this.updateRenderState()}toggleWireframe(t){for(const e of this.mesh.chunks)e.setWireframe(t)}onUpdate(t){this.meshGroupVisuals.meshTextureOpacity.active&&(this.viewmodeData.transition.active?(this.meshGroupVisuals.meshTextureOpacity.updateProgress(this.viewmodeData.transition.progress),this.meshGroupVisuals.meshTextureOpacity.commit()):(this.meshGroupVisuals.meshTextureOpacity.tick(t),this.meshGroupVisuals.meshTextureOpacity.commit()))}getViewportState(t){var e;const i=t||(null===(e=this.viewportManager.renderingViewport)||void 0===e?void 0:e.id)||this.viewportManager.activeViewport.id||this.viewportManager.defaultViewport.id;let o=this.viewportState.get(i);return o||(o={currentSweepId:null,targetSweepId:null,slotInfo:[{position:new s.Vector3,rotation:new s.Quaternion},{position:new s.Vector3,rotation:new s.Quaternion}]},this.viewportState.set(i,o)),o}}var gt=i(97084),ft=i(244),wt=i(66726),vt=i(3249),yt=i(40397),Dt=i(65936),bt=i(596),Mt=i(3350);class St{constructor(t,e,i=W.X.Standard,s){this.textureName=t,this.mesh=e,this.lod=i,this.chunkedTexInfo=s,this.chunks=new Set,this.loading=!1,this.unloaded=!1,this.screenCoverage=0,this.screenCoverageScore=0,this.sightings=new Mt.C(X.xT.sightingMaxAge),s&&(this.textureQualityMap.registerQualities(i,s.maxTextureSize,s.maxTexelSize,s.minScale),this.quality=this.textureQualityMap.min(i),this.targetQuality=this.quality),this.minQuality=this.textureQualityMap.min(i),this.maxQuality=this.minQuality}get textureQualityMap(){return this.mesh.textureQualityMap}setTexture(t){const e=this.texture;if(this.texture=t,e&&e!==t&&e.dispose(),t)for(const e of this.chunks)e.setMeshTexture(t)}getEmbeddedTexture(){var t;const e=null===(t=this.chunks.entries().next())||void 0===t?void 0:t.value;return e?e[0].embeddedTexture:void 0}}class Tt{constructor(t,e,i=.85){this.renderer=t,this.maxBudget=e,this.pctTotalMemory=i,this.slots=[],this.lods=new Map,this.orders={},this.slotTexSizes=new Map}dispose(){this.slots=[],this.lods.clear(),this.orders={}}update(t){this.updateBudget(void 0),this.updateTargetQualitiesFromBudget()}updateBudget(t){if(t){this.dispose();const e=new Map;this.slots=t,t.forEach((t=>{const i=this.lods.get(t.lod)||new Set;i.add(t),this.lods.set(t.lod,i);const s=e.get(t.lod)||new Set;t.textureQualityMap.order(t.lod).forEach((t=>s.add(t))),e.set(t.lod,s)}));for(const t of e.keys()){const i=e.get(t);i&&(this.orders[t]=Array.from(i.values()).sort())}}if(this.shouldRestrictBudget()){const t=this.calcCurrentTexturesSize(),e=this.renderer.estimatedGPUMemoryAllocated()-t,i=this.maxBudget()-e;this.budget=i*this.pctTotalMemory}else this.budget=1/0;return this}updateTargetQualitiesFromBudget(){let t=0;for(const e of this.slots)this.updateBudgetSize(e),e.targetQuality=e.minQuality,t+=this.getBudgetSize(e,e.targetQuality);const e=(e,i)=>e.maxQuality<i||!e.textureQualityMap.valid(i)||(t-=this.getBudgetSize(e,e.targetQuality),t+=this.getBudgetSize(e,i),!(t>this.budget)&&(e.targetQuality=i,!0));if(this.shouldRestrictBudget()){for(const t of this.slots)for(const i of this.orders[t.lod])if(!e(t,i))return}else for(const[t,i]of this.lods.entries())for(const s of this.orders[t])for(const t of i)if(!e(t,s))return}shouldRestrictBudget(){return this.maxBudget()!==1/0}getBudgetSize(t,e){if(!e)return 0;const i=t.textureQualityMap.get(e);let s=0;if(t){const i=t.textureQualityMap.min(t.lod);i!==e&&t.getEmbeddedTexture()&&(s=this.getBudgetSize(t,i));const o=t.textureName+e,n=this.slotTexSizes.get(o);if(n)return n+s}return(i?i.textureSize:4096)**2*4+s}updateBudgetSize(t){var e;const i=t.textureName+t.quality,s=null!==(e=t.texture)&&void 0!==e?e:t.getEmbeddedTexture();this.slotTexSizes.set(i,this.texSizeBytes(s))}calcCurrentTexturesSize(){return this.slots.reduce(((t,e)=>{var i;const s=e.getEmbeddedTexture(),o=null!==(i=e.texture)&&void 0!==i?i:s;return o===s?t+this.texSizeBytes(o):t+this.texSizeBytes(o)+this.texSizeBytes(s)}),0)}texSizeBytes(t){var e;if(!t)return 0;if(null===(e=t.mipmaps)||void 0===e?void 0:e.length){let e=0;for(const i of t.mipmaps)if("data"in i)e+=i.data.length;else{const{width:t,height:s}="image"in i?i.image:i;e+=t*s*4}return e}let i=t.image.width*t.image.height*4,s=i/4;for(;s>=1;)i+=s,s/=4;return i}}const xt=new d.Ay("tex-lod");class Pt{constructor(t,e,i,s,o,n,r){this.textureLOD=t,this.api=e,this.camera=i,this.renderToTextureModule=s,this.engine=o,this.chunkVisibilityChecker=n,this.rendererModule=r,this.name="texture-streaming",this.limitMemoryUsage=!1,this.allocatedMegsBeforeLimitingLod=350,this.slots=[],this.textureKeyToSlot={},this.chunkSourceToMesh=new Map,this.meshes=new Map,this.chunkIdToSlot={},this._systemMin=bt.M.LOW,this._systemMax=bt.M.ULTRA,this.meshMinMax=new Map,this.allowTextureDownload=()=>!0,this.concurrentLoadingTextures=1,this.concurrentDownloadingTiles=12,this.autoLoadTiles=!1,this.lastSortedAt=0,this.loadingTextures=0,this.downloadingTiles=0,this.totalTextures={},this.totalTiles=0,this.abortController=new AbortController,this.bindings=[],this.textureApiInfo=new Map,this._chunkSlotsSet=new Set,this.loadImage=async(t,e,i,s,o)=>{var n;const r=t.textureQualityMap.get(e),{assetType:a,lod:h}=r,l=(null===(n=t.chunkedTexInfo)||void 0===n?void 0:n.maxTextureSize)||r.assetSize;let d,c=t.textureName;if(this.textureApiInfo){if(!t.chunkedTexInfo){const t=c.match(/[_.]([0-9]{3})[_.]/);if(!t)throw new Error(`Could not parse texture index from texture name: ${c}`);c=t[1]}const e=this.textureApiInfo.get(t.mesh);if(!e)throw new Error(`No texture URLs found for mesh: ${t}`);d=(await e[a].get()).urlTemplate.replace("<folder>",`${h}`).replace("<texture>",c)}else{const t=c.match(/^([a-f0-9]+(_10k|_50k)?)/);if(!t)throw new Error(`Unknown format for texture name: ${c}`);d=`${t[0]}_texture_jpg_${a}/${c}`}const{sourceSize:u=l,sourceX:m=0,sourceY:p=0,destSize:g=u}=s,f={};return g!==u&&(f.width=`${g}`),u!==l&&(f.crop=`${u},${u},x${m/l},y${p/l}`),d=(0,wt.Gm)(d,f),i.getImageBitmap(d,g,g,o)},this.textureBudgeter=new Tt(this.rendererModule,(()=>this.limitMemoryUsage?this.allocatedMegsBeforeLimitingLod*2**20:1/0)),this.bindings.push(this.chunkVisibilityChecker.notifyOnNewSighting(((t,e)=>{const i=this.chunkSourceToMesh.get(t.sourceKey);if(i){const s=this.addChunkSlots(i,[t]);for(const t of s)t.sightings.push(e)}})))}setModel(t,e,i){if(this.textureApiInfo.set(t,i),0===e.length)throw new Error("Chunks required");this.addChunkSlots(t,[...e]),this.textureBudgeter.updateBudget(this.slots),this.updateSystemQualityRanges()}clearSlots(){this.abortController.abort(),this.slots.forEach((t=>{this.removeChunks([...t.chunks])})),this.abortController=new AbortController}dispose(){this.abortController.abort(),this.bindings.forEach((t=>t.cancel())),this.bindings.length=0,this.clearSlots(),this._chunkSlotsSet.clear(),this.textureBudgeter.dispose(),this.textureApiInfo.clear()}addChunkSlots(t,e){const i=this.meshes.get(t)||0;this.meshes.set(t,i+e.length),e.forEach((e=>{this.chunkSourceToMesh.set(e.sourceKey,t)})),this._chunkSlotsSet.clear();let s=!1;for(const i of e){const e=i.textureName;let o=this.textureKeyToSlot[i.textureCacheKey];o||(s=!0,o=new St(e,t,i.lod,i.textureLODInfo),i.embeddedTexture&&o.setTexture(i.embeddedTexture),this.textureKeyToSlot[i.textureCacheKey]=o,this.slots.push(o)),o.chunks.has(i)||(s=!0,o.chunks.add(i),o.texture&&i.setMeshTexture(o.texture)),this._chunkSlotsSet.add(o),this.chunkIdToSlot[i.id]=o}return s&&this.textureBudgeter&&(this.textureBudgeter.updateBudget(this.slots),this.updateSystemQualityRanges()),this._chunkSlotsSet}removeChunks(t){var e;for(const i of t){const t=this.chunkIdToSlot[i.id];if(!t){xt.error("Missing slot for chunk!",i.id,i.textureCacheKey,i);continue}if(t.chunks.delete(i),0===t.chunks.size){t.unloaded=!0,t.setTexture(null);const e=this.slots.indexOf(t);this.slots.splice(e,1),delete this.textureKeyToSlot[i.textureCacheKey]}delete this.chunkIdToSlot[i.id];const s=this.chunkSourceToMesh.get(i.sourceKey);if(s){(null!==(e=this.meshes.get(s))&&void 0!==e?e:1)-1<=0&&(this.meshes.delete(s),this.meshMinMax.delete(s.textureQualityMap))}this.chunkSourceToMesh.delete(i.sourceKey)}}setQuality(t,e){this._systemMin=t,this._systemMax=e,this.updateSystemQualityRanges()}updateSystemQualityRanges(){this.meshMinMax.clear();for(const t of this.meshes.keys()){const e=t.textureQualityMap.lods(),i={min:{},max:{}};for(const s of e)i.min[s]=t.textureQualityMap.nearestQuality(s,this._systemMin),i.max[s]=t.textureQualityMap.nearestQuality(s,this._systemMax);this.meshMinMax.set(t.textureQualityMap,i)}for(const t of this.slots){const e=this.meshMinMax.get(t.textureQualityMap);e?(t.minQuality=e.min[t.lod],t.maxQuality=t.maxQuality?Math.min(e.max[t.lod],t.maxQuality):e.max[t.lod]):xt.error("Missing min/max lod for slot")}}get textureCount(){return this.slots.length}async loadAll(t,e){const i=this.slots.filter((e=>e.mesh===t));i[0]&&i[0].textureName&&await this.loadSlots(i,e)}async loadSlots(t,e=(t.length>0?t[0].textureQualityMap.min(W.X.Standard):W.X.Standard)){if(!t.length)return;const i=t[0].textureQualityMap;i.valid(e)?await Promise.all(t.map((t=>this.loadTexture(t,e,!1)))):xt.warn(e,"not found in",i)}onWebGLContextLost(){this.abortController.abort();for(const t of this.slots)t.texture=null}onWebGLContextRestored(){this.abortController=new AbortController;for(const t of this.slots)this.loadTexture(t,t.quality)}async loadTexture(t,e,i=!0){var s,o;const n=t.textureQualityMap;n.valid(e)||xt.warn(e,"not found in",n);const r=n.get(e),a=(null===(s=t.chunkedTexInfo)||void 0===s?void 0:s.maxTextureSize)||r.assetSize,h=Math.min(a,r.textureSize);t.lastLoadedAt=performance.now();let l=t.texture;if(!l||e!==t.quality)if(l&&e<t.quality&&t.texture){const i=null===(o=t.chunks.values().next().value)||void 0===o?void 0:o.embeddedTexture;if(i&&i.image.width>=h&&i.mipmaps[0].data.length<=h*h*4)t.quality=e,t.setTexture(i);else{const i=this.renderToTextureModule.resizeTexture(l,h);Ct(i,t),t.quality=e,t.setTexture(i)}this.engine.msgBus.broadcast(new dt.Ny)}else{t.loading=!0,this.loadingTextures++,this.totalTextures[h]=(this.totalTextures[h]||0)+1;try{l=this.textureLOD!==E.R.NONE&&i?await this.loadTextureTiled(h,e,t,this.abortController.signal):await this.loadTextureSolid(h,e,t,this.abortController.signal),t.unloaded?l.dispose():(Ct(l,t),t.setTexture(l),this.engine.msgBus.broadcast(new dt.Gf))}catch(t){}finally{this.loadingTextures--,t.quality=e,t.loading=!1}}}async loadTextureTiled(t,e,i,o){var n;const r=this.rendererModule.cwfRenderer,a=r.initSizedTexture2D(t,{generateMipmaps:!1,minFilter:s.LinearFilter,magFilter:s.LinearFilter}),h=i.textureQualityMap,l=(null===(n=i.chunkedTexInfo)||void 0===n?void 0:n.maxTextureSize)||h.get(e).assetSize,d=Math.min(l,h.get(e).textureSize),c=Math.min(d,h.get(e).tileSize),u=async(t,s)=>{let n;this.downloadingTiles+=1,this.totalTiles+=1;const h=i.mesh.flipDownload;try{n=await this.loadImage(i,e,this.api,{sourceSize:l*(c/d),sourceX:l*(t/d),sourceY:l*(s/d),destSize:c},{priority:gt.QK.LOW,flipY:h,signal:o})}finally{this.downloadingTiles-=1}const u=t,m=i.mesh.flipUpload?d-s-c:s,p=new Dt.m("mesh/texture/upload-tiles",(()=>this.engine.after(ft.R.End).then((()=>{if(o.aborted)throw new DOMException("Aborted","AbortError");a.flipY=h&&n instanceof HTMLImageElement,r.uploadTexture2D(n,a,u,m)}))),100);return(await this.engine.commandBinder.issueCommand(p)).promise.finally((()=>{var t,e;n&&(null===(e=(t=n).close)||void 0===e||e.call(t))}))},m=[];for(let t=0;t<d;t+=c)for(let e=0;e<d;e+=c)m.push(u(t,e));try{await Promise.all(m)}catch(t){throw a.dispose(),t}return a}async loadTextureSolid(t,e,i,s){var o,n;const r=this.rendererModule.cwfRenderer,a=r.initSizedTexture2D(t);let h=null;try{const t=i.textureQualityMap.get(e).textureSize,o=i.mesh.flipDownload;h=await this.loadImage(i,e,this.api,{destSize:t},{priority:gt.QK.LOW,flipY:o,signal:s}),a.flipY=o&&h instanceof HTMLImageElement,r.uploadTexture2D(h,a,0,0)}catch(t){throw a.dispose(),t}finally{h&&(null===(n=(o=h).close)||void 0===n||n.call(o))}return a}setImageLoader(t){this.loadImage=t}analyzeTextureScreenCoverageFromRaycasts(){const t=this.rendererModule.cwfRenderer.getSize().x,e=this.camera.getWorldPosition(new s.Vector3);for(const i of this.slots){i.screenCoverage=0,i.screenCoverageScore=0,i.maxQuality=i.minQuality;const s=i.sightings.getList(),o=i.sightings.index-1;for(let n=0;n<s.length;n++){const r=s[(o-n+s.length)%s.length];if(r.raycastAge<this.chunkVisibilityChecker.raycastCounter-X.Ay.sightingMaxAge)break;const a=e.distanceTo(r.point),h=(0,yt.ff)(a,this.camera.projectionMatrix,t);let l=i.textureQualityMap.fromPixelSize(i.lod,h);const d=this.meshMinMax.get(i.textureQualityMap);l=Math.min(l,d?d.max[i.lod]:this._systemMax),i.screenCoverageScore+=l,i.screenCoverage+=1,i.maxQuality=Math.max(l,i.maxQuality)}}this.slots.sort(((t,e)=>e.screenCoverageScore-t.screenCoverageScore)),this.textureBudgeter.updateTargetQualitiesFromBudget()}update(t){if(!this.camera||!this.autoLoadTiles||this.abortController.signal.aborted)return;this.textureBudgeter.update(t);const e=performance.now();this.textureLOD===E.R.RAYCAST&&this.scheduleRaycastTasks(e);let i=!1;for(let t=this.slots.length-1;t>=0;t--){const s=this.slots[t],o=(0,vt.qE)(s.targetQuality,s.minQuality,s.maxQuality),n=e-s.lastLoadedAt<1e3;if(!s.loading&&s.quality>o){n?i=!0:this.loadTexture(s,o);break}}if(this.allowTextureDownload()&&!i)for(const t of this.slots){if(this.loadingTextures>=this.concurrentLoadingTextures||this.downloadingTiles>=this.concurrentDownloadingTiles)break;const e=(0,vt.qE)(t.targetQuality,t.minQuality,t.maxQuality);!t.loading&&t.quality<e&&this.loadTexture(t,t.textureQualityMap.moreDetailed(t.lod,t.quality))}}scheduleRaycastTasks(t){if(!this.analyzeTaskPromise&&t-this.lastSortedAt>200){const t=()=>{this.analyzeTextureScreenCoverageFromRaycasts(),this.lastSortedAt=performance.now()},e=async t=>{await t.promise,this.analyzeTaskPromise=null},i=new Dt.m("mesh/texture/analyze-screen-coverage",t,100);this.analyzeTaskPromise=this.engine.commandBinder.issueCommand(i).then(e)}}}function Ct(t,e){t.addEventListener("dispose",(()=>{t===e.texture&&xt.warn("Streamed texture disposed while still in use")}))}var Bt=i(21100),Ft=i(6687),Ot=i(99276),At=i(14971);const kt=Math.round(X.Ay.sightingMaxAge/60/5)||1;class It{resetCounter(){this.lastReset=this.raycastCounter}constructor(t,e,i,o){this.scene=t,this.raycaster=e,this.pose=i,this.viewportManager=o,this.raycastCounter=0,this.onNewSighting=new Set,this.lastReset=0,this.raycastRandomScreenLocation=(()=>{const t=new s.Vector3,e=new s.Vector3,i=new s.Vector3;function o(t){return!!((0,Ft.aV)(t)&&t instanceof Ot.B)&&t.chunks.some((t=>t.getOpacity()>X.u7.FADE_TILE_VISIBLE_THRESHOLD))}return(s,n,r)=>{this.raycastCounter++;const a=(2-2*n)/s,h=-1+n,l=this.raycastCounter%(s*s),d=l%s,c=h+(l-d)/s*a,u=h+d*a+Math.random()*a,m=c+Math.random()*a,p=this.viewportManager.viewports.map((t=>t.camera));for(const s of p){t.set(u,m,-1).unproject(s),e.set(u,m,1).unproject(s),i.subVectors(e,t).normalize();const n=this.raycaster.pick(t,i,o);if(n){if(n.face&&n.object instanceof Ot.B){const t=n.object.getChunk(n.face.materialIndex),e={point:n.point.clone(),raycastAge:this.raycastCounter};for(const i of this.onNewSighting.values())i(t,e)}r&&r(n)}}}})()}update(){const t=X.Ay.debugLOD?(0,At.rt)(65280,this.scene,this.pose):void 0,e=performance.now();for(let i=0;i<kt&&performance.now()-e<.5&&this.raycastCounter<=this.lastReset+X.Ay.sightingMaxAge;i++)this.raycastRandomScreenLocation(5,.05,t)}notifyOnNewSighting(t){return(0,H.Sh)((()=>this.onNewSighting.add(t)),(()=>this.onNewSighting.delete(t)),!0)}}var Vt=i(32024);const Et=i.p+"images/uv_grid_opengl.jpg",Rt=t=>new s.RawShaderMaterial({fragmentShader:$.A.ceilingProcess.fragmentShader,vertexShader:$.A.ceilingProcess.vertexShader,transparent:!0,defines:t,uniforms:s.UniformsUtils.clone($.A.ceilingProcess.uniforms),side:s.BackSide,name:"materialFloorProcess",stencilRef:1,stencilFuncMask:65535,stencilWrite:!0,stencilFunc:s.EqualStencilFunc,stencilFail:s.KeepStencilOp,stencilZFail:s.KeepStencilOp,stencilZPass:s.KeepStencilOp,blending:s.MultiplyBlending});class Nt{constructor(){this.materials=new Map}get(t){let e=this.materials.get(t);return e||(e=_t[t](),this.materials.set(t,e)),e}}const _t={[U.f.Depth](){const t=s.UniformsUtils.clone($.A.depth.uniforms);return new s.ShaderMaterial({fragmentShader:$.A.depth.fragmentShader,vertexShader:$.A.depth.vertexShader,uniforms:t,side:s.FrontSide,name:"materialDepth"})},[U.f.Transparent](){const t=s.UniformsUtils.clone($.A.modelOutside.uniforms);return t.opacity.value=.2,t.colorOverlay.value.set(1,1,1,1),new s.ShaderMaterial({fragmentShader:$.A.modelOutside.fragmentShader,vertexShader:$.A.modelOutside.vertexShader,uniforms:t,side:s.FrontSide,transparent:!0,name:"materialTransparent"})},[U.f.Wireframe](){const t=s.UniformsUtils.clone($.A.modelOutside.uniforms);return t.opacity.value=.5,t.colorOverlay.value.set(1,1,1,1),new s.ShaderMaterial({fragmentShader:$.A.modelOutside.fragmentShader,vertexShader:$.A.modelOutside.vertexShader,uniforms:t,side:s.FrontSide,transparent:!0,wireframe:!0,name:"materialWireframe"})},[U.f.UV]:()=>new s.MeshBasicMaterial({name:"uv-debug",map:(0,Vt.y)(Et)}),[U.f.CeilingSample]:()=>Rt({CEILING_SAMPLE:!0}),[U.f.FloorSample]:()=>Rt({FLOOR_SAMPLE:!0})};class Lt{constructor(){this.side=s.FrontSide,this.renderingMode=U.f.Standard,this.chunkMaterials={},this.modeMaterials=new Nt,this.globalUniforms={}}forEachChunkMaterial(t){const{chunkMaterials:e}=this;for(const i in e)t(e[i])}dispose(){const{chunkMaterials:t}=this;for(const e in t){const i=t[e];for(const t in i.uniforms)i.uniforms[t].value instanceof s.Texture&&i.uniforms[t].value.dispose();i.dispose(),delete t[e]}}}var zt=i(84710),Ut=i(12554);const Gt=new d.Ay("MeshTrimData");class Ht extends zt.B{constructor(){super(),this.name="mesh-trim-data",this.numberOfTrims=0,this.meshTrimsByMeshGroup=new n.E,this.meshTrimsById=new n.E,this.onMeshGroupChangedCallbacks=new Set,this.onMeshTrimChangedCallbacks=new Set,this.updateMeshTrim=t=>{for(const e of this.onMeshTrimChangedCallbacks)e(t)},this.notifyMeshGroupChanges=t=>{for(const e of this.onMeshGroupChangedCallbacks)e(t)},this.meshTrimsByMeshGroup.set(`${w.Zu}`,new Ut.X)}addMeshGroups(t){for(const e of t)if(!this.meshTrimsByMeshGroup.has(`${e}`)){const t=new Ut.X;this.meshTrimsByMeshGroup.set(`${e}`,t)}this.singleFloorMeshGroup||1!==t.length||(this.singleFloorMeshGroup=t[0])}add(...t){const e=new Set;this.meshTrimsById.atomic((()=>{this.meshTrimsByMeshGroup.atomic((()=>{for(const i of t){void 0!==this.singleFloorMeshGroup&&(i.meshGroup=this.singleFloorMeshGroup);const t=`${i.meshGroup}`;this.meshTrimsByMeshGroup.has(t)||this.meshTrimsByMeshGroup.set(t,new Ut.X);this.meshTrimsByMeshGroup.get(t).push(i),this.meshTrimsById.set(i.id,i),e.add(i.meshGroup),i.onChanged(this.updateMeshTrim)}}))})),e.forEach((t=>{const e=this.meshTrimsByMeshGroup.get(`${t}`);this.sortList(e),this.reassignIndexes(e),this.notifyMeshGroupChanges(t)})),this.updateDerivedProperties()}delete(...t){const e=new Set;this.meshTrimsByMeshGroup.atomic((()=>{for(const i of t){const t=this.meshTrimsByMeshGroup.get(`${i.meshGroup}`),s=t.indexOf(i);if(s>=0){t.splice(s,1)[0].enabled=!1,e.add(i.meshGroup),i.removeOnChanged(this.updateMeshTrim)}else Gt.error("Could not delete mesh trim:"+i.id)}})),e.forEach((t=>{const e=this.meshTrimsByMeshGroup.get(`${t}`);this.reassignIndexes(e),this.notifyMeshGroupChanges(t)})),this.meshTrimsById.atomic((()=>{t.forEach((t=>{this.meshTrimsById.delete(t.id)}))})),this.updateDerivedProperties()}updateDerivedProperties(){this.numberOfTrims=this.meshTrimsById.length,this.commit()}onMeshGroupChanged(t){return(0,H.Sh)((()=>this.onMeshGroupChangedCallbacks.add(t)),(()=>this.onMeshGroupChangedCallbacks.delete(t)))}onMeshTrimChanged(t){return(0,H.Sh)((()=>this.onMeshTrimChangedCallbacks.add(t)),(()=>this.onMeshTrimChangedCallbacks.delete(t)))}getTrimById(t){return this.meshTrimsById.get(t)||null}getTrim(t,e){return this.meshTrimsByMeshGroup.has(`${t}`)?this.meshTrimsByMeshGroup.get(`${t}`).get(e):null}getTrimsForMeshGroup(t){return this.meshTrimsByMeshGroup.has(`${t}`)?this.meshTrimsByMeshGroup.get(`${t}`).values():[]}getAllMeshGroups(){return this.meshTrimsByMeshGroup.keys}*activeTrimsForMeshGroup(t){if(this.meshTrimsByMeshGroup.has(`${t}`))for(const e of this.meshTrimsByMeshGroup.get(`${t}`))e.enabled&&(yield e);if(this.meshTrimsByMeshGroup.has(`${w.Zu}`))for(const t of this.meshTrimsByMeshGroup.get(`${w.Zu}`))t.enabled&&(yield t)}isPointTrimmed(t,e){const i=e=>e.containsPoint(t);return this.isShapeTrimmed(Object.assign({intersectsOBB:i,isInsideOBB:i},e))}isSegmentTrimmed(t,e,i){const o=new s.Ray,n=new s.Vector3;return this.isShapeTrimmed(Object.assign({intersectsOBB:i=>{if(i.containsPoint(t)||i.containsPoint(e))return!0;o.origin.copy(t),o.direction.subVectors(e,t).normalize();const s=i.intersectRay(o,n);return!!s&&t.distanceToSquared(s)<=t.distanceToSquared(e)},isInsideOBB:i=>i.containsPoint(t)&&i.containsPoint(e)},i))}isShapeTrimmed({intersectsOBB:t,isInsideOBB:e,panoMode:i,meshGroup:s}){let o=void 0===s?this.meshTrimsById.values.filter((t=>t.enabled)):[...this.activeTrimsForMeshGroup(s)];i&&(o=o.filter((t=>t.activeInPanoMode)));let n=!1,r=!1;for(const i of o)if(i.discardContents){if(t(i.getOBB()))return!0}else n=n||e(i.getOBB()),r=!0;return!!r&&!n}reassignIndexes(t){t.forEach(((t,e)=>{t.index=e}))}sortList(t){t.sort(((t,e)=>t.index-e.index))}}class Qt extends o.n{constructor(){super(...arguments),this.name="model-mesh",this.commands={MeshPreviewSetPositonCommand:A.P,SetPanoOverlayCommand:I},this.meshTrimData=new Ht,this.inactiveMeshes=new Map,this.meshes=new n.E,this.meshesLoaded=0,this.meshLoadPromises=new Map,this._firstMeshLoadPromise=new r.i,this._renderMode=V.p.Hidden,this.onPanoOverlayCommand=t=>{for(const e of this.allMeshes())e.renderer.onPanoOverlayCommand(t)},this.meshTrimUpdateRenderMode=t=>{this.meshTrimUniforms&&t!==this.meshTrimUniforms.isPanoMode&&(this.meshTrimUniforms.isPanoMode=t,this.meshTrimUpdate(-1))},this.meshTrimFilter=t=>!(this.meshTrimData&&this.viewmodeData&&(0,Ft.dW)(t.object))||!this.meshTrimData.isPointTrimmed(t.point,{panoMode:this.viewmodeData.isPano(),meshGroup:t.object.meshGroup})}get firstMeshLoadPromise(){return this._firstMeshLoadPromise.nativePromise()}getMeshLoadPromise(t){return this.meshLoadPromises.get(t)||null}onActiveMeshesChanged(t){return this.meshes.onElementsChanged(t)}*allMeshes(){yield*this.meshes.values,yield*this.inactiveMeshes.values()}getAllMeshes(){const t=[];for(const e of this.allMeshes())t.push(e.modelMesh);return t}getMesh(t){var e,i;return(null===(e=this.meshes.get(t))||void 0===e?void 0:e.modelMesh)||(null===(i=this.inactiveMeshes.get(t))||void 0===i?void 0:i.modelMesh)||null}getMeshGroupVisuals(t){var e,i,s,o,n;return t?(null===(i=null===(e=this.meshes.get(t))||void 0===e?void 0:e.renderer)||void 0===i?void 0:i.meshGroupVisuals)||(null===(o=null===(s=this.inactiveMeshes.get(t))||void 0===s?void 0:s.renderer)||void 0===o?void 0:o.meshGroupVisuals)||null:0===this.meshes.length?null:null!==(n=this.meshes.values[0].renderer.meshGroupVisuals)&&void 0!==n?n:null}hasMesh(t){return this.meshes.has(t)||this.inactiveMeshes.has(t)||this.meshLoadPromises.has(t)}async init(t,e){O||(s.Mesh.prototype.raycast=C,s.BufferGeometry.prototype.computeBoundsTree=B,s.BufferGeometry.prototype.disposeBoundsTree=F,O=!0),this.engine=e,this.config=t,this.market=e.market;const[i,o,n,r,a,l,d,c]=await Promise.all([e.getModuleBySymbol(h.qL),e.market.waitForData(g.M),e.getModuleBySymbol(h.mL),e.getModuleBySymbol(h.M7),e.getModuleBySymbol(h.sA),e.getModuleBySymbol(h.kM),e.market.waitForData(D.X),e.getModuleBySymbol(h.Qm)]);this.viewmodeData=d,this.webglScene=r.getScene(),this.raycasterModule=a,this.input=n,this.chunkVisibilityChecker=new It(this.webglScene,a.picking,o.pose,c.viewportManager),o.pose.onChanged((()=>this.chunkVisibilityChecker.resetCounter())),this.chunkSharedState=new Lt,this.chunkSharedState.maxVaryings=r.maxVaryings,this.meshTextureLoader=new Pt(t.textureLOD,i.getApi(),this.webglScene.camera,l,e,this.chunkVisibilityChecker,r),this.initRenderMode(t.startingMode,d),this.meshTrimInit(this.meshTrimData,a),this.bindings.push(this.engine.subscribe(v.A,(t=>{this.meshes.forEach((e=>{e.renderer.updateExistingTexture(t.sweepId,t.renderTarget.texture)}))}))),this.bindings.push(e.commandBinder.addBinding(A.P,this.setPreviewPosition.bind(this)),e.subscribe(y.ul,(()=>{this.meshTextureLoader.onWebGLContextLost()})),e.subscribe(y.aF,(()=>{this.meshTextureLoader.onWebGLContextRestored()})),e.commandBinder.addBinding(I,this.onPanoOverlayCommand.bind(this))),e.broadcast(new m.sb(p.D.ModelMesh)),e.broadcast(new m.sb(p.D.StreamingMesh)),e.broadcast(new m.sb(p.D.StreamingTexture))}onUpdate(t){this.chunkVisibilityChecker&&this.chunkVisibilityChecker.update(),this.meshTextureLoader&&!X.Ay.debugPauseTexStream&&this.meshTextureLoader.update(t);const e=performance.now()/1e3;this.meshes.forEach((i=>{for(const t of i.modelMesh.chunks)t.setTime(e);i.modelMesh.onUpdate(t),i.renderer.onUpdate(t)}))}dispose(t){super.dispose(t),this.meshTextureLoader.dispose();const e=t=>{t.modelMesh.dispose(),t.roomMeshData.floors.clear(),t.roomMeshData.rooms.clear(),this.meshLoadPromises.delete(t.id)};for(const t of this.allMeshes())e(t);this.meshLoadPromises.size>0&&Promise.all(this.meshLoadPromises.values()).then((t=>{t.forEach((t=>t.forEach(e)))}))}async removeMesh(t){const e=this.meshes.get(t)||this.inactiveMeshes.get(t)||await this.meshLoadPromises.get(t)||null;e&&(await this.engine.removeComponent(this,e.renderer),e.modelMesh.dispose(),e.roomMeshData.floors.clear(),e.roomMeshData.rooms.clear(),e.modelMesh.unregisterCollision(this.input),this.meshes.delete(t),this.inactiveMeshes.delete(t),this.meshLoadPromises.delete(t))}async isolateMesh(t){this.meshes.get(t.sid)||this.inactiveMeshes.get(t.sid)||(this.meshLoadPromises.get(t.sid)?await this.meshLoadPromises.get(t.sid):await this.loadMesh(t,t.sid,{loadInactive:this.meshes.length>0}));for(const e of this.allMeshes())e.setActive(e.id===t.sid)}async loadMesh(t,e,i={loadInactive:!1,registerMeshAsDynamic:!1}){var o;const{loadInactive:n,registerMeshAsDynamic:r}=i,a=null===(o=i.useFallbackMesh)||void 0===o||o,l=i.container||new s.Group;l.name="meshes";const c=async o=>{this.meshesLoaded++;const{engine:n,config:c,meshTrimUniforms:u,chunkVisibilityChecker:m,chunkSharedState:p}=this,g=n.claimRenderLayer(X.vz),w=this.isTiled(o),v=await this.getModelMeshFactory(w),y=new Bt.$;y.sourceViewId=o.modelId,y.layerId=t.layerId;const D=await v({uuid:t.uuid,model:o,renderLayer:g,engine:n,settings:X.Ay,roomMeshData:y,chunkSharedState:p,chunkFactory:(t,e,i,s)=>{const n=o.key()||"unknown",r=new st(t,e,i,p,s,n,!0);if(u){const e=u.getSharedFloorUniforms(t);r.setMaterialsUniform(e)}return r},chunkVisibilityChecker:m,gltfConfig:c.gltfConfig});D.addToOctree=!r;const b=D.initTextureLoader(this.meshTextureLoader,o.textures),M=await n.market.waitForData(f.A),S=this.makeMeshData(o.modelId,D.chunks,M);1===this.meshesLoaded&&(this.raycasterModule.setupOctree(D.boundingBox.clone().applyMatrix4(D.matrixWorld)),this.market.register(Bt.$,y),this.market.register(R.U,S));const T=await n.getModuleBySymbol(h.Qm);let x=null;o.modelId!==t.sid&&(x=new s.Group,x.name=o.modelId,l.add(x)),this.setupRaycasting(D,this.input);const P=new pt(null!=x?x:l,D,S,M,p,c,T.viewportManager,a);P.meshGroupVisuals.floorOpacity.onChanged((()=>this.chunkVisibilityChecker.resetCounter()));const C=P.meshGroupVisuals.meshTextureOpacity;this.bindings.push(C.onActivate((()=>{this.meshTrimUpdateRenderMode(0===C.endValue)})),C.onComplete((()=>{this.meshTrimUpdateRenderMode(0===C.value)}))),await n.addComponent(this,P),this.setRenderModeMesh(D,P,this.getRenderMode()),D.overrideMaxDetail(this.getMeshDetail()),await b,D.position.copy(o.position),D.quaternion.copy(o.rotation),D.updateWorldMatrix(!1,!0);const B={id:e,meshData:S,modelMesh:D,roomMeshData:y,renderer:P,tiled:w,setActive:s=>{if(d.Ay.for(this).debug(`setActive:${s} for ${t.sid}`),s){if(!this.meshes.has(o.modelId)){d.Ay.for(this).debug("showing",t),this.inactiveMeshes.delete(o.modelId),this.meshes.set(o.modelId,B),D.registerCollision(this.input);const e=this.webglScene.getSubTree([t.sid]),i=e.children.find((t=>"meshes"===t.name));i&&i.removeFromParent(),e.add(l)}}else this.inactiveMeshes.has(e)||(l.removeFromParent(),i.container===l&&this.webglScene.scene.remove(l),D.unregisterCollision(this.input),this.meshes.delete(o.modelId),this.inactiveMeshes.set(o.modelId,B))}};return B},u=this.meshLoadPromises.get(e);if(u)return u;const m=0===this.meshesLoaded,p=(async()=>{const e=[];for(const i of Object.values(t.meshAssets))e.push(await c(i));return e})();this.meshLoadPromises.set(e,p);const g=await p;return g.forEach((t=>t.setActive(!n))),m&&this._firstMeshLoadPromise.resolve(),g}async getModelMeshFactory(t=!0){return(t?await Promise.all([i.e(8287),i.e(1916),i.e(4787),i.e(2026),i.e(1056),i.e(3232),i.e(6168),i.e(5672),i.e(8074),i.e(9114)]).then(i.bind(i,16284)):await Promise.all([i.e(8287),i.e(1916),i.e(4787),i.e(2026),i.e(1056),i.e(3232),i.e(6168),i.e(5672),i.e(8074),i.e(9114)]).then(i.bind(i,59228))).createModelMesh}setupRaycasting(t,e){t.registerCollision(e)}setChunkSide(t){const e=this.chunkSharedState.side;return this.chunkSharedState.side=t,e}getChunkRenderingMode(){return this.chunkSharedState.renderingMode}stats(){return{textureCount:this.meshTextureLoader.textureCount,streaming:[...this.meshes.values].some((t=>t.tiled))}}getRenderMode(){return this._renderMode}setRenderMode(t,e=0,i=c.AU){for(const s of this.allMeshes())this.setRenderModeMesh(s.modelMesh,s.renderer,t,e,i);d.Ay.for(this).debug(`setRenderMode from ${this._renderMode} to ${t}`),this._renderMode=t}setMeshOptions(t){var e;for(const i of this.allMeshes()){const s=null!==(e=t.overrideMaxDetail)&&void 0!==e?e:i.modelMesh.detail;i.modelMesh.overrideMaxDetail(s)}}getMeshDetail(){let t="default";return this.meshes.forEach((e=>t=e.modelMesh.detail)),t}setTextureLimits(t,e){for(const i of this.allMeshes())i.modelMesh.setTextureQuality(this.meshTextureLoader,t,e)}setTextureStreamMode(t){switch(t){case E.R.NONE:this.meshTextureLoader.autoLoadTiles=!1;break;case E.R.RAYCAST:this.meshTextureLoader.autoLoadTiles=!0}}setRenderModeMesh(t,e,i,s=0,o=c.AU){let n=1;switch(i){case V.p.Hidden:n=1,t.visible=!1;break;case V.p.Mesh:n=1,t.visible=!0;break;case V.p.PanoramaMesh:n=0,t.visible=!0;break;case V.p.PanoramaCube:n=0,t.visible=!1;break;default:throw new Error(`unknown mode ${i}!`)}const r=e.meshGroupVisuals.meshTextureOpacity;return r.value===n&&r.easing===o&&r.duration===s||(r.modifyAnimation(r.value,n,s,o),0===s&&(e.onUpdate(1/60),e.beforeRender())),n}initRenderMode(t,e){let i=t;switch(null===i&&(i=e.transition.active?e.transition.to:e.currentMode),i){case b.N3.Dollhouse:case b.N3.Floorplan:case b.N3.Mesh:this.setRenderMode(V.p.Mesh);break;default:this.setRenderMode(V.p.PanoramaMesh)}this.bindings.push(e.transitionActiveObservable.onChanged((t=>{if(t){const t=this.viewmodeData.transition.to===b.N3.Panorama,e=this.viewmodeData.transition.from!==b.N3.Panorama,i=t?V.p.PanoramaMesh:V.p.Mesh,s=e?100:0,o=t?c.AU:c.p_;this.setRenderMode(i,s,o)}})))}makeMeshData(t,e,i){var o;const n=new Map,r=new Map,a=new Map,h=new s.Box3,d=new s.Vector3;e.forEach((t=>{if(t.geometry.boundingBox&&h.union(t.geometry.boundingBox),t.geometry){const i=(0,Z.yL)(t.geometry);a.set(t,i),d.addScaledVector(i,1/e.length)}n.set(t.meshGroup,(n.get(t.meshGroup)||[]).concat(t)),r.set(t.meshSubgroup,(r.get(t.meshSubgroup)||[]).concat(t))}));const c=h.clone(),u=new s.Box3;i.getCollectionUnfiltered().forEach((e=>{e.isUnplaced()||e.sourceViewId!==t||(u.setFromCenterAndSize(e.position,l.B1.UNIT),c.union(u))}));const m=new R.U([...h.min.toArray(),...h.max.toArray()],[...c.min.toArray(),...c.max.toArray()],d);for(const[t,e]of n.entries()){const i=new s.Box3,n=new s.Vector3;e.forEach((t=>{t.geometry.boundingBox&&i.union(t.geometry.boundingBox);const s=a.get(t);s&&n.addScaledVector(s,1/e.length)})),m.meshGroups.floors.set(t,{meshGroup:t,boundingBox:i,parentMeshGroup:null,centerOfMass:n});const h=[...new Set(e.map((t=>t.meshSubgroup)))].sort(((t,e)=>e-t));m.meshGroups.roomsByFloor.set(t,h);const l=m.meshGroups.rooms;for(const e of h){const i=new s.Box3,n=new s.Vector3,h=r.get(e)||[];h.forEach((t=>{t.geometry.boundingBox&&i.union(t.geometry.boundingBox);const e=a.get(t);e&&n.addScaledVector(e,1/h.length)}));const d={meshGroup:e,boundingBox:i,parentMeshGroup:t,centerOfMass:n},c=l.get(e);c?c.parentMeshGroup=Math.min(null!==(o=c.parentMeshGroup)&&void 0!==o?o:1/0,t):l.set(e,d)}}const p=[...m.meshGroups.floors.keys()].sort();return this.meshTrimData.addMeshGroups(p),m}async setPreviewPosition(t){const e=t.enabled&&t.previewCirclePosition?t.previewCirclePosition:null,i=t.size?t.size:.3;this.meshes.forEach((t=>{t.modelMesh.chunks.forEach((t=>{t.setMeshPreviewSphere(e,i)}))}))}setMeshOpacity(t,e){const i=t.length>0?t:this.meshes.keys;for(const t of i){const i=this.meshes.get(t)||this.inactiveMeshes.get(t);if(!i)throw Error("Unknown mesh id");i.renderer.opacity=e}}setMeshOpacityModifier(t,e){const i=t.length>0?t:this.meshes.keys;for(const t of i){const i=this.meshes.get(t);if(!i)throw Error("Unknown mesh id");i.renderer.meshGroupVisuals.globalOpacityModifier.value=e}}setChunkRenderingMode(t){for(const e of this.allMeshes())e.renderer.setChunkRenderingMode(t)}setMaterialUniforms(t){for(const e of this.allMeshes())e.modelMesh.chunks.forEach((e=>{e.setMaterialsUniform(t)}))}setMeshOverlay(t){const e=t.meshIds||null;for(const i of this.allMeshes())e&&-1===e.indexOf(i.id)||i.renderer.setMeshOverlay(t.selectBy,t.colorizeStyle,t.color||null,t.alpha||.5,t.index)}setMeshesOverlay(t){for(const e of this.allMeshes()){const i=t.get(e.id);void 0!==i&&e.renderer.setMeshOverlay("all","explicit",i,.5)}}isTiled(t){var e,i;const s=null!==(i=null===(e=this.engine.tryGetModuleBySymbolSync(a.ZF))||void 0===e?void 0:e.tryGetSetting(X.sz,!1))&&void 0!==i&&i;return!!t.tileset&&s&&!(0,u.w2)()}meshTrimInit(t,e){this.meshTrimUniforms=new N(this.getRenderMode()===V.p.PanoramaMesh);const{meshTrimsByMeshGroup:i}=t;this.bindings.push(t.onMeshGroupChanged((t=>this.meshTrimUpdate(t))),t.onMeshTrimChanged((t=>{this.meshTrimUpdate(t.meshGroup)}))),i.keys.forEach((t=>{this.meshTrimUpdate(t)}));const s=()=>{e.setIntersectionFilter(t.meshTrimsById.values.some((t=>t.enabled))?this.meshTrimFilter:null)};this.bindings.push(t.onChanged(s)),s()}meshTrimUpdate(t){const e=t!==w.Zu?[t]:this.meshTrimData.getAllMeshGroups();for(const t of e){const e=this.meshTrimData.getTrimsForMeshGroup(t);this.meshTrimUniforms.setFloorTrims(t,e);for(const t of this.allMeshes())t.modelMesh.chunks.forEach((t=>{t.setMaterialsUniform(this.meshTrimUniforms.getSharedFloorUniforms(t.meshGroup))}))}}}},99276:(t,e,i)=>{"use strict";i.d(e,{B:()=>l});var s=i(68909),o=i(36476),n=i(30443),r=i(37458),a=i(5984),h=i(47299);class l extends a.r{constructor(t,e,i=o.H.ALL){super(),this._opacity=1,this._chunks=[],this.size=new s.Vector3,this.center=new s.Vector3,this.built=!1,this.layers.mask=i.mask,this.name=`RoomMesh:${t}-${e}`,this.meshGroup=t,this.meshSubgroup=e,this.renderOrder=r.X.default,this.castShadow=l.ShouldCastShadow,this.onBeforeRender=(t,e,i,s,o,n)=>{this.updateUniforms(o,n)}}dispose(){this.reset()}reset(){this._chunks.length=0,this.geometry.dispose(),delete this.onBuild,delete this.onOpacityUpdate,this.built=!1}addChunk(t){-1===this._chunks.indexOf(t)&&this._chunks.push(t)}getChunk(t){return this._chunks[t]}build(){if(this.built)throw new Error("build() should only be called once");if(!this._chunks.length)return;const t=(0,n.h0)(this._chunks.map((t=>t.geometry)));t.clearGroups();let e=0;this.material=[],this._chunks.forEach(((i,s)=>{i.geometry&&i.geometry.index&&(t.addGroup(e,i.geometry.index.count,s),e+=i.geometry.index.count,i.geometry.dispose(),i.geometry=t,i.notifyOnMaterialUpdated((t=>{Array.isArray(this.material)&&(this.material[s]=t),this.onMaterialUpdate&&this.onMaterialUpdate()})),i.onOpacityUpdate=t=>{this.opacity=t})})),this.geometry=t,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.material=this._chunks.map((t=>t.material)),this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}buildWithSingleChunk(t){if(this.built)return;const{meshGroup:e,meshSubgroup:i,lod:s}=t;this.name=`RoomMesh:${s}-${e}-${i}-${t.chunkIndex}`,this.meshGroup=e,this.meshSubgroup=i,this._chunks.push(t),t.notifyOnMaterialUpdated((t=>{this.material=t,this.onMaterialUpdate&&this.onMaterialUpdate()})),t.onOpacityUpdate=t=>{this.opacity=t},this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}updateUniforms(t,e){t instanceof s.ShaderMaterial&&(e?this.chunks[e.materialIndex].onBeforeDraw(t):this.chunks.length&&this.chunks[0].onBeforeDraw(t))}get boundingBox(){return(0,n.UX)(this.geometry)}set opacity(t){t!==this.opacity&&(this._opacity=t,this.raycastEnabled=t>h.u7.FADE_CLICKABLE_THRESHOLD,this.renderOrder=t<h.u7.FADE_OPAQUE?r.X.ghostFloor:r.X.default,this.onOpacityUpdate&&this.onOpacityUpdate(t))}get opacity(){return this._opacity}get chunks(){return this._chunks}getSortKey(){return this.chunks.length?this._chunks[0].getSortKey():0}}l.ShouldCastShadow=!1},21100:(t,e,i)=>{"use strict";i.d(e,{$:()=>o});var s=i(84710);class o extends s.B{constructor(){super(),this.name="room-mesh-data",this.floors=new Set,this.rooms=new Set}}},85227:(t,e,i)=>{"use strict";var s;i.d(e,{p:()=>s}),function(t){t.Mesh="mesh",t.PanoramaMesh="mesh.inside",t.PanoramaCube="cubemap.inside",t.Hidden="mesh.hidden"}(s||(s={}))},59228:(t,e,i)=>{"use strict";i.r(e),i.d(e,{createModelMesh:()=>T});var s=i(71687),o=i(44345),n=i(68909),r=i(36476),a=i(10843),h=i(23870),l=i(64491),d=i(99276),c=i(75078);class u extends n.Object3D{constructor(t,e=r.H.ALL){super(),this.renderLayer=e,this.roomMeshes=new h.A((t=>t.meshSubgroup)),this.boundingBox=new n.Box3,this.size=new n.Vector3,this.center=new n.Vector3,this._chunks=[],this.built=!1,this.name=`FloorMesh:${t}`,this.meshGroup=t}dispose(){this.reset(),this.roomMeshes.clear()}reset(){for(const t of this.roomMeshes)t.dispose(),this.remove(t);this._chunks.length=0,this.built=!1}addChunk(t){const e=this.getOrCreateRoomMesh(t.meshSubgroup);this._chunks.push(t),e.addChunk(t)}build(){if(this.built)throw new Error("build() should only be called once");this.boundingBox.makeEmpty();for(const t of this.roomMeshes)this.add(t),this.boundingBox.union(t.boundingBox);this.center=this.boundingBox.getCenter(this.center),this.size=this.boundingBox.getSize(this.size),this.built=!0}get chunks(){return this._chunks}getOrCreateRoomMesh(t){let e=this.roomMeshes.get(t);if(!e){e=new d.B(this.meshGroup,t,this.renderLayer),e.layerId=this.layerId,e.sourceViewId=this.sourceViewId;const i=new c.$(e);this.roomMeshes.add(e),this.add(e),this.add(i)}return e}}var m=i(52018);class p extends m.t{constructor(t){super(t),this.name="MeshCreationException"}}var g=i(93121),f=i(70497);var w=i(15335),v=i(39994);const y=new a.Ay("dam-loader");class D{constructor(t){this.chunkFactory=t,this.decoder=i(27419)}async load(t,e,i){y.time("download");const s=await e.get(t,{responseType:"arraybuffer",onProgress:i});return y.timeEnd("download"),this.parse(s)}parse(t){y.time("parse proto");const e=this.decoder.binary_mesh.read(new w(t));y.timeEnd("parse proto"),y.time("convert to webgl");const i=this.convertProtobufToSceneObject(e);return y.timeEnd("convert to webgl"),i}convertProtobufToSceneObject(t){if(0===t.chunk.length)return y.warn("No chunks in damfile..."),[];const e=new n.Matrix4;e.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1);return t.chunk.map((t=>{const i=new n.BufferGeometry;i.setAttribute("position",new n.BufferAttribute(new Float32Array(t.vertices.xyz),3)),t.vertices.uv.length>0&&i.setAttribute("uv",new n.BufferAttribute(new Float32Array(t.vertices.uv),2)),i.setIndex(new n.BufferAttribute(new Uint32Array(t.faces.faces),1)),i.applyMatrix4(e),i.computeBoundingBox();const{group:s,subgroup:o}=(0,v.g8)(t.chunk_name);return this.chunkFactory(s,o,i,t.material_name)}))}}class b{static async load(t,e,i,s,o=0){const n=new D(e),r=i[o];if(!r)return Promise.reject("No suitable model file found...");const a=await r.url.get();return n.load(a,t,s).catch((()=>this.load(t,e,i,s,++o)))}}const M=new a.Ay("mesh");class S extends g.o{constructor(t,e,i=r.H.ALL,s){var o;super(),this.uuid=t,this.api=e,this.renderLayer=i,this.damMeshUrls=s,this.floorMeshes=new h.A((t=>t.meshGroup)),this.built=!1,this.name=`ModelMesh:${t}`,this.layers.mask=i.mask,(o=this.textureQualityMap).reset(),o.registerQualities(f.X.Standard,512,.048,.5,"low"),o.registerQualities(f.X.Standard,2048,.012,.5,"high")}dispose(){super.dispose(),this.floorMeshes.mapElements((t=>{t.dispose(),this.remove(t)})),this.floorMeshes.clear(),this.built=!1}reset(){this.floorMeshes.mapElements((t=>{t.reset(),this.remove(t)})),this._chunks.length=0,this.built=!1}async load(t){const{roomMeshData:e}=t;(0,l.w2)()&&(t.chunks=[]);let i=t.chunks?t.chunks:await b.load(this.api,t.chunkFactory,this.damMeshUrls,t.onProgress).catch((t=>{M.error(t);const e=t instanceof Error?t.message:"Failed to load model mesh";throw new p(e)}));if(0===i.length){M.warn("No geometry found for model, loading faux geometry, disabling outside view-mode");const e=new n.PlaneGeometry(5,5,1,1);e.rotateX(-Math.PI/2),e.computeBoundingBox();const s=t.chunkFactory(0,0,e);s.sharedState.forEachChunkMaterial((t=>t.visible=!1)),i=[s]}i.forEach((t=>{this.addChunk(t)})),this.build(e)}addChunk(t){const e=this.getOrCreateFloorMesh(t.meshGroup);this._chunks.push(t),e.addChunk(t)}build(t){var e,i;if(this.built)throw new Error("build() should only be called once");let s=0,o=0;for(const t of this.floorMeshes){this.add(t);for(const o of t.roomMeshes)o.build(),o.geometry.boundsTree||null===(i=(e=o.geometry).computeBoundsTree)||void 0===i||i.call(e),s++;t.build(),o++}M.debug(`FloorMeshes: ${o} RoomMeshes: ${s} Chunks: ${this._chunks.length}`),this.boundingBox.makeEmpty();for(const t of this.floorMeshes)this.boundingBox.union(t.boundingBox);this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),t.root=this,t.floors=new Set(this.floorMeshes),t.rooms=this.roomMeshes,t.commit(),this.built=!0}get roomMeshes(){const t=new Set;for(const e of this.floorMeshes)for(const i of e.roomMeshes)t.add(i);return t}async initTextureLoader(t,e){t.limitMemoryUsage=!1,t.setModel(this,this.chunks,e),await t.loadAll(this,this.textureQualityMap.min(f.X.Standard))}registerCollision(t){t.registerMesh(this,this.addToOctree);for(const e of this.roomMeshes)t.registerSnappingMeshGeometry(e.name,e.geometry,{meshGroup:e.meshGroup})}unregisterCollision(t){t.unregisterMesh(this);for(const e of this.roomMeshes)t.unregisterSnappingMeshGeometry(e.name)}setTextureQuality(t,e,i){t.setQuality(e,i)}onUpdate(){}getOrCreateFloorMesh(t){let e=this.floorMeshes.get(t);return e||(e=new u(t,this.renderLayer),this.floorMeshes.add(e),this.add(e)),e}}const T=async function({model:t,renderLayer:e,engine:i,chunkFactory:n,roomMeshData:r}){var a;const[h]=await Promise.all([i.getModuleBySymbol(s.qL)]),l=t.meshUrls||[],d=new S(null===(a=l[0])||void 0===a?void 0:a.uuid,h.getApi(),e,l);return await d.load({roomMeshData:r,chunkFactory:n,onProgress:t=>{i.broadcast(new o.EX(t.loaded,t.total))}}),d}},16284:(t,e,i)=>{"use strict";i.r(e),i.d(e,{createModelMesh:()=>r});var s=i(71687),o=i(20599),n=i(39034);const r=async function({uuid:t,model:e,engine:i,renderLayer:r,settings:a,roomMeshData:h,chunkFactory:l,chunkVisibilityChecker:d,chunkSharedState:c,gltfConfig:u}){const[m,p,g]=await Promise.all([i.getModuleBySymbol(s.M7),i.getModuleBySymbol(s.qL),i.market.waitForData(o.M)]),f=new n.f(t,r,c);return await f.load(i,m,m.getCamera(),g,e.tileset,h,l,d,p.getApi(),u),f}},93224:(t,e,i)=>{"use strict";i.r(e),i.d(e,{Cursor:()=>o.b,SetMouseCursorCommand:()=>n.X,default:()=>r});var s=i(75578),o=i(77510),n=i(35699);class r extends s.n{constructor(){super(...arguments),this.name="mouse-cursor",this.activeCursor=null}async init(t,e){this.config=Object.assign({classPrefix:"cursor"},t),this.bindings.push(e.commandBinder.addBinding(n.X,(async t=>this.changeCursor(t.cursor))))}changeCursor(t){const{container:e,classPrefix:i}=this.config;t!==this.activeCursor&&(this.activeCursor&&e.classList.remove(`${i}-${this.activeCursor}`),t&&e.classList.add(`${i}-${t}`),this.activeCursor=t)}}},47167:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>Vt});var s=i(75578),o=i(59758),n=i(71687),r=i(20599),a=i(13893),h=i(62568),l=i(90834),d=i(9997),c=i(27960);class u extends c.d{constructor(t){super(t),this.name="NavigationException"}}const m={Locked:"Cannot move while navigation is locked",InsideOnly:"Cannot navigate between panos when not in Panorama mode",InvalidSweep:"Not at a valid sweep",InTransition:"Cannot move while in a transition",NoDestinationFound:"Cannot move in that direction",InvalidMode:"Cannot move to mode"};var p=i(31002),g=i(23184),f=i(3694),w=i(6687),v=i(68909),y=i(23272),D=i(52026),b=i(63362),M=i(35699),S=i(77510),T=i(42120);class x{constructor(t,e,i,s,o,n,r,a,h,l){this.canStartTransition=t,this.commandBinder=e,this.input=i,this.floorsViewData=s,this.navigation=o,this.sweepData=n,this.cameraController=r,this.meshQuery=a,this.doubleClickToEnter=h,this.hasRoomBounds=l,this.bindings=[],this.cancelTransition=!1,this.targetFloorId=null,this.targetHitPoint=new v.Vector3,this.changeFloorPromise=null,this.toggleInput=t=>{this.bindings.forEach((e=>t?e.renew():e.cancel()))},this.onRoomClick=(t,e,i)=>{if(!this.canStartTransition())return!1;if(this.changeFloorPromise)return!0;if(!i||!i.point)return!1;const s=this.meshQuery.floorIdFromObject(e);if(!s)return!1;if(!this.floorsViewData.isNavigable(s))return this.onBackgroundClick();if(this.cancelTransition)return!0;const o=this.floorsViewData.currentFloorId;return 1!==this.floorsViewData.totalFloors&&s!==o?(this.targetFloorId||(this.targetFloorId=s,this.targetHitPoint.copy(i.point)),!o&&(this.changeFloorIfNeeded(),!0)):this.floorsViewData.roomSelectModeActive||this.floorsViewData.floorSelectModeActive?!!this.doubleClickToEnter||this.roomNavZoom(t,e,i):this.floorsViewData.floorSelectModeActive?(this.cancelTransition=!1,!1):(this.navigation.focus(i.point).then((()=>{this.cancelTransition||this.setFocusSweep(i),this.cancelTransition=!1})),!0)},this.roomNavZoom=(t,e,i)=>!i||(this.cancelTransition=!0,(async()=>{this.doubleClickToEnter||this.hasRoomBounds&&await(0,T.c)(100),await this.changeFloorPromise,await this.cameraController.cancelTransition(),this.navigation.navigateToPanoNearIntersection(i),this.cancelTransition=!1})(),this.commandBinder.issueCommand(new M.X(S.b.DEFAULT)),!0),this.onBackgroundClick=()=>!!this.canStartTransition()&&(!!this.floorsViewData.isMultifloor()&&(!!this.floorsViewData.showAllFloorsOption&&(!this.targetFloorId&&(!!this.cancelTransition||(this.cancelTransition=!0,void this.cameraController.cancelTransition().then((()=>this.commandBinder.issueCommand(new y.i1(null,!1)))).then((()=>{this.cancelTransition=!1}))))))),this.onFloorChange=()=>{null===this.floorsViewData.currentFloorId&&this.commandBinder.issueCommand(new M.X(S.b.DEFAULT))},this.clearFloorChange=()=>{this.targetFloorId=null},this.changeFloorIfNeeded=async()=>{this.targetFloorId&&(this.changeFloorPromise=this.commandBinder.issueCommand(new y.i1(this.targetFloorId,!1,void 0,this.targetHitPoint)),await this.changeFloorPromise,this.targetFloorId=null,this.changeFloorPromise=null)},this.bindings.push(this.input.registerMeshHandler(p.rX,g.f.is(w.aV),this.onRoomClick,{default:!0}),this.input.registerUnfilteredHandler(p.rX,this.clearFloorChange),this.input.registerHandler(p.rX,this.changeFloorIfNeeded),this.input.registerMeshHandler(p.rX,g.f.isType(f.W),this.onBackgroundClick,{default:!0}),this.floorsViewData.makeFloorChangeSubscription(this.onFloorChange)),h&&this.bindings.push(this.input.registerMeshHandler(p.wR,g.f.is(w.aV),this.roomNavZoom,{default:!0}))}async setFocusSweep(t){if(!this.canStartTransition())return;if(this.cancelTransition)return;const e=(0,D.I9)(this.sweepData,!1,t,this.meshQuery);e.length>0&&e[0].sweep&&await this.commandBinder.issueCommand(new b.HP(e[0].sweep.id))}}var P=i(81662),C=i(71397),B=i(44667),F=i(60043),O=i(28337),A=i(5984),k=i(72268),I=i(10843);const V=new I.Ay("nav-input");class E{constructor(t,e,i){this.navigation=t,this.inputIni=e,this.insideNav=[],this.insideVrNav=[],this.toggleInput=t=>{this.insideNav.forEach((e=>t?e.renew():e.cancel()))},this.toggleVrInput=t=>{this.insideVrNav.forEach((e=>t?e.renew():e.cancel()))},this.registerInsideClickHandlers=t=>[t.registerMeshHandler(p.rX,g.f.is(w.aV),((t,e,i)=>(this.tryExecuteAction(((t,e)=>L(t)&&R(e)),((t,e)=>R(e)&&this.navigation.navigateTowardsIntersection(e)),t,i),!0)),{default:!0}),t.registerMeshHandler(p.rX,g.f.isType(f.W),((t,e,i)=>this.tryExecuteAction(((t,e)=>L(t)&&R(e)),((t,e)=>R(e)&&this.navigation.navigateTowardsIntersection(e)),t,i)),{default:!0})],this.registerVrClickHandlers=t=>[t.registerMeshHandler(p.rX,g.f.isInstanceOf(A.r),((t,e,i)=>(this.tryExecuteAction(((t,e)=>L(t)&&R(e)),((t,e)=>R(e)&&this.navigation.navigateToPanoNearIntersection(e)),t,i),!0)),{default:!0})],this.registerWheelInput=t=>[t.registerHandler(B.s,(t=>this.tryExecuteAction((t=>!0),(t=>{if(t instanceof B.s){const e=new v.Vector3(0,0,Math.sign(t.delta.y));return!!this.navigation.navigateInLocalDirection(e)}return!1}),t)))],this.hotkeys=t=>[t.registerHandler(F.k,(t=>this.tryExecuteAction((t=>(N(t)||_(t))&&t.key in E.hotkeyDirections),(t=>{if(N(t)){this.continuousMovementHotkey=t.key;const e=E.hotkeyDirections[t.key];this.navigation.setContinuousNavigationLocalDirection(e)}else _(t)&&t.key===this.continuousMovementHotkey&&this.navigation.setContinuousNavigationLocalDirection();return!1}),t)))],this.tryExecuteAction=(t,e,i,s)=>{let o=!1;try{this.navigation.isNavigationInputAllowed()&&t(i,s)&&(o=e(i,s))}catch(t){if(!(t instanceof u))throw V.warn(t),t;V.debug(t)}return o},this.insideVrNav.push(...this.registerVrClickHandlers(this.inputIni)),this.insideNav.push(...this.registerInsideClickHandlers(this.inputIni),...this.hotkeys(this.inputIni)),i&&this.insideNav.push(...this.registerWheelInput(this.inputIni))}get bindings(){return[...this.insideNav,...this.insideVrNav]}}function R(t){return void 0!==t&&void 0!==t.point}function N(t){return t instanceof F.k&&t.state===O.$.DOWN}function _(t){return t instanceof F.k&&t.state===O.$.UP}function L(t){return t instanceof p.rX&&t.button===k.m.PRIMARY}E.hotkeyDirections={[C.D.W]:P.B1.FORWARD,[C.D.A]:P.B1.LEFT,[C.D.S]:P.B1.BACK,[C.D.D]:P.B1.RIGHT,[C.D.UPARROW]:P.B1.FORWARD,[C.D.DOWNARROW]:P.B1.BACK};var z=i(12837),U=i(46793),G=i(99583),H=i(2993),Q=i(88664),j=i(39209),W=i(96319),$=i(40397),q=i(51666);function K(t){if(t&&"object"==typeof t&&"min"in t&&"max"in t){const e=t;if((0,q.Z)(e.min)&&(0,q.Z)(e.max))return!0}return!1}var Z=i(25481);function X(t){if(t&&"object"==typeof t&&"x"in t&&"y"in t){const e=t;return(0,Z.Et)(e.x)&&(0,Z.Et)(e.y)}return!1}function Y(t){if(t&&"object"==typeof t&&"min"in t&&"max"in t){const e=t;if(X(e.min)&&X(e.max))return!0}return!1}var J=i(65882);var tt=i(53172);class et{constructor(t,e,i,s){this.canStartTransition=t,this.cameraData=e,this.cameraController=i,this.viewmodeData=s,this.focus=this.focus.bind(this),this.focusFloorplan=this.focusFloorplan.bind(this)}async focus(t,e){if(!this.canStartTransition())return;let i,s,o;K(t)?(s=t,i=s.getCenter(new v.Vector3)):Y(t)?(s=new v.Box3,s.min.set(t.min.x,0,t.min.y),s.max.set(t.max.x,0,t.max.y),o=new v.Box2(t.min,t.max),i=s.getCenter(new v.Vector3)):(i=t,s=void 0);const{from:n,transition:r,mode:h}=null!=e?e:{};let{position:l,rotation:d,focalDistance:c}=this.cameraData.pose;const u=this.cameraData.pose.pitchFactor()<.01;if(h!==H.N3.Dollhouse||!u&&!1!==(null==e?void 0:e.forceOrtho)||(d=(0,$.MN)(d,-55)),o&&Y(o)||(null==e?void 0:e.forceOrtho)||h===H.N3.Floorplan){if(o||(s&&(o=new v.Box2(new v.Vector2(s.min.x,s.min.z),new v.Vector2(s.max.x,s.max.z))),!s&&i&&(o=new v.Box2(new v.Vector2(i.x-5,i.z-5),new v.Vector2(i.x+5,i.z+5)))),!o)throw new Error("Floorplan mode requires a box or point");return this.focusFloorplan(i,o,h===H.N3.Dollhouse)}n?(l=n,d=(0,$.kf)(l,i)):s?({focalDistance:c,rotation:d,position:l}=this.getPoseForBox({box:s,targetRotation:d})):l=(0,$.fg)(d,i,c);const m={pose:{position:l,rotation:d},transitionType:null!=r?r:a.fl.Interpolate,focalDistance:c,transitionTime:J.U.TRANSITION_TIME_DH,autoOrtho:u};return this.cameraController.moveTo(m).nativePromise()}async focusFloorplan(t,e,i){i&&await this.cameraController.moveTo({transitionType:a.fl.OrbitTo,pose:{},autoOrtho:!0,targetPhi:a.mG.Top});const s=function(t,e,i,s){const o=t.pose,n=(new v.Vector3).copy(i());let r=null,a=o.focalDistance;const h=s.min.distanceTo(s.max)/(0,$.ff)(o.position.distanceTo(n),o.projection.asThreeMatrix4(),t.width)/t.screenDiagonalPx,l=h<.2,d=h>1.2,c=(l?.2+.1:1.2-.1)/h;if(e.isFloorplan()&&(n.y=o.position.y,a=o.focalDistance,r=o.projection.clone(),(l||d)&&(r.elements[0]*=c,r.elements[5]*=c)),e.isDollhouse()&&(n.y=o.fovCorrectedPosition().y,a=o.fovCorrectedFocalDistance(),l||d)){const t=o.fovCorrectedFocalDistance()/c,e=o.fovCorrectedPosition().y-o.fovCorrectedFocalDistance()+t;n.y=e,a=t}return{position:n,projection:r,focalDistance:a}}(this.cameraData,this.viewmodeData,(()=>t),e);return this.cameraController.moveTo({pose:{position:s.position},projection:s.projection?s.projection:void 0,transitionType:a.fl.Interpolate,transitionTime:J.U.TRANSITION_TIME_ROOM,autoOrtho:this.cameraData.pose.autoOrtho,focalDistance:s.focalDistance}).nativePromise()}getPoseForBox({box:t,targetRotation:e}){let i=this.cameraData.pose;i.pitchFactor()<.01&&(i=i.clone(),i.unapplyPhiBasedFovSquish(),i.resetProjMatrix());const s=e||i.rotation,o=35*tt.fy;(0,$.nk)(s,o);const n=i.aspect(),r=t.getCenter(new v.Vector3),a={targetPosition:r,targetRotation:s.clone(),angleDown:undefined,box:t,fovY:i.fovY(),aspectRatio:n},h=(0,$.hm)(a),l=r.distanceTo(h.position);return{position:h.position,rotation:h.rotation,focalDistance:l}}}var it=i(78229),st=i(96659),ot=i(19968),nt=i(73065);const rt=!0,at=8,ht=.1,lt=-25,dt=500,ct=-2,ut=32,mt=32;class pt{constructor(t,e,i,s,o){this.cameraData=t,this.sweepData=e,this.viewmodeModule=i,this.picking=s,this.issueCommand=o,this.tryNavigateToPoint=async(t,e,i,s,o,n,r)=>{const h=r?r.slice():[],l=n?n.slice():[];if(h.push(it.Zx()),h.push(it.Ol()),l.push(this.scoreByLatitude(t,ut)),e===a.fl.Interpolate&&(0,H.nI)(this.viewmodeModule.currentMode)&&this.sweepData.state.currentSweep){const e=this.sweepData.state.currentSweep,i=this.sweepData.getSweep(e),s=i.position.clone().sub(t).normalize();h.push(it.f(i)),l.push(st.oW(t,s))}h.push(this.withinLatitudeFilter(t)),h.push(this.notTooCloseFilter(t)),rt||h.push(this.notTooFarFilter(t)),l.push(st.d$(t,ct));const c=this.sweepData.sortByScore(h,l),u=this.sweepData.currentSweepObject,m=new v.Vector3;let p=null,g=!1,f=null;const w=(0,H.nI)(this.viewmodeModule.currentMode),y=null!=o?o:15,b=w&&u?new Set(u.neighbours.filter((t=>this.sweepData.getSweep(t).position.distanceTo(u.position)<y)).concat([u.id])):new Set;for(const o of c)if(this.sweepCanSeeNote(t,o.sweep)){if(f=o.sweep,e===a.fl.Interpolate||b.has(f.id)){m.copy(t).sub(f.position).normalize(),g=!0;const o=(0,D.Y7)(f.position,t,s),n=this.cameraData.pose.projection.asThreeMatrix4(),{width:r,height:h}=this.cameraData,l=(0,ot.bA)(t,f.position,o,r,h,n);i&&i(l),p=w?this.issueCommand(new d.aj({transition:a.fl.Interpolate,sweep:f.id,rotation:o})):this.viewmodeModule.switchToMode(H.N3.Panorama,e,{rotation:o,sweepID:f.id})}break}return!(!f||!g&&e===a.fl.Interpolate)&&(p||(p=this.issueCommand(new d.aj({transition:e,transitionTime:dt,sweep:f.id,rotation:(0,D.Y7)(f.position,t,s)}))),p&&await p,!0)},this.sweepCanSeeNote=(()=>{const t=new v.Vector3;return(e,i)=>{t.copy(e).sub(i.position);const s=t.length();t.normalize();let o=this.picking.pick(i.position,t,w.aV);return(!o||o.distance>s)&&(o=this.picking.pick(e,t.negate(),w.aV)),!o||s<=o.distance}})(),this.notTooCloseFilter=t=>e=>Math.abs(e.position.x-t.x)>ht||Math.abs(e.position.z-t.z)>ht,this.notTooFarFilter=t=>e=>e.position.distanceTo(t)>at,this.withinLatitudeFilter=t=>e=>{const i=(new v.Vector3).copy(t).sub(e.position),s=-Math.atan(i.y/Math.sqrt(i.x*i.x+i.z*i.z)),o=(0,tt.pu)(lt);return nt.ol-o<s&&s<nt.vc+o},this.scoreByLatitude=(()=>{const t=new v.Vector3;return(e,i)=>s=>{t.copy(e).sub(s.position);const o=Math.abs(Math.atan(t.y/Math.sqrt(t.x*t.x+t.z*t.z)))/(Math.PI/2),n=Math.floor(20*o)/20;return i*(1-n)}})(),this.scoreByDirection=(()=>{const t=new v.Vector3,e=new v.Vector3;return(i,s,o)=>n=>{if(Math.abs(s.dot(P.B1.UP))>.75)return 0;e.copy(s).normalize(),t.copy(i).sub(n.position).normalize();return-1*t.dot(e)*o}})(),this.scoreByFloor=(t,e)=>i=>i.floorId===t?e:0}async focusPin(t,e,i,s,o){const{anchorPosition:n,stemNormal:r,stemLength:a}=t,h=n.clone().add(r.clone().setLength(a)),l=[this.scoreByDirection(h,r,mt),this.scoreByFloor(t.floorId,32)];return this.focusPoint(h,e,i,s,o,l)}focus(t,e){var i;let s;if(K(t))s=t.getCenter(new v.Vector3);else if(Y(t)){const e=t.getCenter(new v.Vector2);s=new v.Vector3(e.x,0,e.y)}else s=t;return this.focusPoint(s,null!==(i=null==e?void 0:e.transition)&&void 0!==i?i:a.fl.Interpolate,void 0,void 0,void 0,(null==e?void 0:e.from)?[st.d$(null==e?void 0:e.from,100)]:[],[it.Pi(s,.25)])}async focusPoint(t,e,i,s,o,n,r){if(this.cameraData.canTransition()&&this.sweepData.state.canTransition()&&!await this.tryNavigateToPoint(t,e,i,s,o,n,r)){if(e!==a.fl.Interpolate)return this.goToNearestSweep(t,e,i,s);try{await this.issueCommand(new U.S2(U.w5.DOLLHOUSE,a.fl.Interpolate))}catch(o){await this.goToNearestSweep(t,e,i,s)}await this.tryNavigateToPoint(t,e,i,s,o,n,r)||await this.goToNearestSweep(t,e,i,s)}}async goToNearestSweep(t,e,i,s){const o=t,n=this.sweepData.getClosestSweep(o,!0);if(!n)throw new Error("Cannot find sweep closest to Mattertag disc");const r=(0,D.Y7)(n.position,o,s),h=this.cameraData.pose.projection.asThreeMatrix4(),{width:l,height:c}=this.cameraData,u=(0,ot.bA)(o,n.position,r,l,c,h);i&&i(u),await this.issueCommand(new d.aj({sweep:n.id,rotation:r,transition:e||a.fl.Interpolate}))}}var gt=i(48734),ft=i(85616),wt=i(86866);class vt extends ft.v{get active(){return this._active}get currentValue(){return this._value}get endValue(){return this._endValue}get speed(){return this._speed}get isSlowingDown(){return this._isSlowingDown}get maxSpeed(){return this._maxSpeed}get acceleration(){return this._acceleration}getProgressPercent(){return(this._value-this._startValue)/(this._endValue-this._startValue)}onComplete(t){return this._onComplete=t,this}setStartValue(t){return this._startValue=t,this}setCurrentValue(t){return this._value=t,this}setEndValue(t){return this._endValue=t,this}setInitialSpeed(t){return this._initialSpeed=t,this}setMaxSpeed(t){return this._maxSpeed=t,this}setDesiredAcceleration(t){return this._desiredAcceleration=t,this._jerk=3*Math.abs(this._desiredAcceleration-this._acceleration),this}activate(t){return this._active=t,this}setAccel(t){return this._acceleration=Math.abs(t),this}start(){this._active=!0,this._value=this._startValue,this._speed=this._initialSpeed}setSlowdown(t){return this._slowdown=t,this}constructor(t=1,e=0){super(),this._slowdown=!0,this._initialSpeed=0,this._speed=0,this._acceleration=1,this._desiredAcceleration=1,this._jerk=1,this._maxSpeed=1,this._minSpeed=.05,this._startValue=0,this._value=0,this._endValue=t,this._delay=e}tick(t){if(!this._active||t<=0)return;if(this._delay>0)return void(this._delay-=t);t>33&&(t=33);const e=.001*t,i=this._value,s=this._speed*e,o=(0,wt.cP)(i,this.endValue,s),n=this._endValue-i<=this.getSlowdownDistance(),r=this._slowdown&&n,a=r?this._minSpeed:this._maxSpeed,h=this.acceleration*e;this._speed=(0,wt.cP)(this._speed,a,h),this._isSlowingDown=r;const l=this._desiredAcceleration,d=this._jerk*e;return this._acceleration=(0,wt.cP)(this._acceleration,l,d),this._value=o,o===this.endValue?(this.activate(!1),this.commit(),void(this._onComplete&&this._onComplete())):void 0}getSlowdownDistance(){const t=this.speed,e=this._acceleration,i=t/(0===e?1e-5:e);return this.speed*i+.5*e*i*i}stop(t){this._active=!1,this._endValue=t,this.commit()}}var yt=i(31093),Dt=i(39710),bt=i(93941);const Mt=new I.Ay("walk");class St{get isActive(){return this.active}get targetSweep(){return this.nextSweep}constructor(t,e,i,s,o,n,r){this.cameraData=t,this.sweepDataState=e,this.sweepControl=i,this.cameraControl=s,this.generators=o,this.navigation=n,this.active=!1,this.path=[],this.lastQueueTime=0,this.repeatedQueueDelayMS=150,this.positionTracker=(new vt).setAccel(15).setMaxSpeed(5),this.baseTransitionTime=h.Ay.camera.baseTransitionTime,this.baseTransitionSpeed=h.Ay.camera.transitionSpeed,r.onSettingChanged(Dt.baseTransitionSpeedKey,(t=>{this.baseTransitionTime=t}))}setContinuousMovementDirection(t){this.continuousMovementDirection=t,!this.active&&t&&this.navigation.navigateInLocalDirection(t)}stop(){this.path.length=0,this.cameraControl.endExternalTransition(),this.nextSweep=void 0,this.active=!1,this.generator&&(this.generators.stopGenerator(this.generator),this.generator=null)}appendNode(t,e){if(!this.canQueueSweeps(t))return Promise.resolve();if(!t)return Promise.resolve();if(this.path.push(t),this.lastQueueTime=Date.now(),!this.active){this.active=!0;const{generator:e,deferred:i}=this.createTransition();this.generators.startGenerator(e),this.generator=e,this.activePromise=i.nativePromise().then((()=>{this.activePromise=null})),this.positionTracker.setEndValue(this.getDistanceToSweep(t)),this.checkForSpeedIncrease(t)}return this.activePromise?this.activePromise:Promise.resolve()}canQueueSweeps(t){if(t&&this.path.indexOf(t)>=0)return!1;return!(this.path.length>=2)&&!(this.active&&Date.now()-this.lastQueueTime<this.repeatedQueueDelayMS)}attemptContinuousNavigation(){try{this.continuousMovementDirection&&this.navigation.navigateInLocalDirection(this.continuousMovementDirection)}catch(t){if(!(t instanceof u||t instanceof bt.d))throw Mt.warn(t),t;Mt.debug(t)}}createTransition(){const t=this,e=new yt.i;return{generator:function*(){let i=Date.now();t.cameraControl.beginExternalTransition();const s=(new v.Vector3).copy(t.cameraData.pose.position),o=new v.Vector3,n=new v.Vector3,r=t.positionTracker;for(r.setMaxSpeed(5).setAccel(15);t.path.length>0;){const e=t.path.shift();if(!e){t.nextSweep=void 0;break}t.nextSweep=e,s.copy(t.cameraData.pose.position);const a=s.distanceTo(e.position);for(r.setStartValue(0).setEndValue(a).setInitialSpeed(r.speed).activate(!0),n.subVectors(e.position,s),n.normalize(),yield new gt.sv(t.sweepControl.activateSweepUnsafe({sweepId:e.id}).then((()=>{t.sweepControl.beginSweepTransition({sweepId:e.id,internalProgress:!1})}))),r.start(),t.checkForSpeedIncrease(e);r.active;){const a=Date.now()-i,h=0===t.path.length;let l=!1,d=!1;if(!h){const i=t.path[0];l=r.endValue-r.currentValue+e.position.distanceTo(i.position)<r.getSlowdownDistance();const s=o.subVectors(i.position,e.position);s.normalize();n.dot(s)<.3&&(d=!0)}r.setSlowdown(h||l||d),r.tick(a);const c=r.getProgressPercent();t.cameraControl.updateCameraPosition(o.lerpVectors(s,e.position,c)),t.sweepDataState.transition.progress.modifyAnimation(c,1,0),i=Date.now(),t.continuousMovementDirection&&t.canQueueSweeps()&&r.isSlowingDown&&t.attemptContinuousNavigation(),r.active&&(yield new gt.oN)}t.sweepControl.endSweepTransition({sweepId:e.id})}e.resolve(),t.stop()},deferred:e}}getDistanceToSweep(t){return(this.nextSweep?this.nextSweep.position:this.cameraData.pose.position).distanceTo(t.position)}checkForSpeedIncrease(t){const e=this.positionTracker,i=this.getDistanceToSweep(t),s=e.endValue-e.currentValue,o=s+i-e.getSlowdownDistance();if(s+i>12){const t=this.baseTransitionTime,i=this.baseTransitionSpeed,s=.001*(t+Math.log2(1+o)*Dt.TRANSITION_DISTANCE_MULTIPLIER*i)-e.maxSpeed/e.acceleration,n=o/s;s>0&&e.setMaxSpeed(n).setDesiredAcceleration(3*n)}else e.setMaxSpeed(5).setDesiredAcceleration(15)}}var Tt=i(56208),xt=i(73566);class Pt{constructor(t,e,i,s,o,n){this.engine=t,this.navigation=e,this.settingsData=i,this.cameraData=s,this.viewmodeData=o,this.toolsData=n,this.defaultSize=(new v.Vector3).fromArray([3,3,3])}async enforceLabelEditorFriendlyViewmode(){var t;let e=!0;await(null===(t=this.cameraData.transition.promise)||void 0===t?void 0:t.nativePromise());const i=this.determineViewmode();if(this.viewmodeData.currentMode!==i)try{await this.engine.commandBinder.issueCommand(new U.S2(i===H.N3.Dollhouse?U.w5.DOLLHOUSE:U.w5.FLOORPLAN,a.fl.Interpolate))}catch(t){e=!1}return e}async navigateToLabel(t){try{const e=this.determineViewmode();return await this.navigation.focus((new v.Box3).setFromCenterAndSize(new v.Vector3(0,1,0).add(t.position),this.defaultSize),{floorId:t.floorId,mode:e}),this.viewmodeData.currentMode===H.N3.Dollhouse||this.viewmodeData.currentMode===H.N3.Floorplan}catch(t){return!1}}determineViewmode(){const t=this.toolsData.activeToolName===xt.S0.LABELS||this.settingsData.tryGetSetting(Tt.Q$.LabelsDollhouse,!0),e=!this.viewmodeData.isDollhouseDisabled()&&t?H.N3.Dollhouse:H.N3.Floorplan,i=this.viewmodeData.currentMode;return(0,ot.aY)(this.cameraData.pose.pitchFactor())?H.N3.Floorplan:i===H.N3.Floorplan||i===H.N3.Dollhouse?i:e}}var Ct=i(70046),Bt=i(97171),Ft=i(12767);var Ot=i(3035),At=i(7584),kt=i(49953),It=i(27947);class Vt extends s.n{constructor(){super(...arguments),this.name="navigation",this.navigationRules=[()=>!0],this.navigationEnabled=!0,this.inputOutside=[],this.navigationFilters=new Set,this.addNavigationRule=t=>{-1===this.navigationRules.indexOf(t)&&this.navigationRules.push(t)},this.removeNavigationRule=t=>{const e=this.navigationRules.indexOf(t);-1!==e&&this.navigationRules.splice(e,1)},this.isNavigationInputAllowed=()=>{const t=this.navigationRules.reduce(((t,e)=>t&&e()),!0);return!(!this.navigationEnabled||!t)||(I.Ay.for(this).debug("Cannot move while navigation is locked",{blockedByRules:!t,blockedByCommand:!this.navigationEnabled}),!1)},this.navigationFilter=t=>{for(const e of this.navigationFilters.values())if(!e(t))return!1;return!0}}async init(t,e){const{market:i}=e;this.config=t,this.commandBinder=e.commandBinder,this.bindings.push(this.commandBinder.addBinding(d.Jq,(async()=>this.lockNavigation())),this.commandBinder.addBinding(d.sD,(async()=>this.unlockNavigation())),this.commandBinder.addBinding(d.rH,(async t=>{const{focusPosition:e,transition:i,orientationAdjust:s,onSweepChosen:o,neighborDistanceThreshold:n}=t;return this.navigationPoint.focusPoint(e,i,o,s,n)})),this.commandBinder.addBinding(d.E4,(async t=>{const{pinPosition:e,transition:i,orientationAdjust:s,onSweepChosen:o,neighborDistanceThreshold:n}=t;return this.navigationPoint.focusPin(e,i,o,s,n)})),this.commandBinder.addBinding(d.aj,(t=>this.navigateToSweep(t.sweep,{rotation:t.rotation,transitionType:t.transition,transitionTime:t.transitionTime,transitionSpeedMultiplier:t.transitionSpeedMultiplier,viewId:t.viewId}))),this.commandBinder.addBinding(d.UZ,(async({position:t,floorId:e,viewmodeOnly:i})=>i?this.navigationLabel.enforceLabelEditorFriendlyViewmode():!(!t||!e)&&this.navigationLabel.navigateToLabel({position:t,floorId:e}))),this.commandBinder.addBinding(d.Dd,(async({room:t})=>{var e;const i=isNaN(t.floorHeight)?this.floorsViewData.getFloor(null!==(e=t.floorId)&&void 0!==e?e:this.floorsViewData.topFloorId).medianSweepHeight():t.floorHeight;let s=t.getMinCeilingHeight();isNaN(s)&&(s=.1);const o=new v.Box3(new v.Vector3(t.bbox.min.x,i,t.bbox.min.y),new v.Vector3(t.bbox.max.x,i+s,t.bbox.max.y)),n=!this.viewmodeData.isInside()&&this.cameraData.pose.isPitchFactorOrtho||this.viewmodeData.isDollhouseDisabled()?H.N3.Floorplan:H.N3.Dollhouse;return this.focus(o,{mode:n,floorId:t.floorId})})),this.commandBinder.addBinding(d.r,(async t=>this.navigateToPose(t.pose)))),[this.settingsData,this.sweepData,this.sweepModule,this.viewmodeData,this.viewmodeModule,this.cameraData,this.cameraModule,this.interactionmodeData,this.meshQuery]=await Promise.all([i.waitForData(o.o),i.waitForData(z.A),e.getModuleBySymbol(n.Wh),i.waitForData(G.X),e.getModuleBySymbol(n.SD),i.waitForData(r.M),e.getModuleBySymbol(n.jh),i.waitForData(l.O),e.getModuleBySymbol(n.PM)]);const[s,a,h,c,u]=await Promise.all([e.getModuleBySymbol(n.sA),i.waitForData(W.M),i.waitForData(j.X),i.waitForData(kt.L),i.waitForData(It.zH)]);this.floorsViewData=h,this.navigationPoint=new pt(this.cameraData,this.sweepData,this.viewmodeModule,null==s?void 0:s.picking,e.commandBinder.issueCommand),this.navigationLabel=new Pt(e,this,this.settingsData,this.cameraData,this.viewmodeData,a);const m=await e.getModuleBySymbol(n.mL),p=()=>this.isNavigationInputAllowed()&&this.viewmodeData.canStartTransition()&&this.sweepData.state.canTransition(),g=()=>p()&&(this.viewmodeData.isDollhouse()||this.viewmodeData.isFloorplan()||this.viewmodeData.isOrthographic());this.navigationOutside=new et(g,this.cameraData,this.cameraModule,this.viewmodeData),this.inputOutside.push(new x(g,e.commandBinder,m,h,this,this.sweepData,this.cameraModule,this.meshQuery,t.doubleClickToGoInside,(0,At.m2)(c,this.settingsData,u.application===It.lg.WORKSHOP))),this.inputInside=new E(this,m,!!t.enableWheel),this.inputOutside.forEach((t=>this.bindings.push(...t.bindings))),this.bindings.push(...this.inputInside.bindings),this.updateInputBindings(),this.bindings.push(this.viewmodeData.makeModeChangeSubscription((()=>{this.viewmodeData.currentMode!==H.N3.Transition&&this.updateInputBindings()}))),this.navigationWalk=new St(this.cameraData,this.sweepData.state,this.sweepModule,this.cameraModule,e,this,this.settingsData),e.broadcast(new Ct.sb(Bt.D.Navigation))}updateInputBindings(){const t=this.interactionmodeData.isVR(),e=this.viewmodeData.isInside();this.inputInside.toggleInput(e&&!t),this.inputInside.toggleVrInput(e&&t),this.inputOutside.forEach((t=>t.toggleInput(!e)))}navigateInLocalDirection(t){const e=this.cameraData.pose.rotation;return this.navigateInDirection(t.clone().applyQuaternion(e))}setContinuousNavigationLocalDirection(t){this.navigationWalk.setContinuousMovementDirection(t)}addNavigationFilter(t){this.navigationFilters.add(t)}removeNavigationFilter(t){this.navigationFilters.delete(t)}navigateTowardsIntersection(t){try{this.navigateInDirection(t.point.clone().sub(this.cameraData.pose.position))}catch(t){return!1}return!0}navigateToPanoNearIntersection(t,e,i,s){const o=(0,D.I9)(this.sweepData,this.viewmodeData.isInside(),t,this.meshQuery,[],[this.navigationFilter]),n=o.length>0?o[0].sweep:this.sweepData.getClosestSweep(t.point,!0),r=(0,h.xl)(this.interactionmodeData.mode);if(this.viewmodeData.isInside()&&n)return this.navigateToSweep(n.id,{rotation:s,transitionType:r},e,i),!0;if(this.viewmodeData.canSwitchViewMode(H.N3.Panorama)){const t=n?n.id:void 0;return this.commandBinder.issueCommand(new U.S2(U.w5.INSIDE,r,{sweepID:t})),!0}return!1}navigateInDirection(t){var e,i;if(!this.viewmodeData.isInside())throw new u(m.InsideOnly);if(!this.sweepData.state.currentSweep)throw new u(m.InvalidSweep);const s=(0,h.xl)(this.interactionmodeData.mode);let o;if(o||(o=null===(e=(0,D.IV)({additionalFilter:this.navigationFilter,considerTrims:!0,direction:t,directionFactor:this.navigationWalk.isActive?.65:void 0,ignoreSweeps:[],meshQuery:this.meshQuery,sourceSweep:this.navigationWalk.isActive?this.navigationWalk.targetSweep:void 0,sweepData:this.sweepData})[0])||void 0===e?void 0:e.sweep),!o&&this.config.raycastNeighbors&&(o=null===(i=(0,D.GI)({additionalFilter:this.navigationFilter,direction:t,directionFactor:this.navigationWalk.isActive?.65:void 0,ignoreSweeps:[],meshQuery:this.meshQuery,sourceSweep:this.navigationWalk.isActive?this.navigationWalk.targetSweep:void 0,sweepData:this.sweepData,viewDirection:this.cameraData.pose.forward()})[0])||void 0===i?void 0:i.sweep),o)return this.navigateToSweep(o.id,{transitionType:s});throw new u(m.NoDestinationFound)}async focus(t,e){var i;if(!(e=Object.assign({mode:this.viewmodeData.currentMode,transition:a.fl.Interpolate},e)).mode||!this.isNavigationInputAllowed())throw new u(m.Locked);let s;if(await(0,Ot.L)(this.cameraData,this.viewmodeData),this.cameraData.pose.autoOrtho&&e.mode===H.N3.Floorplan&&(e.forceOrtho=!0),(e.floorId&&e.floorId!==this.floorsViewData.currentFloorId||null===this.floorsViewData.currentFloorId||this.viewmodeData.isInside())&&this.commandBinder.issueCommand(new y.i1(e.floorId||this.floorsViewData.getHighestVisibleFloorId(),!0,J.U.TRANSITION_TIME_DH/2)),this.viewmodeData.isInside()){let o;if(K(t))o=t;else if(Y(t)){const s=this.floorsViewData.floors.getFloor(null!==(i=e.floorId)&&void 0!==i?i:this.floorsViewData.getHighestVisibleFloorId()).medianSweepFloorHeight();o=new v.Box3(new v.Vector3(t.min.x,s,t.min.y),new v.Vector3(t.max.x,s,t.max.y))}s=function(t,e){e||(e=(t.currentFloor||t.getFloor(t.bottomFloorId)).boundingBox);const i=e.min.y,s=e.getCenter(new v.Vector3),o=e.max.clone();o.y=i;const n=s.distanceTo(o)/Math.tan(Ft.Bv.fov/2*tt.fy),r=P.YF.DOWNWARD.clone().multiply((new v.Quaternion).setFromAxisAngle(P.B1.RIGHT,45*tt.fy)),a=P.B1.FORWARD.clone().applyQuaternion(r).multiplyScalar(-1*n);return{position:s.clone().add(a),rotation:r}}(this.floorsViewData,o)}try{switch(e.mode){case H.N3.Panorama:await this.navigationPoint.focus(t,e);break;case H.N3.Dollhouse:await this.viewmodeModule.switchToMode(e.mode,e.transition,s),await this.navigationOutside.focus(t,e);break;case H.N3.Floorplan:await this.viewmodeModule.switchToMode(e.mode,e.transition),await this.navigationOutside.focus(t,e);break;default:throw I.Ay.for(this).warn(`navigation.focus: ${e.mode} not implemented yet`),new u(m.InvalidMode)}}catch(i){throw I.Ay.for(this).debug("Unable to set focus",t,e,i),i}}lockNavigation(){this.navigationEnabled=!1,I.Ay.for(this).debug("Navigation input locked")}unlockNavigation(){this.navigationEnabled=!0,I.Ay.for(this).debug("Navigation input unlocked")}async navigateToSweep(t,{rotation:e,transitionType:i,transitionTime:s,transitionSpeedMultiplier:o}={},n=this.cameraData,r=this.sweepData.state){const h=this.settingsData.tryGetSetting(Q.zk,a.fl.Interpolate);let l;void 0===i&&(i=h);const d=r.currentSweep;if(i===a.fl.Interpolate){const e=!d||this.sweepData.isSweepAligned(d),s=this.sweepData.isSweepAligned(t),o=d!==t,n=!e||!s,r=this.viewmodeData.isInside();o&&n&&r&&(i=a.fl.FadeToBlack)}if(this.viewmodeData.isInside()){const h=void 0===e&&void 0===s&&void 0===o,d=n.canTransition()&&r.canTransition();if(i===a.fl.Interpolate&&r.currentSweep!==t&&h&&(d||this.navigationWalk.isActive)){const e=this.sweepModule.getSweepOnView(t);l=this.navigationWalk.appendNode(e,r.currentSweep)}else{if(!d)return r.currentSweep;l=this.sweepModule.moveToSweep({transitionType:i,sweepId:t,rotation:e,transitionTime:s,transitionSpeedMultiplier:o,cameraData:n,sweepDataState:r})}}else l=this.viewmodeModule.switchToMode(H.N3.Panorama,i,{sweepID:t,rotation:e});return await l,this.sweepData.state.currentSweep}navigateToPose(t){const e={2:U.w5.DOLLHOUSE,3:U.w5.FLOORPLAN},{sweepIndex:i,quaternion:s,mode:o}=t;let{panoId:n,position:r}=t;if(!n&&void 0!==i){const t=this.sweepData.getSweepByIndex(i);t&&(n=t.id)}if(n)this.commandBinder.issueCommand(new d.aj({sweep:n,rotation:s,transition:a.fl.FadeToBlack}));else{if(!(o in e))throw new Error("Unknown navigation link pose: "+JSON.stringify(t));this.commandBinder.issueCommand(new U.S2(e[o],a.fl.Interpolate,{rotation:s,position:r}))}}}},17183:(t,e,i)=>{"use strict";i.d(e,{a:()=>g});var s=i(68909),o=i(46771),n=i(71828),r=i(33007),a=i(86866),h=i(40397),l=i(4994),d=i(31093),c=i(13893),u=i(3249),m=i(81662),p=i(28995);class g extends l.A{constructor(t,e,i,r,a=!1,h=!1,l=!1){super(),this.cameraPoseProxy=t,this.visibleMeshBounds=e,this.allowPhiRotate=h,this.allowAzimutRotate=l,this.targetProjection=new o.k,this.currentOrientation=new s.Quaternion,this.currentPosition=new s.Vector3,this.positionDelta=new s.Vector3,this.angularAccel=new s.Vector2,this.angularVelocity=new s.Vector2,this.linearAccel=new s.Vector2,this.linearVelocity=new s.Vector2,this.zoomAccel=0,this.zoomVelocity=0,this.scale=1,this.maxZoom=0,this.minZoom=n.WU,this.bindings=[],this.aimTarget=new s.Vector3,this.tempAxis=new s.Vector3,this.tempOrientation=new s.Quaternion,this.nextPosition=new s.Vector3,this.nextOrientation=new s.Quaternion,this.currentPose=new p.J(1),this.checkBounds=a,this.bounds=i.clone(),this.boundsCenter=r.clone(),this.setupBounds(),this.transition={active:!1,startTime:0,elapsed:0,duration:0,linearVelocity:new s.Vector2,angularVelocity:new s.Vector2,zoomVelocity:0,easeOut:!1}}start(){this.scale=1,this.bindings.push(this.visibleMeshBounds.onFullBoundsChanged(this.updateZoomLevels.bind(this))),this.updateZoomLevels()}setPanAcceleration(t,e=!1,i){if(!this.transition.active){e&&this.haltVelocity(t,this.linearVelocity);const s=this.cameraPoseProxy.pose,o=s.projection.elements[0],n=s.projection.elements[5];this.linearAccel.x=void 0!==t.x?t.x/o:this.linearAccel.x,this.linearAccel.y=void 0!==t.y?t.y/n:this.linearAccel.y,void 0!==i&&this.linearAccel.setLength(i)}}setZoomAcceleration(t){this.transition.active||(this.zoomAccel=t)}setOrbitalAcceleration(t,e=!1){this.transition.active||(e&&this.haltVelocity(t,this.angularVelocity),this.angularAccel.x=void 0!==t.x?t.x:this.angularAccel.x,this.angularAccel.y=void 0!==t.y?t.y:this.angularAccel.y)}haltVelocity(t,e){t.x&&e.x&&Math.sign(t.x)!==Math.sign(e.x)&&(e.x=0),t.y&&e.y&&Math.sign(t.y)!==Math.sign(e.y)&&(e.y=0)}startRotateTransition(t,e,i){return e.x*=-1,this.startTransition(t,e.clone().multiplyScalar(n.qD),new s.Vector2,0,i).nativePromise()}startTranslateTransition(t,e,i=!0){return this.startTransition(t,new s.Vector2,e.clone().multiplyScalar(n.qD),0,i).nativePromise()}startZoomTransition(t,e,i){return this.startTransition(t,new s.Vector2,new s.Vector2(0,0),e,i).nativePromise()}startTransition(t,e,i,s,o){const n=new d.i;return this.poseController?(this.transition.active=!0,this.transition.duration=t,this.transition.elapsed=0,this.transition.startTime=Date.now(),this.transition.deferred=n,this.transition.angularVelocity.copy(e),this.transition.linearVelocity.copy(i),this.transition.zoomVelocity=s,this.transition.easeOut=o,this.angularAccel.set(0,0),this.linearAccel.set(0,0),this.zoomAccel=0,this.angularVelocity.copy(e),this.linearVelocity.copy(i),this.zoomVelocity=s,this.poseController.beginExternalTransition(),n.promise()):n.resolve().promise()}stopTransition(){var t;this.transition.active&&(null===(t=this.poseController)||void 0===t||t.endExternalTransition(),this.transition.active=!1),this.transition.deferred&&(this.transition.deferred.resolve(),this.transition.deferred=void 0)}updateTransition(t,e,i,s){let o=1,r=t/n.qD;this.transition.elapsed+=t;const a=this.getTransitionScale(t);if(this.transition.elapsed>=this.transition.duration){o=(this.transition.duration-(this.transition.elapsed-t))/t,r=1}i&&(this.linearVelocity.copy(this.transition.linearVelocity).multiplyScalar(a),this.pan(this.linearVelocity)),s&&(this.zoomVelocity=this.transition.zoomVelocity*a,this.zoom(this.zoomVelocity)),e&&(this.angularVelocity.copy(this.transition.angularVelocity).multiplyScalar(o*r),this.orbit(this.angularVelocity)),this.transition.elapsed>=this.transition.duration&&(this.stop(this.transition.easeOut),this.transition.active=!1)}getTransitionScale(t){if(this.transition.elapsed>=this.transition.duration){return(this.transition.duration-(this.transition.elapsed-t))/t}return t/n.qD}updateDefault(t,e,i,s){const o=t/n.qD;if(i&&(this.linearVelocity.addScaledVector(this.linearAccel,o),this.pan(this.linearVelocity),this.linearVelocity.multiplyScalar(Math.pow(1-n.g1,o))),s&&(this.zoomVelocity=this.zoomVelocity+this.zoomAccel*o,this.zoom(this.zoomVelocity),this.zoomVelocity*=Math.pow(1-n.pz,o),this.angularVelocity.set(0,0),this.angularAccel.set(0,0)),e&&!s){this.angularVelocity.addScaledVector(this.angularAccel,o);const t=1;this.orbit(this.angularVelocity.clone().multiplyScalar(o/t)),this.angularVelocity.multiplyScalar(Math.pow(1-n.g1,o)/t)}}update(t){const e=this.linearAccel.length()>r.A.epsilon||this.linearVelocity.length()>r.A.epsilon,i=Math.abs(this.zoomAccel)>r.A.epsilon||Math.abs(this.zoomVelocity)>r.A.epsilon,s=this.angularAccel.length()>r.A.epsilon||this.angularVelocity.length()>r.A.epsilon;this.transition.active?this.updateTransition(t,s,e,i):this.updateDefault(t,s,e,i)}stopMomentum(){this.transition.active||(this.linearVelocity.set(0,0),this.zoomVelocity=0,this.angularVelocity.set(0,0))}stopAcceleration(){this.transition.active||(this.setPanAcceleration({x:0,y:0}),this.setZoomAcceleration(0),this.setOrbitalAcceleration({x:0,y:0}))}stop(t=!1){this.stopTransition(),this.stopAcceleration(),t||this.stopMomentum(),this.bindings.forEach((t=>t.cancel())),this.bindings.length=0}pan(t){if(!this.poseController)return;const e=this.cameraPoseProxy.pose;this.positionDelta.x=t.x,this.positionDelta.y=t.y,this.positionDelta.z=0,this.positionDelta.applyQuaternion(e.rotation),this.currentPosition.copy(e.position).add(this.positionDelta),this.checkBounds&&!this.insideBounds(this.currentPosition,e.rotation,e.projection)||this.poseController.updateCameraPosition(this.currentPosition)}zoom(t){if(!this.poseController)return;const e=this.cameraPoseProxy.pose;this.targetProjection.copy(e.projection);const i=this.scale*(1-t);if(Math.abs(i-this.scale)>r.A.epsilon){this.targetProjection.elements[0]*=i/this.scale,this.targetProjection.elements[5]*=i/this.scale;const s=(0,h.BN)(this.targetProjection);if(t<0&&s<=this.minZoom||t>0&&s>=this.maxZoom)return;if(this.checkBounds&&!this.insideBounds(e.position,e.rotation,this.targetProjection))return;this.scale=i,this.poseController.updateCameraProjection(this.targetProjection.clone())}}calculateAimTarget(t,e){e.copy(m.B1.FORWARD).applyQuaternion(t.rotation),e.setLength(t.focalDistance)}orbit(t,e=!1){if(!this.poseController)return;this.currentPose.copy(this.cameraPoseProxy.pose);const i=this.cameraPoseProxy.pose,s=i.phi(),o=t,n=Math.PI/2,r=(0,u.qE)(o.y,0-s,n-s);return n-s<1e-5&&r>0&&!(Math.abs(t.x)>0)?(this.angularVelocity.y=0,void(this.angularAccel.y=0)):(this.calculateAimTarget(i,this.aimTarget),this.nextPosition.copy(i.position).sub(this.aimTarget),this.nextOrientation.copy(i.rotation),this.allowPhiRotate&&(this.tempAxis.copy(m.B1.RIGHT),this.tempOrientation.setFromAxisAngle(this.tempAxis.applyQuaternion(i.rotation),-r),this.nextPosition.applyQuaternion(this.tempOrientation),this.nextOrientation.premultiply(this.tempOrientation)),this.allowAzimutRotate&&(this.tempOrientation.setFromAxisAngle(m.B1.UP,o.x),this.nextPosition.applyQuaternion(this.tempOrientation),this.nextOrientation.premultiply(this.tempOrientation)),this.nextPosition=this.nextPosition.add(this.aimTarget),this.nextOrientation.normalize(),this.currentPose.position.copy(this.nextPosition),this.currentPose.rotation.copy(this.nextOrientation),e?this.poseController.moveTo({transitionType:c.fl.Interpolate,pose:{position:this.currentPose.position.clone(),rotation:this.currentPose.rotation.clone()},transitionTime:500}).nativePromise():void this.poseController.updateCameraPose(this.currentPose))}updateZoomLevels(){const t=this.visibleMeshBounds.getFullBounds().getBoundingSphere(new s.Sphere);this.maxZoom=t.radius*n.SO}setupBounds(){this.bounds.min.x=this.adjustBound(this.bounds.min.x,2),this.bounds.min.y=this.adjustBound(this.bounds.min.y,2),this.bounds.min.z=this.adjustBound(this.bounds.min.z,2),this.bounds.max.x=this.adjustBound(this.bounds.max.x,-2),this.bounds.max.y=this.adjustBound(this.bounds.max.y,-2),this.bounds.max.z=this.adjustBound(this.bounds.max.z,-2),this.worldBounds=(new s.Box3).setFromCenterAndSize(this.boundsCenter,new s.Vector3(this.bounds.max.x-this.bounds.min.x,this.bounds.max.y-this.bounds.min.y,this.bounds.max.z-this.bounds.min.z))}insideBounds(t,e,i){return!!(0,a.i0)(t,e,i,this.worldBounds)}adjustBound(t,e){return Math.sign(t+e)===Math.sign(t)?t+e:0}}},74072:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>S});var s,o=i(68909),n=i(59758),r=i(17183),a=i(71828),h=i(72268),l=i(71397),d=i(28337),c=i(2993),u=i(1197),m=i(98309),p=i(44667),g=i(94790),f=i(20014),w=i(60043),v=i(22278),y=i(86866),D=i(71687),b=i(20599),M=i(17986);!function(t){t[t.NONE=h.O.NONE]="NONE",t[t.PAN=h.O.PRIMARY]="PAN",t[t.ROTATE=h.O.SECONDARY]="ROTATE",t[t.ZOOM=h.O.MIDDLE]="ZOOM"}(s||(s={}));class S extends M.A{constructor(){super(...arguments),this.name="orthographic-controls",this.controlState=s.NONE,this.controlsEngaged=!1,this.movementKeys=new o.Vector2,this.allowRotation=!1,this.resetControlState=()=>{this.controlState=s.NONE}}async init(t,e){const[i,s,o,r,h,l]=await Promise.all([e.market.waitForData(v.U),e.getModuleBySymbol(D.jh),e.getModuleBySymbol(D.X7),e.market.waitForData(b.M),e.market.waitForData(n.o),e.getModuleBySymbol(D.UN)]);this.meshData=i,this.cameraModule=s,this.allowRotation=t.allowRotation,this.modelSize=Math.max(i.extendedSize.length(),1),this.commonControlsModule=o,this.createCameraControls(i,r,h,l),this.registerActiveStateChangeBinding(),e.getModuleBySymbol(D.mL).then((t=>{this.inputBindings.push(t.registerHandler(p.s,(t=>{this.onScrollWheel(t)}))),this.inputBindings.push(t.registerHandler(g.SK,(t=>{this.onDragBegin(t.buttons)}))),this.inputBindings.push(t.registerHandler(g.jF,(t=>{this.controlsEngaged=!0,this.onDrag(t.delta),this.controls.update(a.qD),this.controls.stop()}))),this.inputBindings.push(t.registerHandler(g._w,(t=>{this.controlsEngaged&&(t.timeSinceLastMove<100&&(this.onDrag(t.delta),this.controls.update(a.qD),this.controls.stopAcceleration()),this.onDragEnd(t.delta,t.buttons),this.controlsEngaged=!1)}))),this.inputBindings.push(t.registerHandler(f.l,(t=>{this.controls.setZoomAcceleration(-t.pinchDelta*a.Tv),this.controls.update(a.qD),this.controls.stop()}))),this.inputBindings.push(t.registerHandler(f.g,this.resetControlState)),this.inputBindings.push(t.registerHandler(w.k,(t=>{t.state!==d.$.PRESSED&&this.onKey(t)}))),this.updateInputBindings()})),this.bindings.push(e.subscribe(u.A,(t=>{this.controls.isActive&&this.controls.start()})),e.subscribe(m.A,(t=>{this.controls.isActive&&this.controls.stop()})))}onUpdate(t){this.controls.isActive&&this.controls.update(t)}createCameraControls(t,e,i,s){const o=this.commonControlsModule.cameraPoseProxy;this.controls=new r.a(o,s,t.extendedBounds,t.meshCenter,!0,this.allowRotation,this.allowRotation),this.commonControlsModule.addControls(c.N3.Orthographic,this.controls)}onActiveStateChanged(){super.onActiveStateChanged(),this.resetControlState()}onScrollWheel(t){if(0!==t.delta.y){const e=(0,y.OF)(this.modelSize,1,1500,2,.125);this.controls.setZoomAcceleration(t.delta.y*a.aY/(e*a.mK)),this.controls.update(a.qD),this.controls.setZoomAcceleration(0)}}onDragBegin(t){if(this.controlState===s.NONE){const e=t;this.controlState=e}this.controls.stop()}onDrag(t){switch(this.controlState){case s.PAN:const e=t;this.controls.setPanAcceleration({x:-e.x,y:-e.y});break;case s.ZOOM:0!==t.y&&this.controls.setZoomAcceleration(-t.y);break;case s.ROTATE:this.controls.setOrbitalAcceleration({x:-Math.PI*t.x,y:-Math.PI*t.y})}}onDragEnd(t,e){e&this.controlState||(this.controlState=s.NONE)}onKey(t){const{key:e,state:i}=t,s=i===d.$.DOWN;let o=!1;switch(e){case l.D.A:this.movementKeys.x=s?-1:0,o=!0;break;case l.D.D:this.movementKeys.x=s?1:0,o=!0;break;case l.D.W:this.movementKeys.y=s?1:0,o=!0;break;case l.D.S:this.movementKeys.y=s?-1:0,o=!0;break;case l.D.K:this.controls.setZoomAcceleration(s?a.Dw:0);break;case l.D.I:this.controls.setZoomAcceleration(s?-a.Dw:0);break;case l.D.J:case l.D.LEFTARROW:this.controls.setOrbitalAcceleration({x:s?a.$6:0,y:0},!0);break;case l.D.L:case l.D.RIGHTARROW:this.controls.setOrbitalAcceleration({x:s?-a.$6:0,y:0},!0)}if(o){const t=this.movementKeys;this.controls.setPanAcceleration({x:t.x,y:t.y},!1,a.bI)}}}},53028:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>C});var s=i(75578),o=i(71687),n=i(36476),r=i(68909),a=i(70694),h=i.n(a),l=i(52492),d=i.n(l),c=i(16249),u=i.n(c),m=i(88140),p=i.n(m),g=i(91254),f=i.n(g),w=i(50652),v=i.n(w);const y={circle_projection:new r.ShaderMaterial({uniforms:{textureSampleScale:{value:5},panoTexture:{value:null},borderSize:{value:0},borderColor:{value:new r.Vector4(1,1,1,1)}},depthWrite:!1,depthTest:!0,side:r.DoubleSide,vertexShader:h(),fragmentShader:d()}),equirectangular:new r.ShaderMaterial({uniforms:{cubemap:{value:null},yaw:{value:0}},depthWrite:!1,depthTest:!1,vertexShader:u(),fragmentShader:p()}),compose:new r.ShaderMaterial({uniforms:{mask:{value:null},bg:{value:null}},transparent:!0,vertexShader:f(),fragmentShader:v()})};var D=i(95102),b=i(18821);class M{constructor(t,e){this._renderer=t,this._renderTarget=e}get target(){return this._renderTarget}get width(){return this._renderTarget.width}get height(){return this._renderTarget.height}get bpp(){return 4}readRenderTargetData(t){const e=this._renderTarget.width,i=this._renderTarget.height;return t=t||new Uint8Array(e*i*4),this._renderer.readRenderTargetPixels(this._renderTarget,0,0,e,i,t),t}setSize(t,e){this._renderTarget.setSize(t,e)}dispose(){this._renderTarget.dispose()}}var S=i(244),T=i(30443),x=i(10843);const P=new r.DataTexture(new Uint8Array([255,255,255,255]),1,1);P.needsUpdate=!0;class C extends s.n{constructor(){super(...arguments),this.name="render-to-texture",this.circleProjectionPlane=new D.m((0,T.Wi)(),y.circle_projection),this.equirectProjectionPlane=new D.m((0,T.Wi)(),y.equirectangular),this.composePlane=new D.m((0,T.Wi)(),y.compose),this.cachedSize=new r.Vector2,this.cachedViewport=new r.Vector4,this.cachedViewport2=new r.Vector4,this.debugRenderOffset=0,this.tempColor=new r.Color}async init(t,e){this.engine=e;const i=await e.getModuleBySymbol(o.M7);this.cwfRenderer=i.cwfRenderer,this.renderer=i.threeRenderer,this.camera=new r.PerspectiveCamera,this.orthoCamera=new r.OrthographicCamera(-.5,.5,.5,-.5,0,1),this.camera.layers.mask=n.H.ALL.mask,this.scene=new r.Scene,this.scene.name="rtt",this.scene.matrixWorldAutoUpdate=!1,this.bindings.push(e.commandBinder.addBinding(b.q6,(async()=>new M(this.renderer,this.createRenderTarget2D(0)))),e.commandBinder.addBinding(b.X7,(async t=>{this.renderContext(t.renderTarget.target,t.context)})),e.commandBinder.addBinding(b.Is,(async t=>{this.render(t.renderTarget.target,t.sceneObject,t.camera)})),e.commandBinder.addBinding(b.cl,(async t=>{this.renderEquirectangular(t.texture,t.renderTarget.target,t.heading)})),e.commandBinder.addBinding(b.aD,(async t=>{this.render(t.renderTarget,t.sceneObject,t.camera)})))}getRenderSize(){const t=this.renderer.getPixelRatio(),e=this.renderer.getSize(this.cachedSize);return e.width*=t,e.height*=t,e}onUpdate(){this.debugRenderOffset=0}createRenderTarget2D(t,e=t,i,s=!0){const o=new r.WebGLRenderTarget(t,e,i);return o.texture.generateMipmaps=s,o}clearRenderTarget2D(t,e,i){const s=this.renderer.getClearColor(this.tempColor),o=this.renderer.getClearAlpha(),n=this.renderer.getRenderTarget();this.renderer.setRenderTarget(t),e&&this.renderer.setClearColor(e),null!=i&&this.renderer.setClearAlpha(i),this.renderer.clear(),this.renderer.setRenderTarget(n),e&&this.renderer.setClearColor(s),null!=i&&this.renderer.setClearAlpha(o)}disposeRenderTarget2D(t){t.texture.dispose(),t.depthTexture&&t.depthTexture.dispose(),t.dispose()}getRenderTargetData(t,e){const i=t.width,s=t.height;return e=e||new Uint8Array(i*s*4),this.renderer.readRenderTargetPixels(t,0,0,i,s,e),e}compose(t,e,i){var s;const o=Object.assign({sourceMask:P,sourceResize:!0,sourceScale:1},i),{uniforms:n}=this.composePlane.material;n.bg.value=this.isRenderTarget(e)?e.texture:e,n.mask.value=this.isRenderTarget(o.sourceMask)?o.sourceMask.texture:o.sourceMask,this.scene.add(this.composePlane);const{z:a,w:h}=null!==(s=null==t?void 0:t.viewport)&&void 0!==s?s:this.renderer.getViewport(new r.Vector4),l=n.bg.value.image.width,d=n.bg.value.image.height,c=!o.sourceResize&&(a!==l||h!==d);if(c){const t=new r.Vector3(o.sourceScale*l/a,o.sourceScale*d/h,1),e=.01,i=new r.Vector3(.5-e-.5*t.x,-.5+e+.5*t.y,0);this.composePlane.applyMatrix4((new r.Matrix4).compose(i,new r.Quaternion,t)),this.composePlane.updateMatrixWorld()}this.overrideRenderTarget(t,(()=>{this.renderer.render(this.scene,this.orthoCamera)})),this.scene.remove(this.composePlane),c&&(this.composePlane.position.set(0,0,0),this.composePlane.scale.set(1,1,1),this.composePlane.updateMatrixWorld()),n.bg.value=null,n.mask.value=null}copyTexture(t,e){return this.compose(t,e)}resizeTexture(t,e){const i=new r.WebGLRenderTarget(e,e);return t.isCompressedTexture?i.texture.format=r.RGBAFormat:i.texture.format=t.format,i.texture.addEventListener("dispose",i.dispose.bind(i)),this.copyTexture(i,t),i.texture}renderToScreen(t,e=!0,i,s){(e?Promise.resolve():this.engine.after(S.R.Render)).then((()=>{const e=this.isRenderTarget(t)?t.width:t.image.width,o=this.isRenderTarget(t)?t.height:t.image.height,n=i?i.x:this.debugRenderOffset,r=i?i.y:60;this.renderer.getViewport(this.cachedViewport),this.renderer.setViewport(n,r,e,o),this.compose(null,t,s?{sourceMask:s}:void 0),this.renderer.setViewport(this.cachedViewport),i||(this.debugRenderOffset+=e+4)}))}isRenderTarget(t){return t.isRenderTarget}renderContext(t,e){t.texture.image=e.canvas,t.texture.needsUpdate=!0}render(t,e,i,s,o=!0){const n=e.parent;if(n&&this.scene.applyMatrix4(n.matrixWorld),this.scene.add(e),t.isWebGLCubeRenderTarget){const e=new r.CubeCamera(.01,1e3,t);i.getWorldPosition(e.position),i.getWorldQuaternion(e.quaternion),this.scene.add(e),this.scene.updateMatrixWorld(),e.layers.mask=s?s.mask:i.layers.mask,e.update(this.renderer,this.scene),this.scene.remove(e)}else{i.getWorldPosition(this.camera.position),i.getWorldQuaternion(this.camera.quaternion),this.camera.projectionMatrix.copy(i.projectionMatrix),this.camera.layers.mask=s?s.mask:i.layers.mask;const e=this.renderer.getSize(this.cachedSize),n=e.width/e.height,r=t.width/t.height,a=this.camera.projectionMatrix;n>r?a.elements[0]=a.elements[5]/r:a.elements[5]=a.elements[0]*r,this.overrideRenderTarget(t,(()=>{o&&this.renderer.clear(),this.renderer.render(this.scene,this.camera)}))}return n&&(n.add(e),this.scene.matrixWorld.identity()),this.scene.remove(e),t}setScissors(t,e){if(t){if(!e)throw Error("Rect to restrict rendering to required when enabling scissors.");this.renderer.setScissorTest(!0),this.renderer.setScissor(e.x,e.y,e.width,e.height)}else{const t=this.renderer.getSize(this.cachedSize);this.renderer.setScissor(0,0,t.width,t.height),this.renderer.setScissorTest(!1)}}renderSphericalProjection(t,e,i,s,o){const n=y.circle_projection;n.uniforms.borderColor.value.copy(o||new r.Vector4(1,1,1,1)),n.uniforms.borderSize.value=s||0,n.uniforms.textureSampleScale.value=i||5,n.uniforms.panoTexture.value=t,this.scene.add(this.circleProjectionPlane),this.circleProjectionPlane.position.z=0,this.overrideRenderTarget(e,(()=>{this.renderer.render(this.scene,this.orthoCamera)})),this.scene.remove(this.circleProjectionPlane),n.uniforms.panoTexture.value=null}renderEquirectangular(t,e,i=0){const s=this.equirectProjectionPlane.material;s.uniforms.cubemap.value=t,s.uniforms.yaw.value=i,this.scene.add(this.equirectProjectionPlane),this.equirectProjectionPlane.position.z=0,this.overrideRenderTarget(e,(()=>{this.renderer.render(this.scene,this.orthoCamera)})),this.scene.remove(this.equirectProjectionPlane),s.uniforms.cubemap.value=null,s.uniforms.yaw.value=0}overrideRenderTarget(t,e){const i=this.renderTargetSwap(t);e(),this.renderTargetRestore(i)}renderTargetSwap(t){const e=this.renderer.xr.enabled,i=this.renderer.getRenderTarget(),s=this.renderer.getViewport(this.cachedViewport2);return this.renderer.xr.enabled=!1,this.renderer.setRenderTarget(t),{xr:e,rtt:i,viewport:s}}renderTargetRestore(t){this.renderer.xr.enabled=t.xr,this.renderer.setRenderTarget(t.rtt),this.renderer.setViewport(t.viewport)}async readFloatPixelsAsync(t,e){for(const e of t.textures)if(e.type!==r.FloatType||e.format!==r.RGBAFormat)throw new Error("[Render to Texture]: All Textures in WebGLRenderTarget.textures must be of type: FloatType and format: RGBAFormat");if(t.textures.length!==e.length)throw new Error("[Render To Texture]: WebGLRenderTarget.textures.length should be equal to buffers.length.");const i=e.length;for(let s=0;s<i;s++){if(e[s].length!==t.width*t.height*4)throw new Error(`[Render To Texture]: Not enough space allocated in buffer at index ${s}`)}const s=this.renderTargetSwap(t),o=this.renderer.getContext(),n=[];for(let s=0;s<i;s++){const i=e[s],r=o.createBuffer();if(null==r)throw new Error(`[Render To Texture]: glCreateBuffer failed at index ${s}`);n.push(r),o.bindBuffer(o.PIXEL_PACK_BUFFER,r),o.bufferData(o.PIXEL_PACK_BUFFER,i.byteLength,o.STREAM_READ),o.readBuffer(o.COLOR_ATTACHMENT0+s),o.readPixels(0,0,t.width,t.height,o.RGBA,o.FLOAT,0)}this.renderTargetRestore(s);const a=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);a&&(o.flush(),await this.waitUntilSync(a,4));for(let t=0;t<i;t++){const i=n[t];o.bindBuffer(o.PIXEL_PACK_BUFFER,i),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,e[t]),o.deleteBuffer(i)}return o.deleteSync(a),e}async waitUntilSync(t,e){const i=this.renderer.getContext();return new Promise((function(s,o){setTimeout((function n(){switch(i.clientWaitSync(t,i.SYNC_FLUSH_COMMANDS_BIT,0)){case i.WAIT_FAILED:o();break;case i.TIMEOUT_EXPIRED:setTimeout(n,e);break;default:s()}}),e)}))}renderAndReadAsync(t,e,i){const s=i.buffer;if(!this.renderer.capabilities.isWebGL2)return x.Ay.for(this).debug("renderAsync call webgl2, falling back to sync render/read"),this.render(t.target,t.mesh,t.camera),Promise.resolve(this.getRenderTargetData(t.target,s));const o=this.renderTargetSwap(t.target),n=this.renderer.getContext(),r=i.webglBuffer||n.createBuffer();if(!r)throw Error("Unable to create pack buffer");return n.bindBuffer(n.PIXEL_PACK_BUFFER,r),n.bufferData(n.PIXEL_PACK_BUFFER,s.byteLength,n.DYNAMIC_READ),t.clear&&this.renderer.clear(),this.renderer.render(t.mesh,t.camera),n.readPixels(e.x,e.y,e.width,e.height,n.RGBA,n.UNSIGNED_BYTE,0),n.bindBuffer(n.PIXEL_PACK_BUFFER,null),this.renderTargetRestore(o),this.cwfRenderer.fence(n).then((()=>(n.bindBuffer(n.PIXEL_PACK_BUFFER,r),n.getBufferSubData(n.PIXEL_PACK_BUFFER,0,s),n.bindBuffer(n.PIXEL_PACK_BUFFER,null),i.webglBuffer||n.deleteBuffer(r),s)))}}},46192:(t,e,i)=>{"use strict";i.d(e,{C:()=>n});var s=i(93877),o=i(56547);function n(t,e,i){const n=t&&t.hasRooms(),r=i?e.getLayer(i):e.getActiveLayer();return r&&r.layerType===s.ku.COMMON_USER_LAYER?!n:!!(0,o.XF)(e.getCurrentView())||!n}},93358:(t,e,i)=>{"use strict";i.d(e,{W:()=>s});class s{constructor(t){this.tags=[],t&&Object.assign(this,t)}}},69325:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>v});var s=i(75578),o=i(50485),n=i(12837),r=i(99583),a=i(41465),h=i(26172),l=i(20968),d=i(10843),c=i(93358);const u=new d.Ay("mds-floor-deserializer");class m{deserialize(t){var e,i,s,o;if(!t||!this.validate(t))return u.debug("Deserialized invalid room data from MDS",t),null;const n=t=>null!==t?t:void 0,r=t.dimensions||{height:null,width:null,depth:null,areaFloor:null},{height:a,width:h,depth:l,areaFloor:d}=r;return new c.W({id:t.id,meshSubgroup:t.meshId||-1,floorId:null!==(i=null===(e=t.floor)||void 0===e?void 0:e.id)&&void 0!==i?i:"",height:n(a),width:n(h),depth:n(l),areaFloor:n(d),tags:null!==(o=null===(s=t.tags)||void 0===s?void 0:s.filter((t=>t)))&&void 0!==o?o:void 0})}validate(t){const e=["id","meshId"].every((e=>e in t)),i=t.floor&&t.floor.id&&"number"==typeof t.floor.meshId;return e&&!!i}}class p extends l.g{constructor(){super(...arguments),this.prefetchKey="data.model.rooms"}async read(t){const e=new m,i={modelId:this.getViewId()};return this.query(h.GetRooms,i,t).then((t=>{var i,s;const o=null===(s=null===(i=null==t?void 0:t.data)||void 0===i?void 0:i.model)||void 0===s?void 0:s.rooms;if(!o||!Array.isArray(o))return null;return o.reduce(((t,i)=>{const s=e.deserialize(i);return s&&(t[s.id]=s),t}),{})}))}}var g=i(47737),f=i(98718),w=i(8694);class v extends s.n{constructor(){super(...arguments),this.name="room-data",this.visitedRooms={}}async init(t,e){const{baseModelId:i,baseUrl:s}=t,n=await e.market.waitForData(g.P);this.store=new p({context:n.mdsContext,baseUrl:s,readonly:!0,viewId:i});const r=await this.store.read();this.data=new o.q(r||{}),e.market.register(o.q,this.data),await this.setupRoomChangeListeners(e)}async setupRoomChangeListeners(t){const e=await t.market.waitForData(r.X),i=await this.isRoomBoundsEnabled(t);i?this.setupPIERoomChangeAnalytics(t,e,i):await this.setupLegacyRoomChangeAnalytics(t,e)}async setupPIERoomChangeAnalytics(t,e,i){const s=s=>{const o=i.rooms.size,n=this.updateVisitCounts(s.id);t.broadcast(new a.h(s.id,null,e.closestMode,n,o,"","property_layout",s.roomTypeIds))},o=await t.market.waitForData(w.y);o.currentRoom&&s(o.currentRoom);const n=o.makeCurrentRoomChangeSubscription((t=>{t&&s(t)}));this.bindings.push(n)}async setupLegacyRoomChangeAnalytics(t,e){const i=i=>{const s=this.data.roomCount,o=this.updateVisitCounts(i.id);t.broadcast(new a.h(i.id,i.meshSubgroup,e.closestMode,o,s,"","vision"))},s=await t.market.waitForData(n.A),o=s.makeSweepChangeSubscription((t=>{if(t){const e=s.getSweep(t);this.data.selected.value=e.roomId,this.data.commit()}})),r=this.data.selected.onChanged((t=>{if(null!==t){const e=this.data.get(t);e&&i(e)}}));this.bindings.push(o,r)}updateVisitCounts(t){this.visitedRooms[t]||(this.visitedRooms[t]={visitCount:0}),this.visitedRooms[t].visitCount++;return this.visitedRooms[t].visitCount}async isRoomBoundsEnabled(t){const e=await t.market.waitForData(f.A);return e.rooms.size>0?e:null}}},98217:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>M});var s=i(75578),o=i(71687),n=i(68909),r=i(91177),a=i.n(r),h=i(99515),l=i.n(h);const d={sky:{uniforms:{topColor:{value:new n.Vector3(.094,.102,.11)},bottomColor:{value:new n.Vector3(.2,.216,.235)},cameraMatrix:{value:new n.Matrix4},inverseProjectionMatrix:{value:new n.Matrix4},radius:{value:1e4}},vertexShader:a(),fragmentShader:l()}};class c extends n.ShaderMaterial{constructor(t={}){super(Object.assign({fragmentShader:d.sky.fragmentShader,vertexShader:d.sky.vertexShader,uniforms:n.UniformsUtils.clone(d.sky.uniforms),name:"SkyboxMaterial"},t))}}var u=i(36476),m=i(3694),p=i(37458),g=i(12767),f=i(81662);class w{constructor(t,e,i,s,o=u.H.ALL){this.scene=t,this.cameraData=e,this.addToRaycasting=i,this.removeFromRaycasting=s,this.renderLayer=o,this.bindings=[]}init(){const{visualMesh:t,colliderMesh:e}=this.setupSkysphere();this.skyVisual=t,this.material=this.skyVisual.material,this.skyCollider=e}dispose(){this.material.uniforms.pano0Map&&this.material.uniforms.pano0Map.value.dispose(),this.material.uniforms.pano1Map&&this.material.uniforms.pano1Map.value.dispose(),this.material.dispose(),this.skyVisual.geometry.dispose()}activate(t){this.scene.addChild(this.scene.ids.Root,this.skyVisual),this.skyVisual.updateMatrixWorld(!0),this.skyVisual.visible=!0,this.addToRaycasting(this.skyCollider,!1)}deactivate(t){for(const t of this.bindings)t.cancel();this.bindings=[],this.scene.removeChild(this.scene.ids.Root,this.skyVisual),this.scene.removeChild(this.scene.ids.CameraRig,this.skyCollider),this.removeFromRaycasting(this.skyCollider)}updateBackgroundColors(t,e){const i=new n.Color(t),s=new n.Color(e);this.material.uniforms.topColor.value.set(i.r,i.g,i.b),this.material.uniforms.bottomColor.value.set(s.r,s.g,s.b)}beforeRender(){this.skyCollider.position.copy(this.cameraData.pose.position),this.material.uniforms.cameraMatrix.value.compose(this.cameraData.pose.position,this.cameraData.pose.rotation,f.B1.UNIT),this.material.uniforms.inverseProjectionMatrix.value.copy(this.cameraData.pose.projection.asThreeMatrix4()),this.material.uniforms.inverseProjectionMatrix.value.invert()}render(){}setupSkysphere(t){const e=new n.SphereGeometry(1e4,5,5);e.computeBoundingBox();const i=g.Bv.far-10,s=new Float32Array([-1,1,0,-1,-1,0,1,-1,0,1,1,0]),o=new n.BufferGeometry;o.setAttribute("position",new n.Float32BufferAttribute(s,3)),o.setIndex([0,1,2,0,2,3]),t||(t=new c({side:n.FrontSide}));const r=new m.W(o,t);r.layers.mask=this.renderLayer.mask,r.name="Skysphere",r.renderOrder=p.X.boundingSkybox,r.updateMatrixWorld(!0),r.frustumCulled=!1,t.uniforms.radius.value=i,t.depthWrite=!1,t.depthTest=!1;return{visualMesh:r,colliderMesh:new m.W(e,new n.MeshBasicMaterial({opacity:0,depthWrite:!1,side:n.BackSide}))}}}var v=i(59758),y=i(5601),D=i(56208),b=i(20599);class M extends s.n{constructor(){super(...arguments),this.name="skybox-module"}async init(t,e){const[i,s,n,r]=await Promise.all([e.getModuleBySymbol(o.M7),e.market.waitForData(v.o),e.getModuleBySymbol(o.mL),e.market.waitForData(b.M)]),a=e.claimRenderLayer("skybox"),h=i.getScene();this.skybox=new w(h,r,n.registerMesh,n.unregisterMesh,a),e.addComponent(this,this.skybox);const l=s.tryGetSetting(D.Q$.BackgroundColor,y.v.default);this.skybox.updateBackgroundColors(y.t[l].bgPrimary,y.t[l].bgSecondary),this.bindings.push(s.onSettingChanged(D.Q$.BackgroundColor,(t=>{this.skybox.updateBackgroundColors(y.t[t].bgPrimary,y.t[t].bgSecondary)})))}}},11018:(t,e,i)=>{"use strict";i.d(e,{A:()=>o});var s=i(89103);class o extends s.QB{constructor(t,e,i){super(),this.size=t,this.sweepId=e,this.renderTarget=i}}},18136:(t,e,i)=>{"use strict";i.r(e),i.d(e,{AssetDockedMessage:()=>m.I7,AssetUndockedMessage:()=>m.f1,CloseAndRemoveToolsCommand:()=>u._S,CloseCurrentToolCommand:()=>u.Te,CloseToolCommand:()=>u.u3,CollapseBottomPanelCommand:()=>u.oe,OpenInitialToolCommand:()=>u.M_,OpenPreviousToolCommand:()=>u.kC,OpenToolCommand:()=>u.Wm,PanelCollapseMessage:()=>m.rP,PanelTransitionEndMessage:()=>m._5,RegisterToolsCommand:()=>u.Kw,SetAppBarVisibleMessage:()=>m.k_,ToggleToolCommand:()=>u.yU,ToggleViewingControlsMessage:()=>m.Vk,Tool:()=>C.N,ToolAnnouncement:()=>d.Q7,ToolAnnouncementState:()=>d.zR,ToolPalette:()=>d.o6,ToolPanelLayout:()=>d.L$,ToolToggleCollapseCommand:()=>u.li,Tools:()=>d.S0,ToolsData:()=>l.M,default:()=>B});var s=i(75578),o=i(71687),n=i(27947);var r=i(20599),a=i(99583),h=i(3035),l=i(96319),d=i(73566),c=i(66355),u=i(17084),m=i(20246),p=i(66846),g=i(50178),f=i(12103),w=i(97573),v=i(59758),y=i(81088),D=i(29106),b=i(56147),M=i(79070),S=i(71188),T=i(58480),x=i(10843);class P extends s.n{constructor(){super(...arguments),this.name="tools-module",this.toolsData=new l.M,this.activeToolDurationMap={},this.bottomPanelHeight=0,this.sidePanelWidth=0,this.sidePanelLeft=0,this.initialUrlToolOpened=!1,this.toolClosing=!1,this.closeAndRemoveTools=async t=>!(t&&!await this.deactivateCurrentTool())&&(this.closeModal(),this.toolsData.setActiveTool(null),this.toolsData.removeAllTools(),!0),this.onAssetDocked=()=>{this.toolsData.assetDocked=!0,this.toolsData.commit()},this.onAssetUndocked=()=>{this.toolsData.assetDocked=!1,this.toolsData.commit()},this.onToggleModal=async t=>{this.toggleModal(t.modal,t.open)},this.closeModal=()=>{this.toolsData.openModal&&this.toggleModal(this.toolsData.openModal,!1)},this.allowToolOrViewChange=async()=>{var t;const e=this.toolsData.getActiveTool();if(!(null===(t=null==e?void 0:e.manager)||void 0===t?void 0:t.hasPendingEdits))return!0;if(await e.manager.hasPendingEdits()){const t={title:b.A.TOOLS.UNSAVED_CHANGES_TITLE,message:b.A.TOOLS.UNSAVED_CHANGES_MESSAGE,cancellable:!0,confirmPhraseKey:b.A.TOOLS.UNSAVED_CHANGES_CONFIRM,cancelPhraseKey:b.A.TOOLS.UNSAVED_CHANGES_CANCEL};return await this.engine.commandBinder.issueCommand(new y.nX(D.Y.DISPLAY,t))===D.$.CLOSE}return!0},this.toggleTool=async({toolName:t,active:e})=>e?this.openTool(t,!1):this.closeTool(t),this.closeCurrentTool=async()=>!!await this.deactivateCurrentTool()&&(this.toolsData.setActiveTool(null),!0),this.openInitialTool=async()=>{var t;const e=(0,p.X)(this.settingsData,this.initialUrlToolOpened);if(e){const i=this.toolsData.getTool(e);if(i){const s=(0,p.I)(this.settingsData,i);s&&(null===(t=i.manager)||void 0===t?void 0:t.deepLink)?i.manager.deepLink(s):this.engine.commandBinder.issueCommandWhenBound(new u.yU(e,!0))}}this.initialUrlToolOpened=!0},this.openPreviousTool=async()=>{this.toolsData.softOpening=!1,this.toolsData.commit();const t=this.toolsData.previousToolName;if(null===t)return;const e=this.toolsData.getTool(t)||null;null!==e?await this.deactivateCurrentTool(e)&&(await this.activateTool(e),this.toolsData.setActiveTool(t)):x.Ay.for(this).error(`Tool not loaded: ${t}`)},this.updateLayoutSize=()=>{const{toolPanelLayout:t}=this.toolsData;let e=t;const i=this.isSidePanelLayout();switch(t){case d.L$.NORMAL:i||(e=d.L$.NARROW);break;case d.L$.SIDE_PANEL:i||(e=d.L$.BOTTOM_PANEL);break;case d.L$.NARROW:i&&(e=d.L$.NORMAL);break;case d.L$.BOTTOM_PANEL:i&&(e=d.L$.SIDE_PANEL)}e!==t?(this.toolsData.toolPanelLayout=e,this.toolsData.commit()):t===d.L$.BOTTOM_PANEL&&this.adjustCanvasForPanel()},this.handleToolCollapse=async t=>{t!==this.toolsData.toolCollapsed&&(this.toolsData.toolCollapsed=t,this.toolsData.commit(),t||this.toolsData.toolPanelLayout!==d.L$.BOTTOM_PANEL||this.closeModal(),this.engine.broadcast(new m.rP(t)))},this.handleBottomPanelCollapse=async t=>{if(this.toolsData.toolPanelLayout===d.L$.BOTTOM_PANEL)return this.handleToolCollapse(t.collapse)},this.adjustCanvasForPanelActual=async()=>{const{toolPanelLayout:t,toolCollapsed:e,assetDocked:i,openModal:s}=this.toolsData,{sidePanelWidth:o,bottomPanelHeight:n,sidePanelLeft:r}=this,a=this.toolsData.getActiveTool(),h=t===d.L$.SIDE_PANEL,l=a&&h&&!e,u=l&&!!(null==a?void 0:a.panelLeft),m=l?-f._2:0,p=m!==o?m:void 0,g=u?f._2:0,v=g!==r?g:void 0,y=t===d.L$.BOTTOM_PANEL&&!s&&i,D=-Math.floor((this.containerData.size.height-55)*c.P6/100),b=y?D:0,M=b!==n?b:void 0,S=0===p||0===M?0:c.Cp;this.resizeCanvas((0,w.v6)(p,M,v,S)),this.bottomPanelHeight=b,this.sidePanelWidth=m,this.sidePanelLeft=g},this.adjustCanvasForPanel=(0,M.s)(this.adjustCanvasForPanelActual,50),this.resizeCanvas=async t=>{await this.canvasModule.resizeCanvas(t)}}async init(t,e){this.engine=e,await e.getModuleBySymbol(o.$c),this.analytics=await e.getModuleBySymbol(o.aF),[this.settingsData,this.appData,this.containerData,this.canvasModule]=await Promise.all([e.market.waitForData(v.o),e.market.waitForData(n.zH),e.market.waitForData(T.G),e.getModuleBySymbol(o.CE)]),this.updateLayoutSize(),this.bindings.push(e.commandBinder.addBinding(u.yU,this.toggleTool),e.commandBinder.addBinding(u.kC,this.openPreviousTool),e.commandBinder.addBinding(u.Wm,(async t=>this.openTool(t.toolName,t.softOpening))),e.commandBinder.addBinding(u.M_,this.openInitialTool),e.commandBinder.addBinding(u.u3,(async t=>this.closeTool(t.toolName))),e.commandBinder.addBinding(u.Te,this.closeCurrentTool),e.commandBinder.addBinding(y.X6,this.onToggleModal),e.commandBinder.addBinding(y.rH,(async()=>this.closeModal())),e.commandBinder.addBinding(u.li,(async t=>{this.handleToolCollapse(t.collapse)})),e.commandBinder.addBinding(u.oe,this.handleBottomPanelCollapse),this.containerData.onPropertyChanged("size",this.updateLayoutSize),e.subscribe(m.I7,this.onAssetDocked),e.subscribe(m.f1,this.onAssetUndocked),this.toolsData.onPropertyChanged("toolPanelLayout",this.adjustCanvasForPanel),this.toolsData.onPropertyChanged("activeToolName",this.adjustCanvasForPanel),this.toolsData.onPropertyChanged("toolCollapsed",this.adjustCanvasForPanel),this.toolsData.onPropertyChanged("assetDocked",this.adjustCanvasForPanel),e.commandBinder.addBinding(u._S,(({checkForEdits:t})=>this.closeAndRemoveTools(t))),e.commandBinder.addBinding(u.Kw,(async({tools:t})=>this.registerTools(...t)))),t.registerConfirmViewChange&&t.registerConfirmViewChange(this.allowToolOrViewChange),e.market.register(l.M,this.toolsData)}dispose(t){super.dispose(t),this.closeAndRemoveTools(!1),t.market.unregister(l.M)}registerTools(...t){t.forEach((t=>{t.featureFlag&&this.bindings.push(this.settingsData.onSettingChanged(t.featureFlag,(()=>this.updateEnabledTools())))})),this.toolsData.addTool(...t)}registerToolUi(t,e){this.toolsData.addToolUi(t,e)}unregisterToolUi(t,e){this.toolsData.removeToolUi(t,e)}closePanel(){this.toolsData.toolPanelLayout=this.isSidePanelLayout()?d.L$.NORMAL:d.L$.NARROW,this.toolsData.commit()}openPanel(t){if(!t.panel)return this.toolsData.toolCollapsed=!!t.panelBar,void this.toolsData.commit();const e=this.isSidePanelLayout();this.toolsData.toolPanelLayout=e?d.L$.SIDE_PANEL:d.L$.BOTTOM_PANEL;const i=!e&&!this.toolsData.softOpening;this.toolsData.toolCollapsed=i,this.toolsData.commit()}toggleModal(t,e){const{openModal:i,toolPanelLayout:s}=this.toolsData;if(e&&i===t||!e&&t!==i)return;const o=t.toLowerCase(),r=this.appData.application===n.lg.WORKSHOP?"workshop_gui":"showcase_gui";this.analytics.track(r,{gui_action:`open_${o}`}),t&&this.analytics.track("modal_shown",{modal:t}),this.toolsData.openModal=e?t:null,this.toolsData.commit(),s===d.L$.BOTTOM_PANEL&&e!==!!i&&this.adjustCanvasForPanel(),this.engine.broadcast(new g.rn(t,e))}async activateTool(t){if(this.toolInit)throw new Error("Current tool has not finished initializing!");this.toolsData.toolChangeInProgress=!0,this.toolsData.commit(),this.closeModal(),this.openPanel(t),t.manager&&(this.toolInit=t.manager.activate(),await this.toolInit,this.toolInit=null),this.toolsData.toolChangeInProgress=!1,this.toolsData.commit(),this.startTrackingTool(t)}async deactivateCurrentTool(t,e=!0){if(this.toolClosing)return!1;this.toolClosing=!0;const i=this.toolsData.getActiveTool();if(!i)return this.toolClosing=!1,!0;if(await this.toolInit,e&&!await this.allowToolOrViewChange())return this.toolClosing=!1,!1;this.engine.broadcast(new g.XR(!0)),i.manager?(this.toolsData.toolChangeInProgress=!0,this.toolsData.commit(),await i.manager.deactivate(),this.toolsData.toolChangeInProgress=!1,this.toolsData.commit(),this.engine.broadcast(new g.XR(!1))):setTimeout(this.engine.broadcast,100,new g.XR(!1)),this.closeModal();const s=this.toolsData.toolPanelLayout===d.L$.BOTTOM_PANEL||this.toolsData.toolPanelLayout===d.L$.NARROW||(null==t?void 0:t.panelLeft)===i.panelLeft;return!(t&&t.panel&&t.panel===i.panel&&s)&&this.closePanel(),this.toolClosing=!1,this.stopTrackingTool(i),!0}async activateToolName(t,e){const{activeToolName:i,toolChangeInProgress:s}=this.toolsData;if(s)return;if(i===t)return this.toolsData.softOpening=e,void this.toolsData.commit();const o=this.toolsData.getTool(t)||null;if(null===o)return void x.Ay.for(this).error(`Tool not loaded: ${t}`);const[n,l]=await Promise.all([this.engine.market.waitForData(r.M),this.engine.market.waitForData(a.X)]);await(0,h.L)(n,l),await this.deactivateCurrentTool(o)&&(await(0,h.L)(n,l),this.toolsData.softOpening=e,this.toolsData.commit(),await this.activateTool(o),this.toolsData.setActiveTool(o.id))}async deactivateToolName(t,e){t===this.toolsData.activeToolName&&await this.deactivateCurrentTool(e)&&this.toolsData.setActiveTool(null)}async openTool(t,e){await this.activateToolName(t,e)}async closeTool(t){await this.deactivateToolName(t)}startTrackingTool(t){this.activeToolDurationMap[t.analytic]=Date.now()}stopTrackingTool(t){const{analytic:e}=t;this.activeToolDurationMap[e]=Date.now()-this.activeToolDurationMap[e];const i={tool:`${e}_session_time`,duration:this.activeToolDurationMap[e]};this.analytics.track("tool_session_time",i)}updateEnabledTools(){const t=this.toolsData.toolsMap;t.atomic((()=>{for(const e of t)if(e.featureFlag){const t=this.settingsData.tryGetSetting(e.featureFlag,!1);e.enabled!==t&&(e.enabled=t,e.commit())}}))}isSidePanelLayout(){return!(0,S.w)(this.containerData.size)}}var C=i(23864);const B=P},15506:(t,e,i)=>{"use strict";i.d(e,{Ux:()=>l,j7:()=>h,nl:()=>a,np:()=>c,vr:()=>d,zc:()=>r});var s=i(74381),o=i(13893),n=i(1333);const r={[s.ES.FADE_TO_BLACK]:o.fl.FadeToBlack,[s.ES.INSTANT]:o.fl.Instant,[s.ES.INTERPOLATE]:o.fl.Interpolate},a={[s.Zw.LEFT]:n.ND.Left,[s.Zw.RIGHT]:n.ND.Right,[s.Zw.AUTO]:n.ND.Auto},h={[s.h6.START]:"start",[s.h6.CENTER]:"center"},l={[o.fl.FadeToBlack]:s.ES.FADE_TO_BLACK,[o.fl.Instant]:s.ES.INSTANT,[o.fl.Interpolate]:s.ES.INTERPOLATE,[o.fl.MoveToBlack]:s.ES.FADE_TO_BLACK,[o.fl.OrbitTo]:s.ES.INTERPOLATE},d={[n.ND.Left]:s.Zw.LEFT,[n.ND.Right]:s.Zw.RIGHT,[n.ND.Auto]:s.Zw.AUTO},c={start:s.h6.START,center:s.h6.CENTER}},30794:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>P});var s=i(75578),o=i(71687),n=i(59758),r=i(2993),a=i(13893),h=i(22278),l=i(81662),d=i(68909),c=i(40397),u=i(12837),m=i(78229),p=i(96659),g=i(20599),f=i(56208),w=i(9997),v=i(27947),y=i(22585),D=i(26482),b=i(39209),M=i(9231),S=i(46793),T=i(15580),x=i(10843);class P extends s.n{constructor(){super(...arguments),this.name="viewmode-change",this.recenterFloorplanModeSwitch=!0}async init(t,e){this.engine=e,this.viewmodesModule=await e.getModuleBySymbol(o.SD),this.bindings.push(e.subscribe(y.E5,(t=>this.setEnabledModes(t.application))),e.commandBinder.addBinding(S.S2,this.onChangeViewmodeCommand.bind(this)));const[i,s]=await Promise.all([e.market.waitForData(v.zH),e.market.waitForData(n.o)]);this.settings=s,(0,T.sj)(s,t.inWorkshop),(0,T.cW)(s,t.inWorkshop),this.setEnabledModes(i.application),this.bindings.push(s.onSettingChanged(f.Q$.FloorPlan,(()=>(0,T.sj)(s,t.inWorkshop))),s.onSettingChanged(f.Q$.Dollhouse,(()=>(0,T.cW)(s,t.inWorkshop))))}setShouldRecenterFloorplan(t){this.recenterFloorplanModeSwitch=t}async setEnabledModes(t){const e=await this.engine.getModuleBySymbol(o.zj);if(t===v.lg.SHOWCASE){if(this.viewmodesModule.data.isDollhouseDisabled=()=>!this.settings.tryGetSetting(T.n9,!1),this.viewmodesModule.data.isFloorplanDisabled=()=>!this.settings.tryGetSetting(T._z,!1),e.setDollhouseVerticalLimits({noTransition:!0}),this.previousApp){const t=await this.engine.market.waitForData(g.M),e=this.viewmodesModule.data.peekabooCorrectedMode(t);if(e===r.N3.Dollhouse&&this.viewmodesModule.data.isDollhouseDisabled()||e===r.N3.Floorplan&&this.viewmodesModule.data.isFloorplanDisabled()){const e=(await this.engine.market.waitForData(D.G)).pose;if(e&&(0,r.nI)(e.mode))this.goToInsideMode(a.fl.Interpolate,{position:e.camera.position},e.mode);else{const e=t.pose,i=(await this.engine.market.waitForData(u.A)).getClosestSweep(e.position,!0),s=i?{position:i.position}:void 0;this.goToInsideMode(a.fl.Interpolate,s,r.N3.Panorama)}}}}else t===v.lg.WORKSHOP&&(this.viewmodesModule.data.isDollhouseDisabled=()=>!1,this.viewmodesModule.data.isFloorplanDisabled=()=>!1,e.setDollhouseVerticalLimits({noTransition:!0}));this.previousApp=t}async onChangeViewmodeCommand(t){try{switch(t.mode){case S.w5.INSIDE:return this.goToInsideMode(t.transitionType,t.pose,r.N3.Panorama,t.transitionTime);case S.w5.DOLLHOUSE:return this.goToDollhouse(t.transitionType,t.pose,t.transitionTime);case S.w5.FLOORPLAN:return this.goToFloorplan(t.transitionType,t.pose,t.transitionTime);case S.w5.ORTHOGRAPHIC:return this.goToOrthographic(t.transitionType,t.pose,t.transitionTime);case S.w5.MESH:return this.goToInsideMode(t.transitionType,t.pose,r.N3.Mesh,t.transitionTime)}}catch(e){throw x.Ay.for(this).error(e),new M.FA(`Could not move to mode ${t.mode}`,e)}}async goToInsideMode(t=a.fl.Interpolate,e={},i,s){const o=this.engine.market.tryGetData(u.A);if(!o)throw new M.dj;if(!(0,r.nI)(i))throw new M.dj;let n=e.sweepID||o.state.currentSweep;if(n||(n=await this.getLookAtSweep(o)),o.isSweepUnaligned(n)){const t=o.getFirstAlignedSweep();n=t?t.id:this.getFirstSweepId(o)}return(0,r.nI)(this.viewmodesModule.currentMode)&&o.isSweepUnaligned(o.state.currentSweep)?this.engine.commandBinder.issueCommand(new w.aj({sweep:n,viewId:e.viewId,rotation:e.rotation,transition:a.fl.FadeToBlack})):this.viewmodesModule.switchToMode(i,t,{sweepID:n,viewId:e.viewId,rotation:e.rotation},s)}async getLookAtSweep(t){const e=this.engine.market.tryGetData(g.M);if(!e)return this.getFirstSweepId(t);const i=this.engine.market.tryGetData(b.X),s=(null==i?void 0:i.getFloorMin())||this.getModelMinHeight(),o=new d.Plane(l.B1.DOWN,s),n=(0,c.qK)(e.pose.position,e.pose.rotation,o);if(!n)return this.getFirstSweepId(t);const r=[m.Zx(),m.Ol(),t=>!i||i.isCurrentOrAllFloors(t.floorId)],a=[p.cv(n)],h=t.sortByScore(r,a).shift();if(h)return h.sweep.id;const u=t.getClosestSweep(n,!0);return u?u.id:this.getFirstSweepId(t)}getFirstSweepId(t){const e=t.getFirstSweep();if(void 0===e)throw new Error("First enabled sweep not found");return e.id}getModelMinHeight(){return this.meshData||(this.meshData=this.engine.market.tryGetData(h.U)),this.meshData?this.meshData.extendedBounds.min.y:0}async goToDollhouse(t=a.fl.Interpolate,e={},i){if(this.viewmodesModule.data.isDollhouseDisabled())throw new M.dj;return this.viewmodesModule.switchToMode(r.N3.Dollhouse,t,e,i)}async goToFloorplan(t=a.fl.Interpolate,e={},i){if(this.viewmodesModule.data.isFloorplanDisabled())throw new M.dj;const s=await this.engine.getModuleBySymbol(o.CE);return s&&await s.getTransitionPromise(),this.viewmodesModule.switchToMode(r.N3.Floorplan,t,e,i,this.recenterFloorplanModeSwitch)}async goToOrthographic(t=a.fl.Interpolate,e={},i){const s=await this.engine.getModuleBySymbol(o.CE);return s&&await s.getTransitionPromise(),this.viewmodesModule.switchToMode(r.N3.Orthographic,t,e,i)}}},9231:(t,e,i)=>{"use strict";i.d(e,{FA:()=>h,Xy:()=>n,dj:()=>a,ke:()=>r});var s=i(27960);class o extends s.d{constructor(t="Unhandled Viewmode Exception",e){super(t),this.originalError=e,this.name="ViewmodeException"}}class n extends o{constructor(t="Tried to start view-mode transition while another transition was active"){super(t),this.name="ViewmodeActiveTransition"}}class r extends o{constructor(t="Cannot change viewmode when locked"){super(t),this.name="ViewmodeLocked"}}class a extends o{constructor(t="Cannot change to disabled/invalid viewmode"){super(t),this.name="ViewmodeInvalid"}}class h extends o{constructor(t="Unhandled Error processing viewmode change command",e){super(t,e),this.name="ViewmodeCommandException"}}},6002:(t,e,i)=>{"use strict";i.r(e),i.d(e,{SMALL_ROTATION_DISTANCE:()=>V,SMALL_TRANSLATION_DISTANCE:()=>I,default:()=>N});var s=i(71687),o=i(2993),n=i(13893),r=i(68909),a=i(81662),h=i(4330),l=i(12767),d=i(75578),c=i(99583),u=i(20599),m=i(12837),p=i(1197),g=i(98309),f=i(45862),w=i(9231),v=i(31093),y=i(40397),D=i(53172),b=i(19968);const M=(t,e,i,s)=>{const o=i.clone().multiply((new r.Quaternion).setFromAxisAngle(a.B1.RIGHT,60*D.fy)),n=a.B1.FORWARD.clone().applyQuaternion(o).multiplyScalar(-1*t),h=e.clone().add(n);return s.position=h,s.rotation=o,t},S=t=>{const e=t.getCenter(new r.Vector3);return t.max.distanceTo(e)/Math.tan(l.Bv.fov/2*D.fy)};var T=i(37105),x=i(46771),P=i(94814),C=i(15930),B=i(22278),F=i(304),O=i(62568),A=i(49155),k=i(10843);const I=.2,V=3*D.fy,E=[o.N3.Mesh,o.N3.Panorama,o.N3.Floorplan,o.N3.Dollhouse,o.N3.Orthographic],R={[o.N3.Mesh]:C.Ou,[o.N3.Panorama]:C.Ou,[o.N3.Dollhouse]:C.Ou,[o.N3.Floorplan]:C.Ou,[o.N3.Orthographic]:C.Ou};class N extends d.n{constructor(){super(...arguments),this.name="viewmode",this.data=new c.X,this.minDollhouseDistance=15,this.maxDollhouseDistance=50,this._orthoMatrix=new x.k,this.snapToPhiLimit=(t,e)=>this.cameraModule.moveTo({transitionType:n.fl.OrbitTo,transitionTime:e,pose:{},autoOrtho:!0,targetPhi:t}),this.getFlyinStartPose=(t,e,i=this.cameraData)=>{var s;const o=null!==(s=t.position)&&void 0!==s?s:new r.Vector3,n=e||i.pose.position,h=o.y-n.y,l=(0,y.bw)(o,n,this.visibleMeshBounds.getCenterOfMass()),d=a.B1.FORWARD.clone().applyQuaternion(l),c=Math.sign(d.y)*Math.PI/4;return{position:(0,y.fR)(o,n,c,!0).setY(1.5*h)}},this.getFlyinEndPose=async t=>{var e,i;const s=t.position||(null===(i=this.sweepData.getSweep(null!==(e=t.sweepID)&&void 0!==e?e:"invalid"))||void 0===i?void 0:i.position)||new r.Vector3,o=t.rotation||new r.Quaternion,n=Math.PI/180*l.Bv.fov;return await this.visibleMeshBounds.initialDataLoaded,(0,y.hm)({targetPosition:s,targetRotation:o,angleDown:-Math.PI/6,box:this.visibleMeshBounds.getVisibleBounds(),fovY:n,aspectRatio:this.canvas.aspectRatio})}}async init(t,e){var i;this.engine=e,this.market=e.market,this.data.currentMode=null!==(i=t.startingMode)&&void 0!==i?i:o.N3.Dollhouse,this.market.register(c.X,this.data),e.market.waitForData(B.U).then((t=>{this.meshData=t,this.setDollhouseBounds()})),this.bindings.push(e.commandBinder.addBinding(F.x,this.lockViewmode.bind(this)),e.commandBinder.addBinding(F._,this.unlockViewmode.bind(this)));const[n,r,a,h,l,d,p]=await Promise.all([e.getModuleBySymbol(s.jh),e.getModuleBySymbol(s.Wh),e.getModuleBySymbol(s.Qm),e.getModuleBySymbol(s.UN),e.market.waitForData(m.A),e.market.waitForData(T.p),e.market.waitForData(u.M)]);this.cameraModule=n,this.sweepModule=r,this.visibleMeshBounds=h,this.sweepData=l,this.canvas=d,this.cameraData=p,this.viewportModule=a}lockViewmode(){this.data.viewmodeChangeEnabled=!1,this.data.commit()}unlockViewmode(){this.data.viewmodeChangeEnabled=!0,this.data.commit()}get currentMode(){return this.data.currentMode}async switchToMode(t,e=n.fl.FadeToBlack,i,r,a,h=this.cameraData,l=this.sweepData.state.currentObservable){k.Ay.for(this).debug(`switchToMode mode:${o.N3[t]} type:${n.fl[e]}`);const d=this.fixHighPhiPose(t,i),c=!d||d&&!N.willPoseChange(h,d);if(this.isAlreadyInMode(t)&&c)return;if(!E.includes(t)||this.data.isFloorplanDisabled()&&t===o.N3.Floorplan||this.data.isDollhouseDisabled()&&t===o.N3.Dollhouse)throw new w.dj(`Cannot change to invalid viewmode ${t}`);this.meshData||t!==o.N3.Floorplan&&t!==o.N3.Dollhouse||await(await this.engine.getModuleBySymbol(s.GR)).firstMeshLoadPromise;const u=!h.canTransition();if(!this.data.canStartTransition()||u)throw new w.Xy;if(t!==this.currentMode&&!this.data.viewmodeChangeEnabled)throw new w.ke;this.engine.broadcast(new A.A(t)),l.currentSweep&&this.sweepData.isSweepUnaligned(l.currentSweep)&&!(0,o.nI)(t)&&(e=n.fl.FadeToBlack);let m=void 0!==r?r:R[t],y=0;e!==n.fl.Instant&&e!==n.fl.FadeToBlack||(e===n.fl.FadeToBlack&&(y=m),m=0);const D=y>0;let M=t;t===o.N3.Floorplan&&(M=o.N3.Dollhouse),D&&(e=n.fl.Instant);const S=Object.assign({},this.data.transition),T=this.data.currentMode,x=()=>{const e=t===o.N3.Floorplan?0:1;this.data.transition.active=!0,this.data.activateTransition(this.data.currentMode,M,m,h.pose.pitchFactor(),e),this.data.currentMode=o.N3.Transition,this.data.commit(),this.engine.broadcast(new g.A(M,null!=T?T:void 0))};let P=!1;const C=t=>{this.data.transition.progress=t,this.data.commit(),t>=.5&&!P&&(P=!0,this.engine.broadcast(new f.Y(M,null!=T?T:void 0)))},B=()=>{this.data.transition.active=!1,this.data.transition.progress=1,this.data.currentMode=M,this.data.deactivateTransition(),this.data.commit()},F=async(t,e)=>{if(D){const i=this.cameraModule.moveTo({transitionType:n.fl.FadeToBlack,fadeToBlackSubType:t,pose:{},transitionTime:y/2});i.progress((t=>C(e+t/2))),await i}},O=(0,b.aY)(h.pose.pitchFactor()),I=d&&d.position&&d.rotation;let V=!1;const _=T===o.N3.Dollhouse||T===o.N3.Floorplan,L=[];O&&t===o.N3.Dollhouse?(I||(V=!0),L.push((()=>this.snapToPhiLimit(n.mG.Bottom,m)))):!_||t!==o.N3.Floorplan||I||a?O&&_&&(t===o.N3.Panorama||t===o.N3.Mesh)&&L.push((()=>this.snapToPhiLimit(n.mG.Bottom,m))):(I||(V=!0),L.push((()=>this.snapToPhiLimit(n.mG.Top,m))));let z=null,U=!1;if(!V||a){let i=d;switch(t){case o.N3.Mesh:case o.N3.Panorama:const s=[];for(const t of this.viewportModule.viewportManager.viewports){const i=this.cameraModule.getCameraDataForViewport(t),o=this.sweepData.getStateForViewport(t.id);i===this.cameraModule.getNonProxiedCameraData(h)&&o===l?s.push((()=>this.moveCameraToPanorama(T,e,m,d,h,l))):o.currentSweep&&s.push((()=>this.moveCameraToPanorama(T,e,m,void 0,i,o)))}const n=new v.i;z=()=>{const t=s.map((t=>t())),e=t[0];return null==e||e.progress((t=>{n.notify(t)})),Promise.all(t).then((()=>{n.notify(1),n.resolve()})),n.promise()};break;case o.N3.Floorplan:const r=O||0===m;if(i=this.getPeekabooDollhousePoseFromFloorplanPose(d,r),r&&i){h.setAutoOrtho(!0),z=()=>i?this.cameraModule.moveTo({transitionType:e,pose:i,transitionTime:m,focalDistance:i.focalDistance,autoOrtho:!0}):v.i.resolve();break}U=!0;case o.N3.Dollhouse:h.setAutoOrtho(!0),z=()=>this.moveCameraToDollhouse(e,m,i,U,h);break;case o.N3.Orthographic:h.setAutoOrtho(!1),z=()=>this.moveCameraToOrthographic(null!=T?T:void 0,e,m,d);break;default:throw new w.dj(`Invalid target mode ${t}`)}}z&&L.push(z),(!O&&T!==o.N3.Dollhouse&&t===o.N3.Floorplan||U)&&L.push((()=>this.snapToPhiLimit(n.mG.Top,m)));try{const t=L.length;x(),await F(n.pw.ClearToBlack,0);for(let e=0;e<t;e++){const i=e/t,s=L[e]();D||s.progress((e=>C(e/t+i))),await s}await F(n.pw.BlackToClear,.5),B()}catch(t){throw this.data.currentMode=T,this.data.transition=S,this.data.commit(),t}V||this.engine.broadcast(new p.A(M,null!=T?T:void 0))}isAlreadyInMode(t){const{data:e}=this,i=e.transition.from===e.transition.to;let s=e.currentMode===t;const n=e.currentMode===o.N3.Floorplan||e.currentMode===o.N3.Dollhouse;let r=e.currentMode;return n&&(r=(0,b.aY)(this.cameraData.pose.pitchFactor())?o.N3.Floorplan:o.N3.Dollhouse),s=r===t,e.transition.active&&i||s}static willPoseChange(t,e){return void 0!==e.position&&!t.pose.position.equals(e.position)||void 0!==e.rotation&&!t.pose.rotation.equals(e.rotation)||void 0!==e.zoom&&t.zoom()!==e.zoom}moveCameraToPanorama(t,e,i,s,n=this.cameraData,h=this.sweepData.state){var d,c;let u=null!==(d=null==s?void 0:s.sweepID)&&void 0!==d?d:h.currentSweep;u||(u=null===(c=this.sweepData.getFirstSweep())||void 0===c?void 0:c.id);let m=null==s?void 0:s.rotation;if(!m){const e=(t===o.N3.Floorplan?a.B1.UP:a.B1.FORWARD).clone().applyQuaternion(n.pose.rotation).setY(0).normalize();m=(new r.Quaternion).setFromUnitVectors(a.B1.FORWARD,e)}const p=(0,l.hn)(this.cameraData.aspect());return this.sweepModule.moveToSweep({transitionType:e,sweepId:u,viewId:null==s?void 0:s.viewId,rotation:m,transitionTime:i,rotationDelay:.5,projection:p,cameraData:n,sweepDataState:h})}moveCameraToDollhouse(t,e,i,s=!1,n=this.cameraData){var h;const d=this.visibleMeshBounds.getVisibleBounds(),c=this.visibleMeshBounds.getCenterOfMass(),u={};let m,p=e;if(i&&(i.position||i.rotation)){if(i.position&&i.rotation){u.position=i.position,u.rotation=i.rotation;const t=(new r.Vector3).copy(c);if((0,b.rC)(i.rotation)*D.tm>5){const e=Math.min(c.y,i.position.y-1),s=new r.Plane(a.B1.UP.clone(),e),o=(0,y.qK)(u.position,u.rotation,s);o&&t.copy(o)}m=u.position.distanceTo(t),u.rotation=(0,y.kf)(i.position,t)}else if(i.position)u.position=i.position,u.rotation=(0,y.kf)(i.position,c);else{u.rotation=null!==(h=i.rotation)&&void 0!==h?h:new r.Quaternion;const t=d.min.distanceTo(d.max);u.position=(0,y.fg)(u.rotation,c,t)}m||(m=c.clone().distanceTo(u.position))}else{const t=this.sweepData.isSweepUnaligned(this.sweepData.state.currentSweep);let e=n.pose.position;if(t||this.data.transition.from===o.N3.Floorplan?e=c:this.data.transition.from===o.N3.Dollhouse&&(e=n.pose.focalPoint().clone().add(new r.Vector3(0,1,0))),this.data.transition.from!==o.N3.Floorplan){const t=((t,e,i,s,o=!1)=>{const n=30*D.fy,h=s<1,l=1.2*S(i),d=t.clone().add(new r.Vector3(0,-1,0)),c=(0,b.rC)(e),u=e.clone().multiply((new r.Quaternion).setFromAxisAngle(a.B1.RIGHT,c));let m=u;if(o){const t=i.getCenter(new r.Vector3);d.x=t.x,d.z=t.z;const e=i.getSize(new r.Vector3),s=e.x/e.z<1,o=a.B1.FORWARD.clone().applyQuaternion(u).normalize(),n=h===s?new r.Vector3(0,0,-(Math.sign(o.z)||1)):new r.Vector3(-(Math.sign(o.x)||1),0,0);m=(0,y.LM)(new r.Quaternion,(new r.Vector3).crossVectors(a.B1.UP,n),a.B1.UP,n),d.add(n.clone().multiplyScalar(1))}const p=m.multiply((new r.Quaternion).setFromAxisAngle(a.B1.RIGHT,-n)),g=a.B1.FORWARD.clone().applyQuaternion(p);return{position:d.clone().add(g.clone().multiplyScalar(-l)),rotation:p,focalDistance:l}})(e,n.pose.rotation,d,this.canvas.aspectRatio,s);u.position=t.position,u.rotation=t.rotation,m=t.focalDistance;const i=u.position.distanceTo(n.pose.position)<I,o=u.rotation.angleTo(n.pose.rotation)<V;i&&o&&(p=0)}else m=((t,e,i)=>{const s=t.getCenter(new r.Vector3),o=S(t);return M(o,s,e,i)})(this.visibleMeshBounds.getVisibleBounds(),n.pose.rotation,u)}return this.cameraModule.moveTo({transitionType:t,pose:u,transitionTime:p,autoOrtho:!0,projection:(0,l.hn)(n.aspect()),focalDistance:m,rotationDuration:.5,cameraData:n})}setDollhouseBounds(){const t=this.meshData.extendedBounds,e=t.min.distanceTo(t.max);this.minDollhouseDistance=Math.min(e/2,this.minDollhouseDistance),this.maxDollhouseDistance=Math.max(e,this.maxDollhouseDistance)}moveCameraToOrthographic(t,e,i,s){const o=s&&s.zoom?s.zoom:this.getDefaultFloorplanZoom(this.meshData.extendedSize),n=(0,l.Ei)(this.canvas.width,this.canvas.height,o,1,void 0,void 0,this._orthoMatrix);this.cameraModule.setBaseProjection(n);const r={easing:P.WD,transitionType:e,pose:s||{},transitionTime:i,projection:n,focalDistance:2};return this.cameraModule.moveTo(r)}getPeekabooDollhousePoseFromFloorplanPose(t,e=!1){let i;if(t&&t.position&&t.rotation&&t.zoom){const s=t.position,o=t.rotation,n=(0,y.xF)(t.zoom),h=this.visibleMeshBounds.computeFocusPoint(new r.Ray(s,a.B1.DOWN));e?i={position:new r.Vector3(s.x,this.meshData.meshCenter.y+n,s.z),rotation:t.rotation.clone(),focalDistance:n}:(i={position:new r.Vector3,rotation:new r.Quaternion,focalDistance:n},M(n,h,o,i))}return i}fixHighPhiPose(t,e){if(e){if((null==e?void 0:e.isPitchFactorOrtho)&&t===o.N3.Dollhouse)return void k.Ay.for(this).warn(`mode: ${o.N3[t]} cannot be reached with specific targetPose because targetPose's pitch is too high. targetPose was ignored`);const i=(0,h.b)(e);if(i.rotation&&i.position&&(0,b.rC)(i.rotation)>O.oO&&t===o.N3.Dollhouse){const[t,e]=this.setPhi(i.position,i.rotation);i.position=i.position.clone().add(e),i.rotation=t}return i}}setPhi(t,e){var i;const s=(0,b.rC)(e),o=(null===(i=this.meshData)||void 0===i?void 0:i.meshCenter.y)||0,n=Math.abs(o-t.y)*Math.tan(Math.abs(O.oO-s)),h=e.clone().multiply((new r.Quaternion).setFromAxisAngle(a.B1.RIGHT,s)).multiply((new r.Quaternion).setFromAxisAngle(a.B1.RIGHT,-O.oO)),l=a.B1.UP.clone().applyQuaternion(h);return l.y=0,l.normalize().multiplyScalar(-n),[h,l]}getDefaultFloorplanZoom(t){const e=Math.max(t.x,t.z),i=Math.min(t.x,t.z),s=this.canvas.aspectRatio,o=Math.max(e,i/s),n=Math.max(i,e/s),r=s<1?o:n;return this.canvas.height/(1.2*r)}}},23870:(t,e,i)=>{"use strict";i.d(e,{A:()=>n});const s=t=>""+t;class o{constructor(t=s){this.mappingFunction=t,this.list=[],this.map=new Map}add(t){const e=this.mappingFunction(t);return!this.map.has(e)&&(this.list.push(t),this.map.set(e,t),!0)}set(t){const e=this.mappingFunction(t);return this.map.has(e)?(this.map.set(e,t),!0):(this.add(t),!0)}count(){return this.list.length}*[Symbol.iterator](){for(const t of this.list)yield t}getByIndex(t){return this.list[t]}get(t){return this.map.get(t)}copyToList(t){return t.push(...this.list),t}clear(){this.list=[],this.map=new Map}mapElements(t){return this.list.map(t)}values(){return this.list.slice()}}const n=o},4330:(t,e,i)=>{"use strict";i.d(e,{b:()=>s,f:()=>o});const s=t=>({position:t.position?t.position.clone():void 0,rotation:t.rotation?t.rotation.clone():void 0,viewmode:t.viewmode?t.viewmode:void 0,sweepID:t.sweepID?t.sweepID:void 0,viewId:t.viewId,zoom:t.zoom?t.zoom:void 0,focalDistance:t.focalDistance?t.focalDistance:void 0,isPitchFactorOrtho:null!=t.isPitchFactorOrtho?t.isPitchFactorOrtho:void 0}),o=(t,e)=>{var i,s,o,n;return Object.assign({position:null===(i=t.camera.position)||void 0===i?void 0:i.clone(),rotation:null===(s=t.camera.rotation)||void 0===s?void 0:s.clone(),zoom:null===(o=t.camera)||void 0===o?void 0:o.zoom,viewmode:t.mode,sweepID:null===(n=t.pano)||void 0===n?void 0:n.uuid,viewId:void 0,focalDistance:void 0,isPitchFactorOrtho:void 0},e)}},3035:(t,e,i)=>{"use strict";async function s(t,e){if(await t.transition.promise,!e.canStartTransition()){const t=new Promise((t=>{const i=e.onChanged((()=>{e.canStartTransition()&&(i.cancel(),t())}))}));await t}}i.d(e,{L:()=>s})},52492:t=>{t.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform float borderSize;uniform float textureSampleScale;uniform samplerCube panoTexture;uniform vec4 borderColor;varying vec2 vUv;const vec4 transparent=vec4(0.,0.,0.,0.);const float PI=3.14159265359;const float HALF_PI=PI/2.;void main(){float fadeDist=0.1;float r=1.;vec2 uv=(vUv*2.)-vec2(1.,1.);float d=length(uv);float p=d*PI-HALF_PI;float y=sin(p);float h=cos(p)*textureSampleScale;vec3 sampleVec=vec3(uv.x*h,y,uv.y*h);vec4 panoColor=textureCube(panoTexture,sampleVec);panoColor.a=clamp(((1.-d)/d)/fadeDist,0.,1.);vec4 outColor=mix(panoColor,transparent,step(1.,d));float isBorder=max(sign(borderSize),0.)*step(1.-borderSize,d)*step(d,1.);gl_FragColor=linearToOutputTexel(mix(outColor,borderColor,isBorder));}"},70694:t=>{t.exports="precision highp float;precision highp int;varying vec2 vUv;void main(){vUv=uv;vec4 projectedPosition=projectionMatrix*viewMatrix*modelMatrix*vec4(position,1.);gl_Position=projectedPosition;}"},50652:t=>{t.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform sampler2D bg;uniform sampler2D mask;varying vec2 vUv;void main(){vec4 existingColor=texture2D(bg,vUv);vec4 maskColor=texture2D(mask,vUv);gl_FragColor=linearToOutputTexel(vec4(existingColor.rgb*maskColor.rgb,maskColor.a));}"},91254:t=>{t.exports="precision highp float;precision highp int;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelMatrix*vec4(position,1.);}"},88140:t=>{t.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}\n#define M_PI  3.14159265359\nuniform samplerCube cubemap;uniform float yaw;varying vec2 vUv;void main(){vec2 uv=vUv;float theta=uv.x*2.*M_PI+yaw;float phi=uv.y*M_PI;vec3 longitude=vec3(sin(theta),1.,-cos(theta));vec3 latitude=vec3(sin(phi),-cos(phi),sin(phi));vec3 dir=longitude*latitude;normalize(dir);gl_FragColor=linearToOutputTexel(vec4(textureCube(cubemap,dir).rgb,1.));}"},16249:t=>{t.exports="precision highp float;precision highp int;varying vec2 vUv;void main(){vUv=vec2(1.-uv.x,uv.y);gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},99515:t=>{t.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform vec3 topColor;uniform vec3 bottomColor;uniform float radius;varying vec3 rayOrigin;varying vec3 rayDirection;\n#define SRGB_TO_LINEAR(c)pow((c),vec3(2.2))\n#define LINEAR_TO_SRGB(c)pow((c),vec3(1./2.2))\n#define USE_DITHER \nfloat gradientNoise(in vec2 uv){const vec3 magic=vec3(0.06711056,0.00583715,52.9829189);return fract(magic.z*fract(dot(uv,magic.xy)));}void main(){vec3 worldPosition=rayIntersectsSphere(vec3(0.,0.,0.),radius,rayOrigin,normalize(rayDirection));float normalizedHeight=(worldPosition.y+radius)/(radius*2.);float ratio=smoothstep(0.,0.5,normalizedHeight);vec3 colorFromGradient=mix(SRGB_TO_LINEAR(bottomColor),SRGB_TO_LINEAR(topColor),ratio);vec3 color=LINEAR_TO_SRGB(colorFromGradient);\n#if defined (USE_DITHER)\ncolor+=(1./255.)*gradientNoise(gl_FragCoord.xy)-(0.5/255.);\n#endif\ngl_FragColor=linearToOutputTexel(vec4(color,1.));}"},91177:t=>{t.exports="precision highp float;precision highp int;varying vec3 rayOrigin;varying vec3 rayDirection;uniform mat4 cameraMatrix;uniform mat4 inverseProjectionMatrix;vec3 unproject(vec3 pos){vec4 v=cameraMatrix*inverseProjectionMatrix*vec4(pos,1.);return vec3(v.xyz/v.w);}void main(){rayOrigin=unproject(vec3(position.xy,-1.));vec3 end=unproject(vec3(position.xy,1.));rayDirection=normalize(end-rayOrigin);gl_Position=vec4(position,1.);}"}}]);